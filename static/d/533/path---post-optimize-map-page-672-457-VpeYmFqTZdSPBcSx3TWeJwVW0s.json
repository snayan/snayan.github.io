{"data":{"avatar":{"childImageSharp":{"fixed":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGAABAAMBAAAAAAAAAAAAAAAAAAIEBQP/xAAWAQEBAQAAAAAAAAAAAAAAAAACAQD/2gAMAwEAAhADEAAAAcSerUQpOzXUqiMAb//EABsQAAMAAgMAAAAAAAAAAAAAAAABAhESAxQh/9oACAEBAAEFAjzJ1VJcZepyU9x0z//EABURAQEAAAAAAAAAAAAAAAAAABEg/9oACAEDAQE/AWP/xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/AR//xAAbEAADAAIDAAAAAAAAAAAAAAAAASEQERIxMv/aAAgBAQAGPwImPUNtcTodiz//xAAcEAACAgMBAQAAAAAAAAAAAAAAAREhMUFRYXH/2gAIAQEAAT8hWbK7l6NWStvasZEW4S7fwfTTAkNzkQZ//9oADAMBAAIAAwAAABAs1wP/xAAXEQEBAQEAAAAAAAAAAAAAAAABABEQ/9oACAEDAQE/EMLbwL//xAAXEQEBAQEAAAAAAAAAAAAAAAABEQAQ/9oACAECAQE/EIzR4rv/xAAfEAEAAwACAQUAAAAAAAAAAAABABEhMUFRYXGBodH/2gAIAQEAAT8QAjVRsF68R3WyhBpEB4otans9oxQXOZRxVfkow9YivuDFJrEfPmaECm2kqIiV2XP/2Q==","width":40,"height":40,"src":"/static/9d156e8486b343189790da372acb0018/987ea/my.jpg","srcSet":"/static/9d156e8486b343189790da372acb0018/987ea/my.jpg 1x,\n/static/9d156e8486b343189790da372acb0018/9c097/my.jpg 1.5x,\n/static/9d156e8486b343189790da372acb0018/bd6c6/my.jpg 2x"}}},"site":{"siteMetadata":{"title":"三羊的小站","author":"三羊","menu":{"search":{"name":"搜索","link":"/search"}}}},"markdownRemark":{"id":"5be07c3d-3f2c-5112-828c-8844459a13f5","excerpt":"背景最近老板来了一个新需求，地理位置组团。其中一个功能点，就是用户可以进入地图页面，查看当前自身位置，且扫描圈内和圈外其他玩家，将玩家头像显示在地图页面上，标明玩家在哪个位置。老板说，在地图上要可以同时显示200个玩家头像，且保证页面流畅；Android…","html":"<h3>背景</h3>\n<p>最近老板来了一个新需求，地理位置组团。其中一个功能点，就是用户可以进入地图页面，查看当前自身位置，且扫描圈内和圈外其他玩家，将玩家头像显示在地图页面上，标明玩家在哪个位置。老板说，在地图上要可以同时显示200个玩家头像，且保证页面流畅；Android6的手机上，在拖拽，缩小放大时，不能出现明显的卡顿，必须保证用户体验。在拖拽，缩小或者放大等改变地图可视范围时，或则停留时间超过60s，需要更新当前地图上的用户头像。</p>\n<h3>思路</h3>\n<p>需求其实不复杂，但是要做到老板的要求，就没那么简单了。android 6的机型，这个应该是几年前的千元机了。这种机型的硬件本来就很差，不用想，在地图上一次性绘制200个头像，肯定会很卡。并且拖拽地图之后，又清空之前已经绘制的200个头像，重新绘制新的200个，这个肯定会使页面出现明显的卡顿。要达到老板的要求，必须仔细的思考一下该怎么做了。</p>\n<h4>分批绘制</h4>\n<p><a href=\"http://www.stevesouders.com/blog/2008/03/20/roundup-on-parallel-connections/\">浏览器对同一个域名的并发请求数量是有上限的</a>，一般不会超过8个，就算一次发送200个图片请求，也是分批返回的。结合这一点，我也可以分批绘制，200个头像，我可以分成40次绘制，每次只绘制5个，上一次的5个绘制完成了，才开始绘制下一批的5个。带着这种想法，就去找PM商量，跟他说明浏览器请求限制和性能上的考虑，能不能不要一次性全部显示，可以慢慢显示出来。PM接受了这种方式，但是要优先显示圈内的头像。</p>\n<p>为了达到可以分批绘制，且圈内的要优先绘制，容易就想到了，<a href=\"https://en.wikipedia.org/wiki/Priority_queue\"><strong>优先级队列</strong></a>，优先级高的先出队列。这里，圈内头像就比圈外的优先级高。每一次从队列里取出5个头像来绘制，直到队列为空。如果同步的循环调用每一批绘制，直到队列为空，那么肯定会使得当前帧执行时间超过16ms，且会超过很长时间，浏览器一直会被阻塞，使得其他用户事件都不得到响应，表现出来就是页面卡死了，这样肯定不行的。利用<a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/EventLoop\">javascript 的event loop</a>，可以将每次绘制5个头像，这样一个功能包装在一个任务里，将200个头像就可以分成40个这样的任务，然后将每个任务分别加入到javascript的执行队列里。这样，可以异步的方式，将头像分批绘制出来，页面也不会出现卡死。</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b438555ca1ecc8afc91a8e4c508a3dcd/2a28c/per_draw.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 44.96402877697842%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAJABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAMEBf/EABYBAQEBAAAAAAAAAAAAAAAAAAEAAv/aAAwDAQACEAMQAAAB7Fs9oJnP/8QAFxABAAMAAAAAAAAAAAAAAAAAARASIP/aAAgBAQABBQJixj//xAAVEQEBAAAAAAAAAAAAAAAAAAAAEf/aAAgBAwEBPwFX/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFhAAAwAAAAAAAAAAAAAAAAAAARAg/9oACAEBAAY/AoC//8QAGxAAAgIDAQAAAAAAAAAAAAAAAAEh4RARMUH/2gAIAQEAAT8habNpJE/S8PWf/9oADAMBAAIAAwAAABAnH//EABcRAAMBAAAAAAAAAAAAAAAAAAABESH/2gAIAQMBAT8QT0o//8QAFxEAAwEAAAAAAAAAAAAAAAAAAAERIf/aAAgBAgEBPxBPIQ//xAAdEAEAAgICAwAAAAAAAAAAAAABACERMUGBobHw/9oACAEBAAE/ELGGsQEV2VE0Nxw1HXXtDX3iPkZ//9k='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"per_draw\"\n        title=\"\"\n        src=\"/static/b438555ca1ecc8afc91a8e4c508a3dcd/c739e/per_draw.jpg\"\n        srcset=\"/static/b438555ca1ecc8afc91a8e4c508a3dcd/8ee9c/per_draw.jpg 148w,\n/static/b438555ca1ecc8afc91a8e4c508a3dcd/ebbe7/per_draw.jpg 295w,\n/static/b438555ca1ecc8afc91a8e4c508a3dcd/c739e/per_draw.jpg 590w,\n/static/b438555ca1ecc8afc91a8e4c508a3dcd/5413e/per_draw.jpg 885w,\n/static/b438555ca1ecc8afc91a8e4c508a3dcd/2a28c/per_draw.jpg 1112w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </span>\n  </a></p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">// 伪代码，</span>\n<span class=\"token comment\">// 将一次绘制5个头像包装成一个任务，放到event loop 里</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">PER_COUNT</span> <span class=\"token operator\">=</span> <span class=\"token number\">5</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">paintMarker</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token keyword\">type</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 优先获取圈内数据</span>\n  <span class=\"token keyword\">const</span> userData <span class=\"token operator\">=</span> <span class=\"token function\">getUserData</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">type</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n \n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>userData<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">type</span> <span class=\"token operator\">===</span> <span class=\"token string\">'nearbyMarker'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 圈内绘制完了，继续绘制圈外的</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>engine<span class=\"token punctuation\">.</span><span class=\"token function\">pushDraw</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">paintMarker</span><span class=\"token punctuation\">(</span><span class=\"token string\">'externalMarker'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  \n  <span class=\"token comment\">// 一次绘制5个</span>\n  <span class=\"token keyword\">let</span> start <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> notAvailable <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span>start <span class=\"token operator\">&lt;</span> <span class=\"token constant\">PER_COUNT</span> <span class=\"token operator\">&amp;&amp;</span> start <span class=\"token operator\">&lt;</span> userData<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> user <span class=\"token operator\">=</span> userData<span class=\"token punctuation\">[</span>start<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 从实例池取出一个</span>\n    <span class=\"token keyword\">const</span> marker <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>pools<span class=\"token punctuation\">.</span><span class=\"token function\">take</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>marker<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      notAvailable <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// 开始绘制头像</span>\n    marker<span class=\"token punctuation\">.</span><span class=\"token function\">draw</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    start <span class=\"token operator\">=</span> start <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  \n  <span class=\"token comment\">// 将下一次绘制任务加入到event loop里</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>notAvailable<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>engine<span class=\"token punctuation\">.</span><span class=\"token function\">pushDraw</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">paintMarker</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  \n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>重复利用</h4>\n<p>对于地图页面，绘制的上限是200个头像。每次改变了地图的范围，比如移动，缩小，放大地图等操作，需要重新请求接口数据，获得当前新的地图可视范围内的玩家头像数据，然后将新的玩家头像绘制出来。由于google map在绘制自定义图形时，需要生成一个google map的OverlayView对象，实现它的onAdd和onDraw方法。如果，我们每次绘制新的头像都新建一个OverlayView对象，势必会增加浏览器的内存使用，且新建OverlayView对象也是需要花费一定时间的。为了高效绘制，且花费尽量少的内存，可以事先创建一个容量为200的OverlayView对象池，在每次改变地图范围操作之后，可以先回收那些不在可视范围内的OverlayView对象，放入池中；然后在绘制新的头像时，直接从池中取一个OverlayView对象使用就可以了，这样，即减少了内存的使用，也减去了每次新建OverlayView对象花费的时间。当池中没有可用OverlayView对象时，说明当前页面已经绘制了200个头像，达到了上限，不需要在绘制其他头像了。</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e58ffab9c300745d46ddfa41d3d92337/c7123/detail_draw.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 124.4186046511628%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAZABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAIBBf/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAHuiLSrJqUtRf/EABsQAAICAwEAAAAAAAAAAAAAAAABAjEQETIh/9oACAEBAAEFAmRxsVIa8VKpcw5P/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAwEBPwEf/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAgEBPwEf/8QAGRAAAwADAAAAAAAAAAAAAAAAAAEQESAh/9oACAEBAAY/AjGrnR3/xAAcEAEBAQEAAgMAAAAAAAAAAAABEQAhEDFxgaH/2gAIAQEAAT8hZJeuXOinhXQH5ye33lSyYqTFmM+sE6V35N6/H//aAAwDAQACAAMAAAAQnMXw/8QAFhEBAQEAAAAAAAAAAAAAAAAAEBEh/9oACAEDAQE/EC7D/8QAFxEBAQEBAAAAAAAAAAAAAAAAEQEQIf/aAAgBAgEBPxDi5JBz/8QAHBABAQEBAAIDAAAAAAAAAAAAAREhABAxQVGh/9oACAEBAAE/EDVBiXgKoWzwyDQyM6ACxZJeQ039PYQqbS3vjUMDHFAA9od+p5n/2Q=='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"detail_draw\"\n        title=\"\"\n        src=\"/static/e58ffab9c300745d46ddfa41d3d92337/c739e/detail_draw.jpg\"\n        srcset=\"/static/e58ffab9c300745d46ddfa41d3d92337/8ee9c/detail_draw.jpg 148w,\n/static/e58ffab9c300745d46ddfa41d3d92337/ebbe7/detail_draw.jpg 295w,\n/static/e58ffab9c300745d46ddfa41d3d92337/c739e/detail_draw.jpg 590w,\n/static/e58ffab9c300745d46ddfa41d3d92337/5413e/detail_draw.jpg 885w,\n/static/e58ffab9c300745d46ddfa41d3d92337/4efde/detail_draw.jpg 1180w,\n/static/e58ffab9c300745d46ddfa41d3d92337/c7123/detail_draw.jpg 1204w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </span>\n  </a></p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">// 伪代码</span>\n<span class=\"token comment\">// 初始化pools</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">MAX_COUNT</span> <span class=\"token operator\">=</span> <span class=\"token number\">200</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 初始marker实例池</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>pools <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MarkerPool</span><span class=\"token punctuation\">(</span><span class=\"token constant\">MAX_COUNT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  \n  <span class=\"token comment\">// 监听idle事件</span>\n  google<span class=\"token punctuation\">.</span>maps<span class=\"token punctuation\">.</span>event<span class=\"token punctuation\">.</span><span class=\"token function\">addListener</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>map<span class=\"token punctuation\">,</span><span class=\"token string\">'idle'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>isIdle <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 回收可视区域外的marker</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">reclaimMarker</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 设置定时刷新数据</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">initRefreshTimer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 请求用户数据</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">fetchUserData</span><span class=\"token punctuation\">(</span><span class=\"token string\">'nearbyMarker'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> users<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>idle时机执行</h4>\n<p>为了保证在操作地图的时候有最好的流畅度，比图拖拽，缩小，放大等，我们不做任何事情，即不绘制头像，也不请求数据，就仅仅让google map自己改变地图。当google map状态是 idle时，我们再去做绘制头像或者更新数据等。google map提供了idle事件，我们只需要监听这个事件就可以了。</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c0a013342c6a0c005ea773bfda91ae29/31693/idle.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 91.64420485175204%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAASABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAQDBf/EABUBAQEAAAAAAAAAAAAAAAAAAAEA/9oADAMBAAIQAxAAAAHu57TxQJSCVgf/xAAZEAADAAMAAAAAAAAAAAAAAAAAEBEhQkP/2gAIAQEAAQUCpuuimT//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAEDAQE/AR//xAAVEQEBAAAAAAAAAAAAAAAAAAAQAf/aAAgBAgEBPwEh/8QAGRAAAQUAAAAAAAAAAAAAAAAAMQABECDh/9oACAEBAAY/Agg87X//xAAbEAEAAQUBAAAAAAAAAAAAAAAREAABITFRgf/aAAgBAQABPyFI683WTaYzLLH/2gAMAwEAAgADAAAAED/IPP/EABYRAQEBAAAAAAAAAAAAAAAAABABcf/aAAgBAwEBPxDSn//EABURAQEAAAAAAAAAAAAAAAAAADEg/9oACAECAQE/EEh//8QAHRAAAgEEAwAAAAAAAAAAAAAAARExABAhkUFRgf/aAAgBAQABPxAzwO3SKjOD4tXSAy3DVz6kLM2//9k='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"idle\"\n        title=\"\"\n        src=\"/static/c0a013342c6a0c005ea773bfda91ae29/c739e/idle.jpg\"\n        srcset=\"/static/c0a013342c6a0c005ea773bfda91ae29/8ee9c/idle.jpg 148w,\n/static/c0a013342c6a0c005ea773bfda91ae29/ebbe7/idle.jpg 295w,\n/static/c0a013342c6a0c005ea773bfda91ae29/c739e/idle.jpg 590w,\n/static/c0a013342c6a0c005ea773bfda91ae29/31693/idle.jpg 742w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </span>\n  </a></p>\n<p>更新数据，就是把接口请求来的数据，先做一些清洗工作，然后把合格的数据更新到待绘制头像队列里；可以把它的优先级降到最低，只有当前绘制头像队列为空时，才去执行更新数据任务。它的执行时间基本是固定可预估的，不会特别延误到当前帧的绘制，可以把它放在<a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Window/requestIdleCallback\">requestIdleCallback</a>队列里去，通过增加一个超时执行时间内，只有当浏览器是idle时或者超过了某一个时间，才会去执行。</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ad25cc38f9c9b946ffd2dd5ecb2f030f/751b3/detail_update.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 145.89743589743588%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAdABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAwACBf/EABYBAQEBAAAAAAAAAAAAAAAAAAABAv/aAAwDAQACEAMQAAAB74qcLZqjYcmq0//EABoQAAIDAQEAAAAAAAAAAAAAAAABEBESQiH/2gAIAQEAAQUCOxq4So0r7j3R/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAwEBPwEf/8QAFREBAQAAAAAAAAAAAAAAAAAAERD/2gAIAQIBAT8BIk//xAAaEAACAgMAAAAAAAAAAAAAAAAQMQABAhIh/9oACAEBAAY/AorOvS8ix//EAB8QAAEDAwUAAAAAAAAAAAAAABEAAVEQIUExcYGRwf/aAAgBAQABPyFF4u9qAAvwi3oggXWgv0g0yMVOIIFP/9oADAMBAAIAAwAAABDH0/z/xAAWEQEBAQAAAAAAAAAAAAAAAAABEBH/2gAIAQMBAT8QHIGz/8QAFxEBAQEBAAAAAAAAAAAAAAAAARARMf/aAAgBAgEBPxB1FdT/xAAfEAEBAAEEAgMAAAAAAAAAAAABEQAQITFhUXGRscH/2gAIAQEAAT8QWFcZDgW/hgiCcOFcHamTfP2+8CJPbcER3HafOXLvC7nUnfInTfen/9k='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"detail_update\"\n        title=\"\"\n        src=\"/static/ad25cc38f9c9b946ffd2dd5ecb2f030f/c739e/detail_update.jpg\"\n        srcset=\"/static/ad25cc38f9c9b946ffd2dd5ecb2f030f/8ee9c/detail_update.jpg 148w,\n/static/ad25cc38f9c9b946ffd2dd5ecb2f030f/ebbe7/detail_update.jpg 295w,\n/static/ad25cc38f9c9b946ffd2dd5ecb2f030f/c739e/detail_update.jpg 590w,\n/static/ad25cc38f9c9b946ffd2dd5ecb2f030f/751b3/detail_update.jpg 780w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </span>\n  </a></p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">// 伪代码</span>\n<span class=\"token comment\">// 将更新数据操作放入到requestIdleCallback</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">fetchUserData</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token keyword\">type</span><span class=\"token punctuation\">,</span> userData<span class=\"token punctuation\">,</span> fromStart <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 加入到待绘制数组中</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>users<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">patchUserData</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>users<span class=\"token punctuation\">,</span> <span class=\"token keyword\">type</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">const</span> nextType<span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// ... //</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">fetchUserDataApi</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>myLocation<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>mapBounds<span class=\"token punctuation\">,</span> fromStart<span class=\"token punctuation\">,</span> nextType<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>engine<span class=\"token punctuation\">.</span><span class=\"token function\">pushRequest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">fetchUserData</span><span class=\"token punctuation\">(</span>nextType<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>优化</h3>\n<p>浏览器的理想帧率是60fps，如果一直稳定在60fps左右，那么将是非常流畅的。对于Android 6这样的机型，肯定是达不到60fps的，只能尽可能提高它的帧率，让它能稳定在30fps左右，基本上就可以达到要求了。对于一些细节的优化，特别是要避免layout reflow的情况，同样严重影响页面流畅度。下面的performance分析，我都是将CPU降低6倍，且绘制了200个头像，拖动地图页面得到的。</p>\n<h4>避免设置zIndex</h4>\n<p>刚开始，给每个OverlayView都设置了<code class=\"language-text\">zIndex = &#39;50&#39;</code>，当前用户的OverlayView设置了<code class=\"language-text\">zIndex = &#39;80&#39;</code>，这样当前用户总是显示在最上层。这样更改头像样式能达到设计稿的视觉效果，但是这将造成页面非常卡顿，具体我们通过chrome performance调试得到结果。</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/caedc5a5861a39089cee2a4aa3c68cee/b44bf/1.1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 52.51215559157212%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAACR0lEQVQoz52SS2/aUBBG/f+33aZSpUqR2kUX3bSKkqoNIbEJGEOCMQYb29i8wQ/AGENyOkmzybZXOtKnuZ9m7twZxXGGuK5LEATMZjMWiyVZlv0jToSYTZKQrFaMRyG+eBfTqcRikiQVkncofk/HcfvYvS6dToter8PANrGsDk7tmp6hYrc0+sYtnqli6XfYEusLgXiiaEw4GhGGIZ7noTx0Khhmjfu2imrcoYmxJlSbKvfqb7S7K2raL1TtkpvGBdqLVq9QJa43KrSsNkbXoGk2JY+B0ugOUB9swaLWkZdKleHIwwt9QbQvX/KGNw4ZBqI9l6Hn4Ih2fPeVgWANeijao0XVdGg4IffDCctc/u50IC73zDcZaRmzO2VsTzvypz2bpwOZsOXEushJjyXb54KCHctkKS0P2/TCHmr3knV4S+RUceufcBuf8fRzHvUAO5wRzFx09440uiYbV5jZ35mY35haXxh3NFrmFH14j5LmB5L8yESmG5gDabGGVv9Ae3BO3/8qRTxSmWw2nTBfr+nX63hdnXrzDP3hjI79kTCqss4g2+9RihPshc0WllMI84KbfkS9bWJqKrtwSL4rpW3Y5jDyIZo9Y4wWVKyQmh/jrjKKIxQlKJFUH/sBnuxgNIkIG1Wii58Efyr4ZkC83ROnG2LZuRfWspurVcJ8smYSrBj118xEJ2n2eq8EgwETmdrWrLO9/UFhGxzzDVKM41NJeSiEA2X5nqMM43gqOYnnRb96BCWdT0nHI/C7kuElzdt5fuZ/zl+BjiZcSs9QugAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"image-20190414171827226\"\n        title=\"\"\n        src=\"/static/caedc5a5861a39089cee2a4aa3c68cee/b9e4f/1.1.png\"\n        srcset=\"/static/caedc5a5861a39089cee2a4aa3c68cee/cf440/1.1.png 148w,\n/static/caedc5a5861a39089cee2a4aa3c68cee/d2d38/1.1.png 295w,\n/static/caedc5a5861a39089cee2a4aa3c68cee/b9e4f/1.1.png 590w,\n/static/caedc5a5861a39089cee2a4aa3c68cee/f9b6a/1.1.png 885w,\n/static/caedc5a5861a39089cee2a4aa3c68cee/2d849/1.1.png 1180w,\n/static/caedc5a5861a39089cee2a4aa3c68cee/b44bf/1.1.png 2468w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </span>\n  </a></p>\n<p>页面的帧率平均是8fps，也就是绘制一帧需要花费平均122ms左右。先不看其他影响帧率的地方，就看看Composite Layers步骤，它就花费了17.56ms。理想60fps的情况下，一帧的绘制总共才花费16.67ms左右。显然，我们的Composite Layers步骤严重影响性能。Composite Layers 是浏览器一帧绘制工作中的最后一个步骤，合成层。每当设置新的zIndex值，都将会创建新的layer，同一个zIndex的值的元素，最后会被绘制在同一个layer中，具体可以查看<a href=\"https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Positioning/Understanding_z_index/Adding_z-index\">使用 zIndex</a>。去掉zIndex，我们再来看看结果。</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a0ffe763d768a65a97bff83d46197f9e/8559b/1.2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 50.526315789473685%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAACIElEQVQoz6WSW2/TQBCF/f+feOSFJ1DLA68ICi0S0Ca4aZKmtuvY8S22Y8fOzbfYSUD6mEbiF7DS0czZnV3tnDNKvFjgeb7AI44X5HnOZrulqiqqUlCUVHVDLchWa6I4IV1mlHJeVjVFWQoKiqIQXqIkoTzkW6TJEt+bMbWeJdq4jo1vS27quMYITxuQeE+knobzNCKQvcS1SaKINF3K/ZQwDFE0Q2Wi36FbOoPJL26HPUZPKoPHe4GK+jjkofeFwd0VffWKXv8z6u0193fXaA8/0I0xmmWc74/1McoscPDiuSBgNncwnSnmy099B8uX6FkSHWzBLJkzjXxmgYslNZZ0YnrOufalzrANlGCREWUhzWlPVpcEmfBVxGIdk+w2hHlGWqTUvxuKw55NI/oeRa9Tx6aTvW5LeSxZ70u2hwOKdX+BbQfo/oBQe48/eI2j6zjxjLn+Dnd4iWsF+KFBNv9JbGvMlyX54obU+ESU1mxLMWnRJzfeovQmH6i6Tlw9YT3f0Ju8YVnl1B1o/Usm319RyyTE8Zqe8Y2JO2Jb/RHTxkzMj9QtFE1HaFsMtQuUvhudx2CZFJhpTj/wiETHYjjAVvuYom/VndhuWuxlSrBbs2+PJKsaW0asalp2ZUu+2mOtViiuaTCfmtKOS+WZNOpXWl2l265oj0cOokvX7um6lqPkB+mmFX544ee8PZ/940opzuViRFPskOGCWuJ/rL/jl9vY+k2vswAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"image-20190414180429504\"\n        title=\"\"\n        src=\"/static/a0ffe763d768a65a97bff83d46197f9e/b9e4f/1.2.png\"\n        srcset=\"/static/a0ffe763d768a65a97bff83d46197f9e/cf440/1.2.png 148w,\n/static/a0ffe763d768a65a97bff83d46197f9e/d2d38/1.2.png 295w,\n/static/a0ffe763d768a65a97bff83d46197f9e/b9e4f/1.2.png 590w,\n/static/a0ffe763d768a65a97bff83d46197f9e/f9b6a/1.2.png 885w,\n/static/a0ffe763d768a65a97bff83d46197f9e/2d849/1.2.png 1180w,\n/static/a0ffe763d768a65a97bff83d46197f9e/8559b/1.2.png 2470w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </span>\n  </a></p>\n<p>去掉了zIndex之后，现在页面的帧率平均是10fps，绘制一帧需要花费的平均时间是100ms了。在Composite Layers阶段花费的时间基本是9ms左右了。显然是有所提升的。</p>\n<h4>避免在onDraw里访问offsetWidth等触发reflow</h4>\n<p>由于在拖拽地图时，google map会不停的调用我们实现的onDraw方法。在onDraw方法里，可以随意设置当前OverlayView对象的样式和位置。未优化之前，是根据当前容器div的宽高和当前经纬度换算出来的坐标计算得到当前OverlayView对象的left和top。</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">// 部分代码如下</span>\n<span class=\"token comment\">/* 继承 google.maps.OverlayView，实现draw */</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">draw</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> overlayProjection <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>overlayView<span class=\"token punctuation\">.</span><span class=\"token function\">getProjection</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> posPixel <span class=\"token operator\">=</span> overlayProjection<span class=\"token punctuation\">.</span><span class=\"token function\">fromLatLngToDivPixel</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>latLng<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> scale <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">computeScale</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// Resize the image's div to fit the indicated dimensions.</span>\n  <span class=\"token keyword\">const</span> div <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>el<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> x <span class=\"token operator\">=</span> posPixel<span class=\"token punctuation\">.</span>x <span class=\"token operator\">-</span>  div<span class=\"token punctuation\">.</span>offsetWidth <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> y <span class=\"token operator\">=</span> posPixel<span class=\"token punctuation\">.</span>y <span class=\"token operator\">-</span> div<span class=\"token punctuation\">.</span>offsetHeight <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>scale <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n  div<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>transform <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token string\">`scale(</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>scale<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">)`</span></span><span class=\"token punctuation\">;</span>\n  div<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>left <span class=\"token operator\">=</span> x <span class=\"token operator\">+</span> <span class=\"token string\">'px'</span><span class=\"token punctuation\">;</span>\n  div<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>top <span class=\"token operator\">=</span> y <span class=\"token operator\">+</span> <span class=\"token string\">'px'</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/fef55180a0216429d58d11ea272b130b/fc43f/2.2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 63.31168831168832%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAABYlAAAWJQFJUiTwAAACYklEQVQ4y62SWW/bVhCF+f8fiiJO89Zf0ae0aJHUi2zLosVFC1dR3CmSEkVRi5NYX4dKG6TPLYEP58y5M8DF5Si+H+D5HmEYkucFdVXTtju2bSvast1s2InW9Vp6IqIoYi3ZdrsVGhqh9732/UocWKRJSppmBMECx7FYLBzBxfccAlPDt6a4rmBPhKnkFnGckPRzSXaZjaKYYBGgaNoHtMkYfaahGo98fPjI/dM1Q/WWgejD8Imbxzvunvr8lj/l/G54w8gY8WyqaFOdZ5lXzWce1HuUeZgSFCVeWmCJD8sNTlzgpiuWqw2zMMHPK+xkxTzKJKuxoxQ/zVnkki0jmV9hy3MYroOS29esvAHrYECzvGUX31+0DQcXdvEDX9Y6X2qNT9VYvCGq8bnWv/pSu2hfn/Ipynj4A/roR2zzDYvZ1Xe8uRDM37K0fiK03xHZbwmtK9Grb/qPD6XH0n5GMZIZZmYJNnpsXTAS0cxlnDgYqS1ILdljFjGqctSq+BejUrJyiV4sUZr1mqYuMd0b1Pl7xu4HpsmAuf0r02eDIo8pUlmXuc5YHWI7utDrE443whLv+mOqcsW+61COL2eO+0+YusVInaAPhpjvfyE3B+x3smtNRyO08vBtd8Dz1ky0gtlkhWPVF+97G46f4SQo2cKXPcqJ5Q/l138Iv5NPXdIwp5JF31YVTVnSyMJvmh27/Z7ucBD9Su/bbi9nLZvNFiXNCjpjQDf8jS7x2e47ji8vHA57jqcTJ/Hf6OvjkePfnL7Ty5mglFVDvQh5kev+H5+SVTva0yuvZzi/vnI+n/8TfwGYCbl0caqEFwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"image-20190414183610229\"\n        title=\"\"\n        src=\"/static/fef55180a0216429d58d11ea272b130b/b9e4f/2.2.png\"\n        srcset=\"/static/fef55180a0216429d58d11ea272b130b/cf440/2.2.png 148w,\n/static/fef55180a0216429d58d11ea272b130b/d2d38/2.2.png 295w,\n/static/fef55180a0216429d58d11ea272b130b/b9e4f/2.2.png 590w,\n/static/fef55180a0216429d58d11ea272b130b/f9b6a/2.2.png 885w,\n/static/fef55180a0216429d58d11ea272b130b/2d849/2.2.png 1180w,\n/static/fef55180a0216429d58d11ea272b130b/fc43f/2.2.png 2464w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </span>\n  </a></p>\n<p>draw方法中，访问<code class=\"language-text\">div.offsetWidth</code>和 <code class=\"language-text\">div.offsetHeight</code>，强制触发reflow，这将非常影响性能。我们可以优化成，头像显示成固定宽高。例如，<code class=\"language-text\">let x = posPixel.x -  32 / 2;</code>和<code class=\"language-text\">let y = posPixel.y - 32 * (scale + 1) / 2;</code>。</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/19f20940a52192690f04622b0b7cc0c6/be39f/2.3.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 48.41849148418491%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB70lEQVQoz2WSaW/aQBCG/esrtalUqVL7vf+krZKCzeEzBEgA27Be22uvTwhHy9vxEpCqfnj0zOzOXqPVgiBAB+cceZ6jrmtFmqY3hBAoyxJxHKu4qio0TfMf1XoNzQ9CrCkIwzUY26iNU5EiyzLkUkIqCrVRV7febBAniTo8pbGurnOXJ1kOLZj1wDYMi+UcrmfDckd4dMdwHROON4LlDGF7fZiE5RlUQ/OPYwRh97IVXSRQl/GXU0wnNrSh08eQNjGcAXqmgYexjr49gG4PL6ZxwzXIOnoWYeowbAMDWnNhrOjGDJrTmMiQyBxxd+VCKsdXE5xg1Ef+lkf0RK4sFIns1ndOwOIIWshWSPIIccYgZISsoB7KSyzI17hsBYomRdl0Fjdz6h9LM0Qih79m0Lyf7zC5fw9/eAdm3iGyPioYsTE/IHY/oZh/hZx9+ZfpZxTP3/DyJPHk1Ji6NWYTDs1a6hjPe7AXOly/D2fVe6N/y63FL9hk+zrn67BevsPzf2B3Al4J5eNvaLt6B8cZwTPvURaloqI/x/wYz24IETNqh0DINxApB2cMPIqQx/TV+ADN4Q/a1zMaYn86Q9vLknoUIJML7LZH4oQtuW0PaOoDtu0OTdugqDI6aItC1iiKFm1RY1tXoDK0+7NifzzjL4u113zAj4A8AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"image-20190414184005195\"\n        title=\"\"\n        src=\"/static/19f20940a52192690f04622b0b7cc0c6/b9e4f/2.3.png\"\n        srcset=\"/static/19f20940a52192690f04622b0b7cc0c6/cf440/2.3.png 148w,\n/static/19f20940a52192690f04622b0b7cc0c6/d2d38/2.3.png 295w,\n/static/19f20940a52192690f04622b0b7cc0c6/b9e4f/2.3.png 590w,\n/static/19f20940a52192690f04622b0b7cc0c6/f9b6a/2.3.png 885w,\n/static/19f20940a52192690f04622b0b7cc0c6/2d849/2.3.png 1180w,\n/static/19f20940a52192690f04622b0b7cc0c6/be39f/2.3.png 2466w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </span>\n  </a></p>\n<p>可以看到，在draw方法里，现在就没有Layout和Recalculate Style的操作了。现在帧率平均基本是12fps了，绘制一帧需要花费的平均时间是84ms了。又有所提高了。</p>\n<h4>必要降级，去掉不必要的元素</h4>\n<p>对于Android 6等机型，完全没有必要还为每个头像都绘制出一个底部三角形。底部三角形，会额外创建一个div元素，如果是200个头像，页面就会多出了200个元素。并且在拖拽等操作，频繁的调用onDraw，会重新绘制每个头像，也会重新绘制每个底部三角形，这样也增加了绘制所需要的时间。对于android 6 以下等低端机型，可以去掉底部三角形。</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/60152d56ad9c76122b6a1c4c1d81f5d0/10c6a/2.4.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 45.96122778675283%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB8klEQVQozy2SWXPTUAyF/f9/DgzMMMMDbSltoW0Sx07seI33LV5jZynlQwk8aHR0dHRGunOVJE3wPA9/GxDHCUVRUtc1wzDSD3v6fhB8if21F4YReV7Qdf2Vb7tWNL3k7pqVPMtJ4pjEN4i2Dp7virnDrk7p2pwyjwhCD8ezCAIb192IxpYlLKIoIE1SsjQlTTPxSVA0Q0czlqjzryy0R57VZ25eb3lQb1DX97wId/96x8PsO79mtzwKfpzd8fPlTrRP6Bud5VpFN3UW+hzFjnx0x8SS2JiaxBLbM1k6Kzaxi+YZUm+uvGOvse0V1kZj65uYxgLX0TFd0YQOhswpYZgQRluqJCArYrI8Ji8SOSOiEJylMWWVU+3k/CqTpygoyv9Z+KFrqOTNu8PIfhpRvi1+sAoszMVnEtkwMp4IV8+E6yciS7/mwp3RhGt2/pLK12kCjd1WZxdsKIwPVOsvzJ05r6JTsnZiPENWOzT7hrJL2PWyUZ/STgP1IPjKZZRtIjiTkK3bSHo7ltZHDOcT1dBLPaHUwzsHMayno6x9ph4PNNNJzM70UreHo9TSO74JFv7CTRfNgeH4jpqomJWDyDm9gVL1Z8bjH3oR7GVgmCa6i/iCZXgQw3YcKdqKrCxpevmbh3/98Qh2quOX1hWPp9/8BYjalmdEstRJAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"image-20190414190054000\"\n        title=\"\"\n        src=\"/static/60152d56ad9c76122b6a1c4c1d81f5d0/b9e4f/2.4.png\"\n        srcset=\"/static/60152d56ad9c76122b6a1c4c1d81f5d0/cf440/2.4.png 148w,\n/static/60152d56ad9c76122b6a1c4c1d81f5d0/d2d38/2.4.png 295w,\n/static/60152d56ad9c76122b6a1c4c1d81f5d0/b9e4f/2.4.png 590w,\n/static/60152d56ad9c76122b6a1c4c1d81f5d0/f9b6a/2.4.png 885w,\n/static/60152d56ad9c76122b6a1c4c1d81f5d0/2d849/2.4.png 1180w,\n/static/60152d56ad9c76122b6a1c4c1d81f5d0/10c6a/2.4.png 2476w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </span>\n  </a></p>\n<p> 现在页面的帧率平均可以达到了15fps，绘制一帧需要花费的平均时间是68ms了。</p>\n<p>在优化这些小细节之后，在CPU降低到6倍慢，且页面绘制200个头像时，帧率从之前的8fps提高了15fps，足足提升了一倍的性能。对于Android 6 等极端机型，其实还可以再降级，从200个头像减少到100个。</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d5fface1aa7812cf410f556664551183/d7b06/2.5.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 45.809601301871446%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB+klEQVQozz2SSXPTQBSE9f//CnCDCxVSLghUSLzEjizZWsaSLFnbWLuXmFAfzz5w6Oqu6Z7qN1PPSJKYzSZAbULiOKEoCqqq5nA40vcH2q4X7hn6QbyS7TYmTTPatqPrOpq2Fd3e9JWNLM3JkpAksEnikDAMpMChaXY01ZYwcAgCn03gSulKfBffv7KiyAvSXUqWpuRZxjbaYiwdG9N+wny9Z2GPmZgTHl++M7dHLJ0Rk8VPHqe/GC8eRT/wPP/B0+yB8fw3lmv/h+1aLNdLjJW0KX+J59koZaE8k03k4CQ+61jhqDWehG++f82s8D1LprRx1q/imdj2jKU9YfbygKE8l8h3Kfby9ELGLzLyK/KEsiwodYGuNFWj2VdXlOh9yb4WXZd0hwOZLgkSh5VyMSw7Il58IXz9QbQYEc6/sTVFWzMi8w41/or2RpTelFJN0ZsFe/WM9sfowKK0PhJPP1HEOYP6jFE0J5LihaIOyfc+u9IRHdEMFWFqEqWWTL+mqEKyeoNuM9EBeaWoOi3//wHPv6M7vRPs7jF0f2EnK1AOZ8r+fOP94Y1GAnHVsquPcnaiOr6h+476eLn5euhpRLu1Yjc0HC9/2bYao+wuYtTScBacBLJ7wv35D93xyCCsZQ+704X+IDspfM01kutObyRDLPcHyb9LacU/cUCUC4qnJEoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"image-20190414192024307\"\n        title=\"\"\n        src=\"/static/d5fface1aa7812cf410f556664551183/b9e4f/2.5.png\"\n        srcset=\"/static/d5fface1aa7812cf410f556664551183/cf440/2.5.png 148w,\n/static/d5fface1aa7812cf410f556664551183/d2d38/2.5.png 295w,\n/static/d5fface1aa7812cf410f556664551183/b9e4f/2.5.png 590w,\n/static/d5fface1aa7812cf410f556664551183/f9b6a/2.5.png 885w,\n/static/d5fface1aa7812cf410f556664551183/2d849/2.5.png 1180w,\n/static/d5fface1aa7812cf410f556664551183/d7b06/2.5.png 2458w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </span>\n  </a></p>\n<p> 头像降到100个之后，可以看到现在页面的帧率平均可以达到了27fps，绘制一帧需要花费的平均时间是36ms了。帧率从之前的8fps提高了27fps，足足提升了三倍多的性能。</p>\n<h3>小结</h3>\n<p>前端也可以使用一些基础的数据结构和算法，结合前端的一些知识，可以有比较好的实践。在开始动手编码之前，可以先思考一下，大致的实现思路，是否可以有更优方案。当在低端机型上无法满足性能要求时，要学会与PM沟通，是否可以降级处理。在遇到性能瓶颈时，学会使用工具分析和定位问题。</p>","frontmatter":{"title":"性能优化篇-地图页面","date":"April 13, 2019","tags":["performance","javascript"]}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/post/optimize_map_page/","previous":{"fields":{"slug":"/post/summary_of_2018/"},"frontmatter":{"title":"2018年小结"}},"next":null}}