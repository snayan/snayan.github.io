{"data":{"avatar":{"childImageSharp":{"fixed":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGAABAAMBAAAAAAAAAAAAAAAAAAIEBQP/xAAWAQEBAQAAAAAAAAAAAAAAAAACAQD/2gAMAwEAAhADEAAAAcSerUQpOzXUqiMAb//EABsQAAMAAgMAAAAAAAAAAAAAAAABAhESAxQh/9oACAEBAAEFAjzJ1VJcZepyU9x0z//EABURAQEAAAAAAAAAAAAAAAAAABEg/9oACAEDAQE/AWP/xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/AR//xAAbEAADAAIDAAAAAAAAAAAAAAAAASEQERIxMv/aAAgBAQAGPwImPUNtcTodiz//xAAcEAACAgMBAQAAAAAAAAAAAAAAAREhMUFRYXH/2gAIAQEAAT8hWbK7l6NWStvasZEW4S7fwfTTAkNzkQZ//9oADAMBAAIAAwAAABAs1wP/xAAXEQEBAQEAAAAAAAAAAAAAAAABABEQ/9oACAEDAQE/EMLbwL//xAAXEQEBAQEAAAAAAAAAAAAAAAABEQAQ/9oACAECAQE/EIzR4rv/xAAfEAEAAwACAQUAAAAAAAAAAAABABEhMUFRYXGBodH/2gAIAQEAAT8QAjVRsF68R3WyhBpEB4otans9oxQXOZRxVfkow9YivuDFJrEfPmaECm2kqIiV2XP/2Q==","width":40,"height":40,"src":"/static/9d156e8486b343189790da372acb0018/987ea/my.jpg","srcSet":"/static/9d156e8486b343189790da372acb0018/987ea/my.jpg 1x,\n/static/9d156e8486b343189790da372acb0018/9c097/my.jpg 1.5x,\n/static/9d156e8486b343189790da372acb0018/bd6c6/my.jpg 2x"}}},"site":{"siteMetadata":{"title":"三羊的小站","author":"三羊","postPath":"/post","contentUrl":"https://github.com/snayan/blog-source/tree/master/content/blog","ableZan":true,"menu":{"search":{"name":"搜索","link":"/search"}}}},"markdownRemark":{"id":"c491c1bb-61c7-541a-916b-864165c2d245","excerpt":"还记得我们在第一篇中说过，当前rIC实现版本有一条不足之处，当浏览器切换到其他tab或者后台时，浏览器会出于优化考虑不执行rAF（可查看Background Tabs in Chrome），而 rIC polyfill 的实现依赖rAF的实现，所以rIC也会得不到执行。为了解决这种场景下的问题，React v16.…","html":"<p>还记得我们在<a href=\"/post/2020/react_time-slice_1/#toc-2-4\">第一篇</a>中说过，当前rIC实现版本有一条不足之处，当浏览器切换到其他tab或者后台时，浏览器会出于优化考虑不执行rAF（可查看<a href=\"https://developers.google.com/web/updates/2017/03/background_tabs#requestanimationframe\">Background Tabs in Chrome</a>），而 rIC polyfill 的实现依赖rAF的实现，所以rIC也会得不到执行。</p>\n\n        <h2 id='toc-2-1' >\n          Fallback to setTimeout\n        </h2>\n      \n<p>为了解决这种场景下的问题，React v16.5.0 中使用<code class=\"language-text\">setTimeout</code>来作为兜底，100ms内，如果rAF没有执行，则使用<code class=\"language-text\">setTimeout</code>来触发执行，实现大致如下,</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> animationFrameTimeout <span class=\"token operator\">=</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> rafID<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> timeoutID<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">scheduleAnimationFrameWithFallbackSupport</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">callback</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// schedule rAF and also a setTimeout</span>\n  rafID <span class=\"token operator\">=</span> <span class=\"token function\">requestAnimationFrame</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">timestamp</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// cancel the setTimeout</span>\n    <span class=\"token function\">clearTimeout</span><span class=\"token punctuation\">(</span>timeoutID<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span>timestamp<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  timeoutID <span class=\"token operator\">=</span> <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// cancel the requestAnimationFrame</span>\n    <span class=\"token function\">cancelAnimationFrame</span><span class=\"token punctuation\">(</span>rafID<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> animationFrameTimeout<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>如果浏览器在切换到其他tab或者后台时，限制了rAF的执行，会不会也限制<code class=\"language-text\">setTimeout</code>的执行，rIC会不会也同样本身也会被限制呢？据<a href=\"https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/setTimeout\">MDN上的文档</a>说明，<code class=\"language-text\">setTimeout</code>同样也会被限制，</p>\n<blockquote>\n\n        <h4 id='toc-4-1' >\n          Timeouts in inactive tabs throttled to ≥ 1000ms\n        </h4>\n      \n<p>To reduce the load (and associated battery usage) from background tabs, timeouts are throttled to firing no more often than once per second (1,000 ms) in inactive tabs.</p>\n<p>Firefox implements this behavior since version 5 (see <a href=\"https://bugzilla.mozilla.org/show_bug.cgi?id=633421\">bug 633421</a>, the 1000ms constant can be tweaked through the <code class=\"language-text\">dom.min_background_timeout_value</code> preference). Chrome implements this behavior since version 11 (<a href=\"http://crbug.com/66078\">crbug.com/66078</a>).</p>\n<p>Firefox for Android uses a timeout value of 15 minutes for background tabs since <a href=\"https://bugzilla.mozilla.org/show_bug.cgi?id=736602\">bug 736602</a> in Firefox 14, and background tabs can also be unloaded entirely.</p>\n</blockquote>\n<p>据<a href=\"https://w3c.github.io/requestidlecallback/\">w3c文档说明</a>，rIC同样也可能会被限制</p>\n<blockquote>\n<p>When the user agent determines that the web page is not user visible it can throttle idle periods to reduce the power usage of the device, for example, only triggering an idle period every 10 seconds rather than continuously.</p>\n</blockquote>\n<p>那既然对于inactive tab 这种情况，<code class=\"language-text\">setTimeout</code>，rIC本身都会被限制执行，上面React v16.5.0中 使用<code class=\"language-text\">setTimeout</code>来作为回退就没有什么意义了。如果哪位同学知道还有其他方面的原因，还请联系告诉我。</p>\n\n        <h2 id='toc-2-2' >\n          资料\n        </h2>\n      \n<ol>\n<li><a href=\"https://github.com/facebook/react/pull/13091\">Fall back to ‘setTimeout’ when ‘requestAnimationFrame’ is not called</a></li>\n<li><a href=\"https://developers.google.com/web/updates/2017/03/background_tabs#requestanimationframe\">Background Tabs in Chrome</a></li>\n</ol>","tableOfContents":"<ul><li><a href=\"#toc-2-1\">Fallback to setTimeout</a></li><li><a href=\"#toc-2-2\">资料</a></li></ul>","frontmatter":{"title":"React Time Slice（三） -   requestIdleCallback polyfill","date":"November 15, 2020","tags":["react","time slice"],"zan":null}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/post/2020/react_time-slice_3/","previous":{"fields":{"slug":"/post/2020/react_time-slice_2/"},"frontmatter":{"title":"React Time Slice（二） -   requestIdleCallback polyfill"}},"next":{"fields":{"slug":"/post/2021/summary_of_2019/"},"frontmatter":{"title":"2020年小结"}}}}