{"data":{"avatar":{"childImageSharp":{"fixed":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGAABAAMBAAAAAAAAAAAAAAAAAAIEBQP/xAAWAQEBAQAAAAAAAAAAAAAAAAACAQD/2gAMAwEAAhADEAAAAcSerUQpOzXUqiMAb//EABsQAAMAAgMAAAAAAAAAAAAAAAABAhESAxQh/9oACAEBAAEFAjzJ1VJcZepyU9x0z//EABURAQEAAAAAAAAAAAAAAAAAABEg/9oACAEDAQE/AWP/xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/AR//xAAbEAADAAIDAAAAAAAAAAAAAAAAASEQERIxMv/aAAgBAQAGPwImPUNtcTodiz//xAAcEAACAgMBAQAAAAAAAAAAAAAAAREhMUFRYXH/2gAIAQEAAT8hWbK7l6NWStvasZEW4S7fwfTTAkNzkQZ//9oADAMBAAIAAwAAABAs1wP/xAAXEQEBAQEAAAAAAAAAAAAAAAABABEQ/9oACAEDAQE/EMLbwL//xAAXEQEBAQEAAAAAAAAAAAAAAAABEQAQ/9oACAECAQE/EIzR4rv/xAAfEAEAAwACAQUAAAAAAAAAAAABABEhMUFRYXGBodH/2gAIAQEAAT8QAjVRsF68R3WyhBpEB4otans9oxQXOZRxVfkow9YivuDFJrEfPmaECm2kqIiV2XP/2Q==","width":40,"height":40,"src":"/static/9d156e8486b343189790da372acb0018/987ea/my.jpg","srcSet":"/static/9d156e8486b343189790da372acb0018/987ea/my.jpg 1x,\n/static/9d156e8486b343189790da372acb0018/9c097/my.jpg 1.5x,\n/static/9d156e8486b343189790da372acb0018/bd6c6/my.jpg 2x"}}},"site":{"siteMetadata":{"title":"三羊的小站","author":"三羊","postPath":"/post","contentUrl":"https://github.com/snayan/blog-source/tree/master/content/blog","menu":{"search":{"name":"搜索","link":"/search"}}}},"markdownRemark":{"id":"e4495e36-606c-552a-8bbc-dd14b39882b2","excerpt":"1. Cannot read property ‘catch’ of undefined原因：在调用 play()时，现代浏览器返回的是一个 promise，对于执行失败的，会触发一个 Unhandled Promise Rejection，但是对于低版本的浏览器，调用 play()并不会返回一个 promise…","html":"\n          <h3 id='toc-3-1' >\n            1. Cannot read property 'catch' of undefined\n          </h3>\n        \n<p>原因：在调用 play()时，现代浏览器返回的是一个 promise，对于执行失败的，会触发一个 Unhandled Promise Rejection，但是对于低版本的浏览器，调用 play()并不会返回一个 promise。</p>\n<p>解决：应该在调用 play()时做如下处理，增加对 playPromise 的判断</p>\n<p>参考资料：<a href=\"https://developers.google.com/web/updates/2016/03/play-returns-promise\">HTMLMediaElement.play() Returns a Promise</a></p>\n<pre><code class=\"language-javascript\">var playPromise = document.querySelector(\"video\").play()\n\n// In browsers that don’t yet support this functionality,\n// playPromise won’t be defined.\nif (playPromise !== undefined) {\n  playPromise\n    .then(function() {\n      // Automatic playback started!\n    })\n    .catch(function(error) {\n      // Automatic playback failed.\n      // Show a UI element to let the user manually start playback.\n    })\n}\n</code></pre>\n<!--more-->\n\n          <h3 id='toc-3-2' >\n            2. InvalidStateError: An attempt was made to use an object that is not, or is no longer, usable\n          </h3>\n        \n<p>原因：对于还没有设置 src 的 audio，就直接设置 currentTime 是会触发一个 INVALID_STATE_ERR 异常的。即使是设置 currentTime = 0 也会触发这个异常</p>\n<p>解决：在设置 currentTime 之前，必须先设置 audio 的 src</p>\n<p>参考资料：<a href=\"https://www.w3.org/TR/2011/WD-html5-20110113/video.html#offsets-into-the-media-resource\">Offsets into the media resource</a></p>\n<blockquote>\n<p>media . <code>currentTime</code> [ = value ]</p>\n<p>Returns the <a href=\"https://www.w3.org/TR/2011/WD-html5-20110113/video.html#current-playback-position\">current playback position</a>, in seconds.</p>\n<p>Can be set, to seek to the given time.</p>\n<p>Will throw an <code>INVALID_STATE_ERR</code> exception if there is no selected <a href=\"https://www.w3.org/TR/2011/WD-html5-20110113/video.html#media-resource\">media resource</a>. Will throw an <code>INDEX_SIZE_ERR</code> exception if the given time is not within the ranges to which the user agent can seek.</p>\n</blockquote>\n\n          <h3 id='toc-3-3' >\n            3. NotAllowedError\n          </h3>\n        \n<p>原因：在调用 play()时可能会触发一个 NotAllowedError 的 reject，原因是因为浏览器在某些情况下播放失败，常见场景是，未通过点击的情况下调用 play() ，或者点击事件的回调中是在下一个 tick 里调用的 play，例如在 setTimeout 里调用的 play，再或者新创建了很多个 audio 元素，但是并不是每个 audio 都是通过用户点击来调用的 play()等等。</p>\n\n          <h4 id='toc-4-1' >\n            场景一\n          </h4>\n        \n<p>未通过点击等事件绑定，直接调用 play()，触发 NotAllowedError。解决方法，把调用 play()的部分放在事件回调里，如下代码：</p>\n<pre><code class=\"language-javascript\">playButton.addEventListener(\n  \"click\",\n  () => {\n    audioElem.play()\n  },\n  false\n)\n</code></pre>\n\n          <h4 id='toc-4-2' >\n            场景二\n          </h4>\n        \n<p>在点击事件回调中的下一个 tick 里调用 play()，这种情况的示例代码如下，</p>\n<pre><code class=\"language-javascript\">// 错误代码示例\nplayButton.addEventListener(\n  \"click\",\n  () => {\n    setTimeout(() => {\n      audioElem.play()\n    }, 100)\n  },\n  false\n)\n</code></pre>\n<p>这种情况，某些版本「在 iOS12.0.1 亲测有坑」也会触发 NotAllowedError 异常，应该避免这种情况，可以考虑如下 hack 手段解决</p>\n<pre><code class=\"language-javascript\">// hack\nplayButton.addEventListener(\n  \"click\",\n  () => {\n    audioElem.muted = true\n    let p = audioElem.play()\n    if (p !== undefined) {\n      p.then(() => {\n        audioElem.muted = false\n        audioElem.pause()\n        setTimeout(() => {\n          audioElem.play()\n        }, 100)\n      }).catch(e => {\n        console.log(e)\n      })\n    }\n  },\n  false\n)\n</code></pre>\n\n          <h4 id='toc-4-3' >\n            场景三\n          </h4>\n        \n<p>创建了多个 audio 元素，但是并不是每个 audio 都是通过用户点击来调用的 play()的，这时候某些版本「在 iOS12.0.1 亲测有坑」也会触发 NotAllowedError 异常。对于这种情况，最好的办法就是只创建一个 audio 元素，后面通过改变 src 来播放不同的音乐资源。只要 audio 通过了事件回调里调用过 play，后续都可以直接调用 play 了，而无需再次绑定事件回调里去执行，并且这样也可以避免创建多个 audio 来减少内存使用。</p>\n<pre><code class=\"language-javascript\">playButton.addEventListener(\n  \"click\",\n  () => {\n    audioElem.src = \"https://a.mp3\"\n    audioElem.play()\n  },\n  false\n)\n\n// 后面其他地方，可以改变src来直接play\naudioElem.src = \"https://b.mp3\"\naudioElem.play()\n</code></pre>\n\n          <h3 id='toc-3-4' >\n            4. iOS 中页面隐藏和显示时，播放 audio 行为异常\n          </h3>\n        \n<p>原因：在某些 iOS 版本中「iOS12.0.1 亲测有坑」，当我们监听页面隐藏和显示事件，在隐藏时调用 pause() 暂停，显示时调用 play()恢复播放。当按下 home 键，页面进入系统后台时，pause()正常调用，audio 被正常暂停，但是但再次进入页面，显示事件中调用 play()就会出现异常了，</p>\n<p>第一种异常，如果我们只是单纯的调用<code>audioElem.play()</code>，不会抛出任何错误，但是 audio 实际却没有真正播放，无任何声音；</p>\n<p>第二种异常，如果我们每次在显示事件中执行如下代码中任意一种场景，都会在很多情况下会抛出一个<code>AbortError</code>异常，极少数情况才会正常播放。</p>\n<pre><code class=\"language-javascript\">// 监听页面显示隐藏事件\naddPageVisibilityListener(\n  () => {\n    // 隐藏时暂停\n    audioElem.pause()\n  },\n  () => {\n    // 显示时恢复播放\n\n    // 重新直接赋值src\n    audioElem.src = \"https://b.mp3\"\n    audioElem.play()\n\n    // 或者load\n    // audioElem.load()\n    // audioElem.play()\n  }\n)\n</code></pre>\n<p>解决：这两种异常行为应该都是 iOS 12.0.1 系统本身的 bug。我们可以通过如下 2 中方式来避免这种两种异常的发生，</p>\n<p>方式 1， 显示 load()，并监听 <code>canplaythrough</code>，推荐使用这种方式</p>\n<pre><code class=\"language-javascript\">const playAudio = () => {\n  audioElem1.removeEventListener(\"canplaythrough\", playAudio)\n  let p = audioElem.play()\n  if (p !== undefined) {\n    p.catch(e => {\n      console.log(e)\n    })\n  }\n}\n// 监听页面显示隐藏事件\naddPageVisibilityListener(\n  () => {\n    // 隐藏时暂停\n    audioElem.pause()\n  },\n  () => {\n    // 显示时恢复播放\n    audioElem.load()\n    audioElem.addEventListener(\"canplaythrough\", playAudio)\n  }\n)\n</code></pre>\n<p>方式 2，通过 <code>setTimeout</code> 以及 retry 来 hack 避免这种异常发生</p>\n<pre><code class=\"language-javascript\">let playAudio = (retry: boolean) => {\n  let p = audioElem.play()\n  if (p !== undefined) {\n    p.catch(e => {\n      if (retry) {\n        setTimeout(() => {\n          playAudio(false)\n        }, 0)\n      }\n    })\n  }\n}\n// 监听页面显示隐藏事件\naddPageVisibilityListener(\n  () => {\n    // 隐藏时暂停\n    audioElem.pause()\n  },\n  () => {\n    // 显示时恢复播放\n    setTimeout(() => {\n      playAudio(true)\n    }, 500)\n  }\n)\n</code></pre>","tableOfContents":"<ul><li><a href=\"#toc-3-1\">1. Cannot read property 'catch' of undefined</a><ul><li><a href=\"#toc-4-1\">场景一</a></li><li><a href=\"#toc-4-2\">场景二</a></li><li><a href=\"#toc-4-3\">场景三</a></li></ul></li><li><a href=\"#toc-3-2\">2. InvalidStateError: An attempt was made to use an object that is not, or is no longer, usable</a><ul></ul></li><li><a href=\"#toc-3-3\">3. NotAllowedError</a><ul></ul></li><li><a href=\"#toc-3-4\">4. iOS 中页面隐藏和显示时，播放 audio 行为异常</a><ul></ul></li></ul>","frontmatter":{"title":"HTML5中Audio使用踩坑汇总","date":"December 17, 2018","tags":["h5","audio"]}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/post/resolve_issue_of_using_audio/","previous":{"fields":{"slug":"/post/resolve_vue_style_update_problem/"},"frontmatter":{"title":"看vue源码解决组件style更新问题"}},"next":{"fields":{"slug":"/post/understand_the_details_of_vritual_dom_snabbdom/"},"frontmatter":{"title":"理解virtual dom的实现细节-snabbdom"}}}}