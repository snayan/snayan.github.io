{"data":{"avatar":{"childImageSharp":{"fixed":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGAABAAMBAAAAAAAAAAAAAAAAAAIEBQP/xAAWAQEBAQAAAAAAAAAAAAAAAAACAQD/2gAMAwEAAhADEAAAAcSerUQpOzXUqiMAb//EABsQAAMAAgMAAAAAAAAAAAAAAAABAhESAxQh/9oACAEBAAEFAjzJ1VJcZepyU9x0z//EABURAQEAAAAAAAAAAAAAAAAAABEg/9oACAEDAQE/AWP/xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/AR//xAAbEAADAAIDAAAAAAAAAAAAAAAAASEQERIxMv/aAAgBAQAGPwImPUNtcTodiz//xAAcEAACAgMBAQAAAAAAAAAAAAAAAREhMUFRYXH/2gAIAQEAAT8hWbK7l6NWStvasZEW4S7fwfTTAkNzkQZ//9oADAMBAAIAAwAAABAs1wP/xAAXEQEBAQEAAAAAAAAAAAAAAAABABEQ/9oACAEDAQE/EMLbwL//xAAXEQEBAQEAAAAAAAAAAAAAAAABEQAQ/9oACAECAQE/EIzR4rv/xAAfEAEAAwACAQUAAAAAAAAAAAABABEhMUFRYXGBodH/2gAIAQEAAT8QAjVRsF68R3WyhBpEB4otans9oxQXOZRxVfkow9YivuDFJrEfPmaECm2kqIiV2XP/2Q==","width":40,"height":40,"src":"/static/9d156e8486b343189790da372acb0018/987ea/my.jpg","srcSet":"/static/9d156e8486b343189790da372acb0018/987ea/my.jpg 1x,\n/static/9d156e8486b343189790da372acb0018/9c097/my.jpg 1.5x,\n/static/9d156e8486b343189790da372acb0018/bd6c6/my.jpg 2x"}}},"site":{"siteMetadata":{"title":"三羊的小站","author":"三羊","postPath":"/post","contentUrl":"https://github.com/snayan/blog-source/tree/master/content/blog","menu":{"search":{"name":"搜索","link":"/search"}}}},"markdownRemark":{"id":"3bd46cec-1dfd-5173-95b6-f24ae97d8e10","excerpt":"最近在项目碰到了一个 vue 组件更新导致 style 异常的问题。下面记录一下我自己的解决思路。问题背景由于公司项目业务复杂，就不具体描述了。简单说一下问题，就是项目使用 vue 框架，在一个页面中根据 a 值来显示不同组件，当时显示 A 组件，否则就显示 B 组件。示例代码如下问题描述如上代码，页面加载时，显示 a…","html":"<p>最近在项目碰到了一个 vue 组件更新导致 style 异常的问题。下面记录一下我自己的解决思路。</p>\n\n          <h3 id='toc-3-1' >\n            问题背景\n          </h3>\n        \n<p>由于公司项目业务复杂，就不具体描述了。简单说一下问题，就是项目使用 vue 框架，在一个页面中根据 a 值来显示不同组件，当<code>a = true</code>时显示 A 组件，否则就显示 B 组件。示例代码如下</p>\n<pre><code class=\"language-Vue\">&#x3C;template>\n  &#x3C;div>\n      &#x3C;div v-if=\"a\" :style=\"getBackground('a')\">a组件&#x3C;/div>\n      &#x3C;div v-else :style=\"getBackground('b')\">b组件&#x3C;/div>\n  &#x3C;/div>\n&#x3C;/template>\n\n&#x3C;script>\n    export default {\n        name:'Example',\n        data: {\n            a: false\n        },\n        computed: {\n            getBackground: function(type) {\n                return {\n                    background: `url(https://${type}.png) no-repeat`,\n                    backgroundSize: '100% 100%',\n                }\n            }\n        }\n        mounted() {\n            setTimeout(() => { this.a = true }, 1000)\n        }\n    }\n&#x3C;/script>\n</code></pre>\n\n          <h3 id='toc-3-2' >\n            问题描述\n          </h3>\n        \n<p>如上代码，页面加载时，显示 <em>a 组件</em>，且它的背景样式是设置了<code>backgroundImage</code>和<code>backgroundSize</code>为<code>100% 100%</code>，一秒之后，a 变为<code>false</code>了，这是显示 <em>b 组件</em>，预期之中，它也是应该设置了<code>backgroundImage</code>和<code>backgroundSize</code>为<code>100% 100%</code>，但是呢，在显示 <em>b 组件</em>，它的样式，<code>backgroundSize</code>并不是<code>100% 100%</code>，而是默认的<code>initial</code>，这样导致样式并非我们预期想要的。究竟为什么在显示 <em>b 组件</em> 时，这个<code>backgroundSize</code>不是我们在<code>getBackground</code>中返回的 100%呢？</p>\n<!--more-->\n\n          <h3 id='toc-3-3' >\n            分析问题\n          </h3>\n        \n<p>为什么显示 <em>b 组件</em> 时样式不是我们预期的呢，这里，可以看到 <em>a 组件</em> 和 <em>b 组件</em> 都是 <code>div</code>标签，根据<a href=\"https://vuejs.org/v2/guide/conditional.html#Controlling-Reusable-Elements-with-key\">vue 官方文档描述</a>，它们在更新时会被复用的，就是说只会创建 <em>a 组件</em> 的 div 元素，在更新 b 组件时，会复用 <em>a 组件</em> 创建出来的 div 元素的。并且翻看了<a href=\"https://github.com/vuejs/vue/blob/dev/src/core/vdom/patch.js#L411-L481\">vue 更新组件部分源码</a>，也确实会先判断是否是相同的元素类型，如果是，就只是更新，而不会重新创建。但是，就算是复用，那也不应该把<code>backgroundSize</code>覆盖了<code>initial</code>呀？何况这 2 个组件都设置的<code>backgroundSize</code>是<code>100% 100%</code>。</p>\n<p>接着，我又翻看了<a href=\"https://github.com/vuejs/vue/blob/dev/src/platforms/web/runtime/modules/style.js#L74-L87\">更新 style 部分的源码</a>才发现了原因出在哪。下面贴出 vue 更新 stye 部分的源码如下</p>\n<pre><code class=\"language-javascript\">// 获取待更新vnode的style绑定值\nconst newStyle = getStyle(vnode, true)\n\n// 如果在旧的vnode中且不在新的vnode的style中，则删除\nfor (name in oldStyle) {\n  if (isUndef(newStyle[name])) {\n    setProp(el, name, \"\")\n  }\n}\n// 如果在新的vnode中，且不等于旧的vnode中值，则更新为新的vnode中style值\nfor (name in newStyle) {\n  cur = newStyle[name]\n  if (cur !== oldStyle[name]) {\n    // ie9 setting to null has no effect, must use empty string\n    setProp(el, name, cur == null ? \"\" : cur)\n  }\n}\n</code></pre>\n<p>源码逻辑很简单，就是先删除了在旧的 vnode 中 style 而不在新的 vnode 中 style 的值，接着设置在新的 vnode 中且不等于旧的 vnode 中值的。结合上面我们问题代码，逻辑应该是，</p>\n<ol>\n<li>background 存在 <em>a 组件</em> 和 <em>b 组件</em> 中，但是值不相等，应该被更新，</li>\n<li>backgroundSize 存在 <em>a 组件</em> 和 <em>b 组件</em> 中，值相等，不更新</li>\n</ol>\n<p>这样一来，由于 <em>a 组件</em> 和 <em>b 组件</em> 是复用的同一个 div 元素，我们再来具体看一下 div 元素 style 被更新的过程，</p>\n<ul>\n<li>先是在 <em>a 组件</em> 中，div 被设置的应该是如下样式</li>\n</ul>\n<pre><code class=\"language-scss\">div {\n  background: \"url(https://a.png) no-repeat\",\n  backgroundSize: '100% 100%',\n}\n</code></pre>\n<p>我们知道，只设置<code>background</code>的话，它的<code>backgroundSize</code>默认值是<code>initial</code>，但是后面的<code>backgroundSize</code>会覆盖<code>background</code>中默认值，所以这时没有毛病，显示正常</p>\n<ul>\n<li>接着，更新为 <em>b 组件</em> 了，div 被设置的样式应该如下</li>\n</ul>\n<pre><code class=\"language-scss\">div {\n  //background: \"url(https://a.png) no-repeat\", //a组件中设置样式\n  backgroundSize: '100% 100%', //a组件中设置样式\n  background: \"url(https://b.png) no-repeat\", //b组件中设置样式\n}\n</code></pre>\n<p>这个时候，我们发现，实际上，设置的<code>background</code>会用默认值<code>initial</code>覆盖掉之前 a 组件中设置的<code>backgroundSize</code>的<code>100% 100%</code>，所以这个时候，在显示 <em>b 组件</em> 时，<code>backgroundSize</code>变为了默认值<code>initial</code>。坑爹呀，😢。</p>\n\n          <h3 id='toc-3-4' >\n            解决问题\n          </h3>\n        \n<p>知道问题是出现在组件复用和<code>background</code>设置顺序问题上，那么解决的办法就非常简单了，</p>\n<ol>\n<li>方法一就是给 <em>a 组件</em> 和 <em>b 组件</em> 设置不同的 key，这样就不会复用，也不会出现上面的问题了，但是呢，感觉跟 vue 遵循的复用原则相违背，性能也会有所损失（我们就是要追求极致 😂）。</li>\n<li>方法二就是设置 background 时直接使用<code>backgroundImage</code>而不是<code>background</code>，因为设置<code>background</code>会附带设置了其他一些背景相关的 css 样式值，实际上<code>background</code>是一系列背景样式值的简写，</li>\n</ol>\n<blockquote>\n<p>The property is a <a href=\"https://developer.mozilla.org/en-US/docs/Web/CSS/Shorthand_properties\">shorthand</a> that sets the following properties in a single declaration: <a href=\"https://developer.mozilla.org/en-US/docs/Web/CSS/background-clip\"><code>background-clip</code></a>, <a href=\"https://developer.mozilla.org/en-US/docs/Web/CSS/background-color\"><code>background-color</code></a>, <a href=\"https://developer.mozilla.org/en-US/docs/Web/CSS/background-image\"><code>background-image</code></a>, <a href=\"https://developer.mozilla.org/en-US/docs/Web/CSS/background-origin\"><code>background-origin</code></a>, <a href=\"https://developer.mozilla.org/en-US/docs/Web/CSS/background-position\"><code>background-position</code></a>, <a href=\"https://developer.mozilla.org/en-US/docs/Web/CSS/background-repeat\"><code>background-repeat</code></a>, <a href=\"https://developer.mozilla.org/en-US/docs/Web/CSS/background-size\"><code>background-size</code></a>, and <a href=\"https://developer.mozilla.org/en-US/docs/Web/CSS/background-attachment\"><code>background-attachment</code></a>.</p>\n</blockquote>\n\n          <h3 id='toc-3-5' >\n            总结\n          </h3>\n        \n<p>就业务背景而言，业务上是不可能出现页面内 a 会变化的，也就是说，用户打开页面，那么页面根据 a 来选择显示哪个组件，之后是不会变的。但是就有某种特殊情况下，a 在页面未刷新情况下，变化了，导致更新为显示另一个组件了。自己在做业务需求时，代码逻辑一定要多加严谨，同时要深入理解框架的底层实现原理，才能更好的避免未知 bug。</p>\n<p>就这个 bug 而言，应该有三个基础知识点：</p>\n<ol>\n<li>css 规则中，后面的会覆盖前面的</li>\n<li>background 等实际上是一系列 css 规则的简写</li>\n<li>vue 中组件复用以及高效更新 style 逻辑</li>\n</ol>","tableOfContents":"<ul><li><a href=\"#toc-3-1\">问题背景</a><ul></ul></li><li><a href=\"#toc-3-2\">问题描述</a><ul></ul></li><li><a href=\"#toc-3-3\">分析问题</a><ul></ul></li><li><a href=\"#toc-3-4\">解决问题</a><ul></ul></li><li><a href=\"#toc-3-5\">总结</a><ul></ul></li></ul>","frontmatter":{"title":"看vue源码解决组件style更新问题","date":"December 03, 2018","tags":["vue"]}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/post/resolve_vue_style_update_problem/","previous":{"fields":{"slug":"/post/how_to_detect_collision/"},"frontmatter":{"title":"canvas-核心技术-如何实现碰撞检测"}},"next":{"fields":{"slug":"/post/resolve_issue_of_using_audio/"},"frontmatter":{"title":"HTML5中Audio使用踩坑汇总"}}}}