{"data":{"avatar":{"childImageSharp":{"fixed":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGAABAAMBAAAAAAAAAAAAAAAAAAIEBQP/xAAWAQEBAQAAAAAAAAAAAAAAAAACAQD/2gAMAwEAAhADEAAAAcSerUQpOzXUqiMAb//EABsQAAMAAgMAAAAAAAAAAAAAAAABAhESAxQh/9oACAEBAAEFAjzJ1VJcZepyU9x0z//EABURAQEAAAAAAAAAAAAAAAAAABEg/9oACAEDAQE/AWP/xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/AR//xAAbEAADAAIDAAAAAAAAAAAAAAAAASEQERIxMv/aAAgBAQAGPwImPUNtcTodiz//xAAcEAACAgMBAQAAAAAAAAAAAAAAAREhMUFRYXH/2gAIAQEAAT8hWbK7l6NWStvasZEW4S7fwfTTAkNzkQZ//9oADAMBAAIAAwAAABAs1wP/xAAXEQEBAQEAAAAAAAAAAAAAAAABABEQ/9oACAEDAQE/EMLbwL//xAAXEQEBAQEAAAAAAAAAAAAAAAABEQAQ/9oACAECAQE/EIzR4rv/xAAfEAEAAwACAQUAAAAAAAAAAAABABEhMUFRYXGBodH/2gAIAQEAAT8QAjVRsF68R3WyhBpEB4otans9oxQXOZRxVfkow9YivuDFJrEfPmaECm2kqIiV2XP/2Q==","width":40,"height":40,"src":"/static/9d156e8486b343189790da372acb0018/987ea/my.jpg","srcSet":"/static/9d156e8486b343189790da372acb0018/987ea/my.jpg 1x,\n/static/9d156e8486b343189790da372acb0018/9c097/my.jpg 1.5x,\n/static/9d156e8486b343189790da372acb0018/bd6c6/my.jpg 2x"}}},"site":{"siteMetadata":{"title":"三羊的小站","author":"三羊","postPath":"/post","contentUrl":"https://github.com/snayan/blog-source/tree/master/content/blog","ableZan":true,"menu":{"search":{"name":"搜索","link":"/search"}}}},"markdownRemark":{"id":"e15a49b3-4167-5a56-ab16-d53fa522b359","excerpt":"在上一篇文章中，我们分析和理解了 React v16.0.0 中是如何实现  最基础功能的，以及指出了一些不足之处，其中之一就是没有支持多个 callback 的特性。本篇是 React Time Slice 系列中的第二篇，学习 React 团队是如何为 rIC 支持多个 callback…","html":"<p>在<a href=\"/post/2020/react_time-slice_1/\">上一篇文章</a>中，我们分析和理解了 React v16.0.0 中是如何实现 <code class=\"language-text\">requestIdleCallback</code> 最基础功能的，以及指出了一些不足之处，其中之一就是没有支持多个 callback 的特性。本篇是 React Time Slice 系列中的第二篇，学习 React 团队是如何为 rIC 支持多个 callback 特性。</p>\n<p>先简单回顾一下，在 React v16.0.0 中，它使用 <code class=\"language-text\">requestAnimationFrame</code>和<code class=\"language-text\">postMessage</code>来实现 rIC。使用一个变量<code class=\"language-text\">scheduledRICCallback</code>保存当前 callback，如果多次执行<code class=\"language-text\">rIC(callback)</code>，<code class=\"language-text\">scheduledRICCallback</code>会被更新覆盖。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function-variable function\">rIC</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">callback</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 先是存储callback</span>\n  scheduledRICCallback <span class=\"token operator\">=</span> callback\n\n  <span class=\"token comment\">// 。。。</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token number\">0</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>为了符合 rIC 的规范，支持多个 callback，React 团队先后实现了两个版本，第一个版本是使用队列（queue）+ 哈希表 （hash object）实现，第二个版本是使用双向链表（linked list）实现的。如果你对队列，哈希表，链表等不是很清楚，可以先<a href=\"/post/2019/algorithm_basic_data_structure/\">移步这里</a>了解。</p>\n\n        <h2 id='toc-2-1' >\n          Queue + Hash\n        </h2>\n      \n<p>在 React v16.4.0 中，使用队列保存 callback，使用哈希来标识当前 callback 是否有效，也就是没有被取消。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 有效callback哈希对象</span>\n<span class=\"token keyword\">const</span> registeredCallbackIds <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 待执行callback队列</span>\n<span class=\"token keyword\">const</span> pendingCallbacks <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></code></pre></div>\n<p>为了唯一标识 callback，它会给每一个 callback 都生成了一个 ID，然后哈希表中就保存这个 ID。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function-variable function\">rIC</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">callback<span class=\"token punctuation\">,</span> options</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 先计算出timeout，这里是简化实现，实际实现比这复杂，</span>\n  <span class=\"token keyword\">let</span> timeoutTime <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>options <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token keyword\">typeof</span> options<span class=\"token punctuation\">.</span>timeout <span class=\"token operator\">===</span> <span class=\"token string\">\"number\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    timeoutTime <span class=\"token operator\">=</span> <span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> options<span class=\"token punctuation\">.</span>timeout\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// 为callback计算出唯一ID，</span>\n  <span class=\"token keyword\">const</span> newCallbackId <span class=\"token operator\">=</span> <span class=\"token function\">getCallbackId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> scheduledCallbackConfig <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    scheduledCallback<span class=\"token punctuation\">:</span> callback<span class=\"token punctuation\">,</span>\n    callbackId<span class=\"token punctuation\">:</span> newCallbackId<span class=\"token punctuation\">,</span>\n    timeoutTime<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// 保存到队列里</span>\n  pendingCallbacks<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>scheduledCallbackConfig<span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// id保存到哈希表中</span>\n  registeredCallbackIds<span class=\"token punctuation\">[</span>newCallbackId<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>isAnimationFrameScheduled<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    isAnimationFrameScheduled <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n    <span class=\"token function\">requestAnimationFrameForReact</span><span class=\"token punctuation\">(</span>animationTick<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">//返回id，用于取消</span>\n  <span class=\"token keyword\">return</span> newCallbackId\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>如果调用了<code class=\"language-text\">cancelIdleCallback</code>，则只会删除哈希表中对应的 id，而不会把 callback 从队列中移除。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function-variable function\">cancelRIC</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">callbackId</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">delete</span> registeredCallbackIds<span class=\"token punctuation\">[</span>callbackId<span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>如果当前帧还有很多剩余时间，则顺序从队首取出，依次执行，直到没有剩余时间，</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">idleTick</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 。。。</span>\n  <span class=\"token keyword\">let</span> currentTime <span class=\"token operator\">=</span> <span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token comment\">// Next, as long as we have idle time, try calling more callbacks.</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>frameDeadline <span class=\"token operator\">-</span> currentTime <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> pendingCallbacks<span class=\"token punctuation\">.</span>length <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 先从队首中取一个callback</span>\n    <span class=\"token keyword\">const</span> latestCallbackConfig <span class=\"token operator\">=</span> pendingCallbacks<span class=\"token punctuation\">.</span><span class=\"token function\">shift</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    frameDeadlineObject<span class=\"token punctuation\">.</span>didTimeout <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n    <span class=\"token keyword\">const</span> latestCallback <span class=\"token operator\">=</span> latestCallbackConfig<span class=\"token punctuation\">.</span>scheduledCallback\n    <span class=\"token keyword\">const</span> newCallbackId <span class=\"token operator\">=</span> latestCallbackConfig<span class=\"token punctuation\">.</span>callbackId\n    <span class=\"token comment\">// 执行callback，且从哈希表中删除id</span>\n    <span class=\"token function\">safelyCallScheduledCallback</span><span class=\"token punctuation\">(</span>latestCallback<span class=\"token punctuation\">,</span> newCallbackId<span class=\"token punctuation\">)</span>\n    currentTime <span class=\"token operator\">=</span> <span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// 。。。</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>在真正执行 callback 之前，都会先检查当前 callback 是否已经被取消了，如果已经取消了，它对应的 id 就不会存在哈希表中，</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">safelyCallScheduledCallback</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">callback<span class=\"token punctuation\">,</span> callbackId</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 先检查哈希，如果当前callback被取消了，就不再执行</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>registeredCallbackIds<span class=\"token punctuation\">[</span>callbackId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ignore cancelled callbacks</span>\n    <span class=\"token keyword\">return</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span>frameDeadlineObject<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// Avoid using 'catch' to keep errors easy to debug</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// always clean up the callbackId, even if the callback throws</span>\n    <span class=\"token keyword\">delete</span> registeredCallbackIds<span class=\"token punctuation\">[</span>callbackId<span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>哈希表在这里的主要作用，就是为了把时间复杂度从 O(n)降到 O(1)，如果不使用哈希表，则调用<code class=\"language-text\">cancelIdleCallback</code>时，需要遍历队列来删除对应的 callback。如果考虑极端一点，哈希表在最坏的情况下，时间复杂度也会退回到 O(n)。为了进一步降低时间复杂度，React v16.4.1 中使用链表实现了另外一个版本。</p>\n\n        <h2 id='toc-2-2' >\n          Linked list\n        </h2>\n      \n<p>与 React v16.4.0 版本不同之处是，React v16.4.1 中不再使用队列来保存 callback，而是使用链表，且不会为每个 callback 生成一个唯一 ID。一个链表节点，保存了对应的 callback，timeoutTime，以及前一个节点地址，后一个节点地址。</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">type</span> CallbackConfigType <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  scheduledCallback<span class=\"token punctuation\">:</span> FrameCallbackType\n  timeoutTime<span class=\"token punctuation\">:</span> <span class=\"token builtin\">number</span>\n  nextCallbackConfig<span class=\"token punctuation\">:</span> CallbackConfigType <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span>\n  previousCallbackConfig<span class=\"token punctuation\">:</span> CallbackConfigType <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>使用两个变量，来分别指向链表的头节点和尾部节点，</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 链表头节点</span>\n<span class=\"token keyword\">let</span> headOfPendingCallbacksLinkedList <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n<span class=\"token comment\">// 链表尾部节点</span>\n<span class=\"token keyword\">let</span> tailOfPendingCallbacksLinkedList <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span></code></pre></div>\n<p>在执行<code class=\"language-text\">rIC(callback)</code>时，每次将当前 callback 节点添加到链表尾部，</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function-variable function\">rIC</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">callback<span class=\"token punctuation\">,</span> options</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n\n  <span class=\"token keyword\">const</span> scheduledCallbackConfig <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    scheduledCallback<span class=\"token punctuation\">:</span> callback<span class=\"token punctuation\">,</span>\n    timeoutTime<span class=\"token punctuation\">,</span>\n    previousCallbackConfig<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    nextCallbackConfig<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// 如果链表为空，则当前节点就是链表的头节点和尾部节点</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>headOfPendingCallbacksLinkedList <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Make this callback the head and tail of our list</span>\n    headOfPendingCallbacksLinkedList <span class=\"token operator\">=</span> scheduledCallbackConfig\n    tailOfPendingCallbacksLinkedList <span class=\"token operator\">=</span> scheduledCallbackConfig\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 否则，将当前节点加到链表尾部</span>\n    <span class=\"token comment\">// Add latest callback as the new tail of the list</span>\n    scheduledCallbackConfig<span class=\"token punctuation\">.</span>previousCallbackConfig <span class=\"token operator\">=</span> tailOfPendingCallbacksLinkedList\n    tailOfPendingCallbacksLinkedList<span class=\"token punctuation\">.</span>nextCallbackConfig <span class=\"token operator\">=</span> scheduledCallbackConfig\n    tailOfPendingCallbacksLinkedList <span class=\"token operator\">=</span> scheduledCallbackConfig\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">//返回scheduledCallbackConfig，用于取消</span>\n  <span class=\"token keyword\">return</span> scheduledCallbackConfig\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>需要注意的是，这里 rIC 返回的不是一个<code class=\"language-text\">number</code>类型，而是当前的节点对象。在执行<code class=\"language-text\">cancelIdleCallback</code>时，就会根据这个节点来移除自己。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function-variable function\">cancelRIC</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">callbackConfig</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 获取上一个节点</span>\n  <span class=\"token keyword\">const</span> previousCallbackConfig <span class=\"token operator\">=</span> callbackConfig<span class=\"token punctuation\">.</span>previousCallbackConfig\n  <span class=\"token comment\">// 获取下一个节点</span>\n  <span class=\"token keyword\">const</span> nextCallbackConfig <span class=\"token operator\">=</span> callbackConfig<span class=\"token punctuation\">.</span>nextCallbackConfig\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>previousCallbackConfig<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 更新上一个节点的next值，指向下一个节点，即移除自己</span>\n    previousCallbackConfig<span class=\"token punctuation\">.</span>nextCallbackConfig <span class=\"token operator\">=</span> nextCallbackConfig\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nextCallbackConfig<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 更新下一个节点的prev值，指向上一个节点，即移除自己</span>\n    nextCallbackConfig<span class=\"token punctuation\">.</span>previousCallbackConfig <span class=\"token operator\">=</span> previousCallbackConfig\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// 更新链表头节点</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>headOfPendingCallbacksLinkedList <span class=\"token operator\">===</span> callbackConfig<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    headOfPendingCallbacksLinkedList <span class=\"token operator\">=</span> nextCallbackConfig\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// 更新链表尾部节点</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>tailOfPendingCallbacksLinkedList <span class=\"token operator\">===</span> callbackConfig<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    tailOfPendingCallbacksLinkedList <span class=\"token operator\">=</span> previousCallbackConfig\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>如果当前帧还有剩余时间，则只需要移动头节点，依次执行 callback 即可。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">idleTick</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">event</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 。。。</span>\n  <span class=\"token keyword\">let</span> currentTime <span class=\"token operator\">=</span> <span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token comment\">// Next, as long as we have idle time, try calling more callbacks.</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>\n    frameDeadline <span class=\"token operator\">-</span> currentTime <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span>\n    headOfPendingCallbacksLinkedList <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span>\n  <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> latestCallbackConfig <span class=\"token operator\">=</span> headOfPendingCallbacksLinkedList\n    <span class=\"token comment\">// 移动链表头节点，执行下一个节点</span>\n    headOfPendingCallbacksLinkedList <span class=\"token operator\">=</span> latestCallbackConfig<span class=\"token punctuation\">.</span>nextCallbackConfig\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>headOfPendingCallbacksLinkedList<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      headOfPendingCallbacksLinkedList<span class=\"token punctuation\">.</span>previousCallbackConfig <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n    <span class=\"token punctuation\">}</span>\n    frameDeadlineObject<span class=\"token punctuation\">.</span>didTimeout <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n    <span class=\"token keyword\">const</span> latestCallback <span class=\"token operator\">=</span> latestCallbackConfig<span class=\"token punctuation\">.</span>scheduledCallback\n    <span class=\"token comment\">// 执行callback</span>\n    <span class=\"token function\">latestCallback</span><span class=\"token punctuation\">(</span>frameDeadlineObject<span class=\"token punctuation\">)</span>\n    currentTime <span class=\"token operator\">=</span> <span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// 。。。</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>使用链表的核心之处，在于删除一个节点时，时间复杂度总是为 O(1)，它不会像哈希表那样存在某些场景下回退到 O(n)。当然，它不好的地方就是，删除节点或者移动头指针遍历链表时，会增加垃圾回收工作（GC）。</p>\n\n        <h2 id='toc-2-3' >\n          小结\n        </h2>\n      \n<p>React 团队为了实现 rIC 支持多个 callback，先后实现了两个版本。第一个版本是使用队列和哈希表来实现，第二个版本使用双向链表来实现。之所以考虑使用链表来实现，是因为从哈希表中删除一个数据，时间复杂度在最坏情况下会回退到 O(n)，而从链表中删除一个节点，时间复杂度总是 O(1)。链表也有其缺点，就是会增加 GC。</p>\n\n        <h2 id='toc-2-4' >\n          资料\n        </h2>\n      \n<ol>\n<li><a href=\"https://github.com/facebook/react/pull/12746\">Support multiple callbacks in scheduler</a></li>\n<li><a href=\"https://github.com/facebook/react/pull/12893\">Use linked list instead of queue and map for storing cbs</a></li>\n</ol>","tableOfContents":"<ul><li><a href=\"#toc-2-1\">Queue + Hash</a></li><li><a href=\"#toc-2-2\">Linked list</a></li><li><a href=\"#toc-2-3\">小结</a></li><li><a href=\"#toc-2-4\">资料</a></li></ul>","frontmatter":{"title":"React Time Slice（二） -   requestIdleCallback polyfill","date":"September 16, 2020","tags":["react","time slice"],"zan":null}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/post/2020/react_time-slice_2/","previous":{"fields":{"slug":"/post/2020/react_time-slice_1/"},"frontmatter":{"title":"React Time Slice（-） -   requestIdleCallback polyfill"}},"next":{"fields":{"slug":"/post/2020/react_time-slice_3/"},"frontmatter":{"title":"React Time Slice（三） -   requestIdleCallback polyfill"}}}}