{"data":{"avatar":{"childImageSharp":{"fixed":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGAABAAMBAAAAAAAAAAAAAAAAAAIEBQP/xAAWAQEBAQAAAAAAAAAAAAAAAAACAQD/2gAMAwEAAhADEAAAAcSerUQpOzXUqiMAb//EABsQAAMAAgMAAAAAAAAAAAAAAAABAhESAxQh/9oACAEBAAEFAjzJ1VJcZepyU9x0z//EABURAQEAAAAAAAAAAAAAAAAAABEg/9oACAEDAQE/AWP/xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/AR//xAAbEAADAAIDAAAAAAAAAAAAAAAAASEQERIxMv/aAAgBAQAGPwImPUNtcTodiz//xAAcEAACAgMBAQAAAAAAAAAAAAAAAREhMUFRYXH/2gAIAQEAAT8hWbK7l6NWStvasZEW4S7fwfTTAkNzkQZ//9oADAMBAAIAAwAAABAs1wP/xAAXEQEBAQEAAAAAAAAAAAAAAAABABEQ/9oACAEDAQE/EMLbwL//xAAXEQEBAQEAAAAAAAAAAAAAAAABEQAQ/9oACAECAQE/EIzR4rv/xAAfEAEAAwACAQUAAAAAAAAAAAABABEhMUFRYXGBodH/2gAIAQEAAT8QAjVRsF68R3WyhBpEB4otans9oxQXOZRxVfkow9YivuDFJrEfPmaECm2kqIiV2XP/2Q==","width":40,"height":40,"src":"/static/9d156e8486b343189790da372acb0018/987ea/my.jpg","srcSet":"/static/9d156e8486b343189790da372acb0018/987ea/my.jpg 1x,\n/static/9d156e8486b343189790da372acb0018/9c097/my.jpg 1.5x,\n/static/9d156e8486b343189790da372acb0018/bd6c6/my.jpg 2x"}}},"site":{"siteMetadata":{"title":"三羊的小站","author":"三羊","postPath":"/post","contentUrl":"https://github.com/snayan/blog-source/tree/master/content/blog","menu":{"search":{"name":"搜索","link":"/search"}}}},"markdownRemark":{"id":"846c1ca7-ad92-5c93-a7c3-cb1252b71f52","excerpt":"Babel，是一个 JavaScript 的编译工具，它可以将 es6+语法的代码，转换为浏览器兼容的低版本的代码。它简直就是一个神兵利器，前端工程师拥有了它，就可以在项目中使用一些较新的 es 语法。笔者决定弄懂它，并实现一个自己的 Babel 插件。Babel…","html":"<p>Babel，是一个 JavaScript 的编译工具，它可以将 es6+语法的代码，转换为浏览器兼容的低版本的代码。它简直就是一个神兵利器，前端工程师拥有了它，就可以在项目中使用一些较新的 es 语法。笔者决定弄懂它，并实现一个自己的 Babel 插件。</p>\n<p>Babel 的工作原理，可以用如下公式表述。它实际上就是接受输入的源代码，然后对它做一些处理和转换，最后输出为目标版本的代码。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">babel</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">sourceCode</span> <span class=\"token operator\">=></span> distCode</code></pre></div>\n<p>在将输入的源码做处理或者转换时，这就需要用到了它的插件系统。一个插件只负责处理一件事，比如<code class=\"language-text\">@babel/plugin-transform-arrow-functions</code> ，就是负责将箭头函数转换为普通函数的插件。Babel 提供了非常多的插件，这样就足以保证可以将新的 es 语法转换为旧版本的代码形式。想了解详细的 Babel 插件系统，可以查看<a href=\"https://babeljs.io/docs/en/plugins\">Babel#Plugins</a>。</p>\n<p>如果不配置任何的插件，Babel 将不会对源码做任何的处理，它只会照原样输出。下面举个例子，</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> babel <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"@babel/core\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> code <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token string\">`\n  const a = () => {\n    console.log(1);\n  }\n`</span></span>\n\n<span class=\"token comment\">// 没有配置任何plugin，那么转换之后的code将没有任何变化</span>\nbabel<span class=\"token punctuation\">.</span><span class=\"token function\">transform</span><span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">,</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err<span class=\"token punctuation\">,</span> result</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">throw</span> err\n  <span class=\"token punctuation\">}</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">.</span>code<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>我们将箭头函数使用 Babel 来转换，但是没有配置任何的插件，最后转换之后的结果将和输入的代码一摸一样。</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">➜  babel node scripts/index.ts\nconst a <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n  console.log<span class=\"token punctuation\">(</span>1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>如果配置了<code class=\"language-text\">@babel/plugin-transform-arrow-functions</code>，Babel 就能正常将我们的箭头函数转换为普通函数的形式了。如下，</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// 配置@babel/plugin-transform-arrow-functions</span>\nbabel<span class=\"token punctuation\">.</span><span class=\"token function\">transform</span><span class=\"token punctuation\">(</span>\n  code<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> plugins<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"@babel/plugin-transform-arrow-functions\"</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">(</span><span class=\"token parameter\">err<span class=\"token punctuation\">,</span> result</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">throw</span> err\n    <span class=\"token punctuation\">}</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">.</span>code<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>转换之后的代码如下，</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">➜  babel node scripts/index.ts\nconst a <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console.log<span class=\"token punctuation\">(</span>1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>对于其他的语法形式的转换，可以添加其他的插件。如果仅仅这样，对于一个实际项目代码的转换，将要配置非常多的插件。为了简化这种形式，Babel 又提供了 Presets，简单的说，就是将很多个插件集合重新命名为一个新名称。这样，只需要配置了这个 Presets，那么就相对于配置它所包含的所有的插件。Babel 定义了常用的 Presets，详细可以查看<a href=\"https://babeljs.io/docs/en/presets\">Babel#Presets</a>。</p>\n<p>通过加入插件处理的方式，Babel 将会有非常好的可扩展性和可插拔性，比如 esNext 中又添加了一个新的语法糖，那么 Babel 只需要单独提供这个新语法处理的插件，并将它配置进去就可以了。对于前端工程师们，也可以根据实际业务需求，写自己的插件，将输入的源码处理成自己想要的输出。</p>\n<p>为了能写出自己的 Babel 插件，我们就需要知道 Babel 将输入的代码转换成什么样子，插件接受的参数又是什么样子，最后需要返回的值是什么样子。</p>\n<h3>AST</h3>\n<p>Babel 会将输入的源代码先转换成 AST(Abstract Syntax Tree)，然后将 AST 作为参数传给插件，插件将在 AST 上做处理，可以添加，删除或者改变节点。例如，我们上面例子中箭头函数 a，生成的 AST 大致结构如下,</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">  <span class=\"token string\">\"program\"</span><span class=\"token keyword\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"type\"</span><span class=\"token keyword\">:</span> <span class=\"token string\">\"Program\"</span>,\n    <span class=\"token string\">\"body\"</span><span class=\"token keyword\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"type\"</span><span class=\"token keyword\">:</span> <span class=\"token string\">\"VariableDeclaration\"</span>,\n        <span class=\"token string\">\"declarations\"</span><span class=\"token keyword\">:</span> <span class=\"token punctuation\">[</span>\n          <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"type\"</span><span class=\"token keyword\">:</span> <span class=\"token string\">\"VariableDeclarator\"</span>,\n            <span class=\"token string\">\"id\"</span><span class=\"token keyword\">:</span> <span class=\"token punctuation\">{</span>\n              <span class=\"token string\">\"type\"</span><span class=\"token keyword\">:</span> <span class=\"token string\">\"Identifier\"</span>,\n              <span class=\"token string\">\"name\"</span><span class=\"token keyword\">:</span> <span class=\"token string\">\"a\"</span>\n            <span class=\"token punctuation\">}</span>,\n            <span class=\"token string\">\"init\"</span><span class=\"token keyword\">:</span> <span class=\"token punctuation\">{</span>\n              <span class=\"token string\">\"type\"</span><span class=\"token keyword\">:</span> <span class=\"token string\">\"ArrowFunctionExpression\"</span>,\n              <span class=\"token string\">\"params\"</span><span class=\"token keyword\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>,\n              <span class=\"token string\">\"body\"</span><span class=\"token keyword\">:</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token string\">\"type\"</span><span class=\"token keyword\">:</span> <span class=\"token string\">\"BlockStatement\"</span>,\n                <span class=\"token string\">\"body\"</span><span class=\"token keyword\">:</span> <span class=\"token punctuation\">[</span>\n                  <span class=\"token punctuation\">{</span> ↔ <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">]</span>,\n              <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">]</span>,\n        <span class=\"token string\">\"kind\"</span><span class=\"token keyword\">:</span> <span class=\"token string\">\"const\"</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span>,\n  <span class=\"token punctuation\">}</span>,</code></pre></div>\n<p>AST 可以看成一棵树，它包含了很多的节点，每个节点都会包含一个 type 字段，这个 type 字段就是用来表明当前节点的类型，比如上面的<code class=\"language-text\">Identifier</code>表明是标识符，<code class=\"language-text\">ArrowFunctionExpression</code>表明是箭头函数表达式。想详细了解 AST 结构，可以查看<a href=\"https://astexplorer.net/\">astexplorer</a>。</p>\n<p>要处理 AST 树，就得遍历这颗树，找到我们要处理的节点位置。对于一棵树的遍历，有 DFS(深度优先搜索)和 BFS(广度优先搜索)两种方式。对于 AST 的遍历，使用的是 DFS 方式。Babel 提供了<code class=\"language-text\">@babel/traverse</code>来遍历它，可以很方便的找到需要处理的节点位置。例如上面的例子，我们可以像下面这样找到<code class=\"language-text\">console.log(1)</code>中<code class=\"language-text\">1</code>这个节点位置，</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> babel <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"@babel/core\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> traverse <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"@babel/traverse\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> code <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token string\">`\n  const a = () => {\n    console.log(1);\n  }\n`</span></span>\n\nbabel<span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err<span class=\"token punctuation\">,</span> ast</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">throw</span> err\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function\">traverse</span><span class=\"token punctuation\">(</span>ast<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">NumericLiteral</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">path</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span>node<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>由于<code class=\"language-text\">console.log(1)</code>接受的参数是一个数字字面量，所以它对应的<code class=\"language-text\">type</code>就是<code class=\"language-text\">NumericLiteral</code>。最后找到这个节点的信息如下，</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">➜  babel node scripts/index.ts\n<span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"type\"</span><span class=\"token keyword\">:</span> <span class=\"token string\">\"NumericLiteral\"</span>,\n    <span class=\"token string\">\"start\"</span><span class=\"token keyword\">:</span> 37,\n    <span class=\"token string\">\"end\"</span><span class=\"token keyword\">:</span> 38,\n    <span class=\"token string\">\"loc\"</span><span class=\"token keyword\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"start\"</span><span class=\"token keyword\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"line\"</span><span class=\"token keyword\">:</span> 3,\n            <span class=\"token string\">\"column\"</span><span class=\"token keyword\">:</span> 16\n        <span class=\"token punctuation\">}</span>,\n        <span class=\"token string\">\"end\"</span><span class=\"token keyword\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"line\"</span><span class=\"token keyword\">:</span> 3,\n            <span class=\"token string\">\"column\"</span><span class=\"token keyword\">:</span> 17\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>,\n    <span class=\"token string\">\"extra\"</span><span class=\"token keyword\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"rawValue\"</span><span class=\"token keyword\">:</span> 1,\n        <span class=\"token string\">\"raw\"</span><span class=\"token keyword\">:</span> <span class=\"token string\">\"1\"</span>\n    <span class=\"token punctuation\">}</span>,\n    <span class=\"token string\">\"value\"</span><span class=\"token keyword\">:</span> 1\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>可以看到，节点包含了 type，loc 信息，以及 value 等信息。更多关于 traverse 的使用，可以查看这里<a href=\"https://babeljs.io/docs/en/babel-traverse\">Babel#traverse</a>。</p>\n<h3>Plugin</h3>\n<p>根据上面的思路，我们可以得出如下结论，</p>\n<blockquote>\n<p>Babel 中插件接受 AST 作为参数，然后可以在 AST 上做一些自定义的处理，最后返回处理之后的 AST。</p>\n</blockquote>\n<p>为了验证这个结论正确性，我们来看看官方的<a href=\"https://github.com/babel/babel/tree/master/packages/babel-plugin-transform-arrow-functions\"><code class=\"language-text\">@babel/plugin-transform-arrow-functions</code></a>的源码，源码只有 28 行代码，我贴出来，并做一些自己的注释，一起看看。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> declare <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"@babel/helper-plugin-utils\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> type NodePath <span class=\"token keyword\">from</span> <span class=\"token string\">\"@babel/traverse\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">function</span> <span class=\"token function\">declare</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>api<span class=\"token punctuation\">,</span> options<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 判断当前Babel版本是否是v7.x</span>\n  api<span class=\"token punctuation\">.</span><span class=\"token function\">assertVersion</span><span class=\"token punctuation\">(</span><span class=\"token number\">7</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// 接受我们传入的参数</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> spec <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> options<span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// 返回一个对象</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    name<span class=\"token punctuation\">:</span> <span class=\"token string\">\"transform-arrow-functions\"</span><span class=\"token punctuation\">,</span>\n\n    visitor<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">ArrowFunctionExpression</span><span class=\"token punctuation\">(</span>\n        <span class=\"token parameter\">path<span class=\"token punctuation\">:</span> NodePath<span class=\"token operator\">&lt;</span>BabelNodeArrowFunctionExpression<span class=\"token operator\">></span><span class=\"token punctuation\">,</span></span>\n      <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 先判断是不是箭头函数表达式，不是就直接返回</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">isArrowFunctionExpression</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// 将箭头函数转为函数表达式</span>\n        path<span class=\"token punctuation\">.</span><span class=\"token function\">arrowFunctionToExpression</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n          allowInsertArrow<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n          specCompliant<span class=\"token punctuation\">:</span> <span class=\"token operator\">!</span><span class=\"token operator\">!</span>spec<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>从源码可以看出，它返回一个<code class=\"language-text\">declare</code>函数。这个函数接受两个参数，一个<code class=\"language-text\">api</code>，一个是<code class=\"language-text\">options</code>。函数处理步骤如下，</p>\n<ol>\n<li>判断是否 Babel v7 的版本</li>\n<li>返回一个对象，包括<code class=\"language-text\">name</code>和<code class=\"language-text\">visitor</code>；其中，<code class=\"language-text\">visitor</code>又是一个对象，它才真正包含对肩头函数表达式的处理。</li>\n</ol>\n<p>实际上，<code class=\"language-text\">path.arrowFunctionToExpression</code> 就是使用<code class=\"language-text\">@babel/types</code>中<code class=\"language-text\">arrowfunctionexpression</code>，详细可以查看<a href=\"https://babeljs.io/docs/en/babel-types#arrowfunctionexpression\">babel-types#arrowfunctionexpression</a>。</p>\n<p>跟我们猜想的 Babel 插件样子有点出入，但是它包含了我们猜想的内容。最后，我们可以总结出写一个 Babel 插件的样子应该是这样的，</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">function</span> <span class=\"token function\">declare</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">api<span class=\"token punctuation\">,</span> options</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// api可以做一些版本兼容性判断，或者缓存相关的。</span>\n  <span class=\"token comment\">// options就是我们配置插件时，传入的参数，这里插件内部就可以使用了</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    name<span class=\"token punctuation\">:</span> <span class=\"token string\">\"my-custorm-plugin\"</span><span class=\"token punctuation\">,</span>\n    visitor<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 遍历AST做处理</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>DIY</h3>\n<p>清楚了 Babel 插件的模版形式，就可以按照这个模版写我们自定义的功能插件。假设，我们要写的一个 Babel 插件，就是去掉所有的<code class=\"language-text\">console.log</code>相关调试信息的代码。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// 源代码</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">a</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>例如上面的代码经过我们的 Babel 插件处理之后，输出的代码应该是一个空的箭头函数 a，</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// 转换之后</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">a</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>根据 Babel 插件模版代码，我们可以这样实现如下，</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// plugins/remove-console-log.js</span>\n<span class=\"token keyword\">const</span> types <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"@babel/types\"</span><span class=\"token punctuation\">)</span>\n\nmodule<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">exports</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">declare</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">api<span class=\"token punctuation\">,</span> options</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  api<span class=\"token punctuation\">.</span><span class=\"token function\">assertVersion</span><span class=\"token punctuation\">(</span><span class=\"token number\">7</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    name<span class=\"token punctuation\">:</span> <span class=\"token string\">\"remove-console-log\"</span><span class=\"token punctuation\">,</span>\n    visitor<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">ExpressionStatement</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">path</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> expression <span class=\"token operator\">=</span> path<span class=\"token punctuation\">.</span>node<span class=\"token punctuation\">.</span>expression\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>types<span class=\"token punctuation\">.</span><span class=\"token function\">isCallExpression</span><span class=\"token punctuation\">(</span>expression<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">const</span> callee <span class=\"token operator\">=</span> expression<span class=\"token punctuation\">.</span>callee\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>types<span class=\"token punctuation\">.</span><span class=\"token function\">isMemberExpression</span><span class=\"token punctuation\">(</span>callee<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">const</span> objName <span class=\"token operator\">=</span> callee<span class=\"token punctuation\">.</span>object<span class=\"token punctuation\">.</span>name\n            <span class=\"token keyword\">const</span> methodName <span class=\"token operator\">=</span> callee<span class=\"token punctuation\">.</span>property<span class=\"token punctuation\">.</span>name\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>objName <span class=\"token operator\">===</span> <span class=\"token string\">\"console\"</span> <span class=\"token operator\">&amp;&amp;</span> methodName <span class=\"token operator\">===</span> <span class=\"token string\">\"log\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n              path<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>然后在 babel.config.js 中配置如下，</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  plugins<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"./plugins/remove-console-log.js\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>最后，我们通过 Babel 转换之后就可以得到我们期望的结果了。</p>\n<h3>小结</h3>\n<p>通过自己实现一个 Babel 插件，然后贯穿整个过程把 Babel 原理弄清楚。上面其实还有一个小知识点，就是 Babel 怎么将源码转换成 AST 的。其实，它的过程也不难理解，只是在转换为 AST 之前，需要先进行词法分析，把源码字符串转换成 Token 数组；然后根据词法分析得到的结果，转换成 AST。完整的 Babel 原理过程可以简单的表述为如下，</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4226719341e4d0193ae3882e3dfc30e6/47573/compiler.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 25.90909090909091%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABJ+AAASfgGFEtSUAAABVUlEQVQY02MQkWIXEpPjVOQTYBRmYGBgBGKG3l3GzAxQ8P+/ByMDfsAsK8cmICHFqsjBwyTCEJzEY/D8v6JG53oFUaAkd2SxDCtI1aaLkh7LryuHgdieAQLsQIop/Ckv+/obSpXzehl4QJY7BPGCLOYtmCyhdeu/jkZEKr8Ug1qAuWLq5yPa7mdPggwU4eFhUAG6i2HKMfeKZRv12hkY5LjYBRmVgHLyMxIMNJYcNt0cu7JIC8gXZGdjBKplkOrwlpd+lWej06qlIcVgZKUot+9kq9zEpgCggSJcIBepb9nqLX701qYz4uqrLmqpBYM9NqOd+b6Y+KKc5IYFolfvL0LyMl9UtKnEtpNtcgEZ7pIMHGwMqs2ZDCw8igxAr7Jxg1SIrjnAqrpshmi2vICCMysnKGzZGZhZuEq4OKSikzwkBHfv4+dBMpBNgFHG+SwDMys7Ax8AKKNPRP1djzMAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    ></span>\n    <picture>\n        <source\n          srcset=\"/static/4226719341e4d0193ae3882e3dfc30e6/cc182/compiler.webp 148w,\n/static/4226719341e4d0193ae3882e3dfc30e6/f7e40/compiler.webp 295w,\n/static/4226719341e4d0193ae3882e3dfc30e6/1a2f4/compiler.webp 590w,\n/static/4226719341e4d0193ae3882e3dfc30e6/628de/compiler.webp 880w\"\n          sizes=\"(max-width: 590px) 100vw, 590px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/4226719341e4d0193ae3882e3dfc30e6/cf440/compiler.png 148w,\n/static/4226719341e4d0193ae3882e3dfc30e6/d2d38/compiler.png 295w,\n/static/4226719341e4d0193ae3882e3dfc30e6/b9e4f/compiler.png 590w,\n/static/4226719341e4d0193ae3882e3dfc30e6/47573/compiler.png 880w\"\n          sizes=\"(max-width: 590px) 100vw, 590px\"\n          type=\"image/png\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n          src=\"/static/4226719341e4d0193ae3882e3dfc30e6/b9e4f/compiler.png\"\n          alt=\"compiler\"\n          title=\"\"\n        />\n      </picture>\n  </span>\n  </a></p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">let</span> tokens <span class=\"token operator\">=</span> <span class=\"token function\">tokenizer</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">)</span> <span class=\"token comment\">// 词法分析</span>\n<span class=\"token keyword\">let</span> ast <span class=\"token operator\">=</span> <span class=\"token function\">parser</span><span class=\"token punctuation\">(</span>tokens<span class=\"token punctuation\">)</span> <span class=\"token comment\">// 转换为AST</span>\n<span class=\"token keyword\">let</span> newAst <span class=\"token operator\">=</span> <span class=\"token function\">transformer</span><span class=\"token punctuation\">(</span>ast<span class=\"token punctuation\">)</span> <span class=\"token comment\">// 调用插件，进行转换</span>\n<span class=\"token keyword\">let</span> output <span class=\"token operator\">=</span> <span class=\"token function\">codeGenerator</span><span class=\"token punctuation\">(</span>newAst<span class=\"token punctuation\">)</span> <span class=\"token comment\">// 最后，生成新的目标代码</span></code></pre></div>\n<p>如果想更加详细研究 Babel 的过程，可以看看这个简易的编译器<a href=\"https://github.com/jamiebuilds/the-super-tiny-compiler\">the-super-tiny-compiler</a>，它实现了完整的流程过程，代码也非常简单易懂。</p>\n<h3>参考</h3>\n<ul>\n<li><a href=\"https://babeljs.io/docs/en/\">babeljs</a></li>\n<li><a href=\"https://github.com/jamiebuilds/babel-handbook\">babel-handbook</a></li>\n<li><a href=\"https://github.com/jamiebuilds/the-super-tiny-compiler\">the-super-tiny-compiler</a></li>\n</ul>","tableOfContents":"<ul>\n<li><a href=\"/post/2019/diy_a_babel_plugin/#ast\">AST</a></li>\n<li><a href=\"/post/2019/diy_a_babel_plugin/#plugin\">Plugin</a></li>\n<li><a href=\"/post/2019/diy_a_babel_plugin/#diy\">DIY</a></li>\n<li><a href=\"/post/2019/diy_a_babel_plugin/#%E5%B0%8F%E7%BB%93\">小结</a></li>\n<li><a href=\"/post/2019/diy_a_babel_plugin/#%E5%8F%82%E8%80%83\">参考</a></li>\n</ul>","frontmatter":{"title":"DIY 一个 Babel 插件","date":"August 06, 2019","tags":["babel"]}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/post/2019/diy_a_babel_plugin/","previous":{"fields":{"slug":"/post/2019/algorithm_skip_list/"},"frontmatter":{"title":"数据结构和算法-跳表的原理及实现"}},"next":{"fields":{"slug":"/post/2019/flutter-learn-1/"},"frontmatter":{"title":"flutter 学习小结（一）"}}}}