{"data":{"avatar":{"childImageSharp":{"fixed":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGAABAAMBAAAAAAAAAAAAAAAAAAIEBQP/xAAWAQEBAQAAAAAAAAAAAAAAAAACAQD/2gAMAwEAAhADEAAAAcSerUQpOzXUqiMAb//EABsQAAMAAgMAAAAAAAAAAAAAAAABAhESAxQh/9oACAEBAAEFAjzJ1VJcZepyU9x0z//EABURAQEAAAAAAAAAAAAAAAAAABEg/9oACAEDAQE/AWP/xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/AR//xAAbEAADAAIDAAAAAAAAAAAAAAAAASEQERIxMv/aAAgBAQAGPwImPUNtcTodiz//xAAcEAACAgMBAQAAAAAAAAAAAAAAAREhMUFRYXH/2gAIAQEAAT8hWbK7l6NWStvasZEW4S7fwfTTAkNzkQZ//9oADAMBAAIAAwAAABAs1wP/xAAXEQEBAQEAAAAAAAAAAAAAAAABABEQ/9oACAEDAQE/EMLbwL//xAAXEQEBAQEAAAAAAAAAAAAAAAABEQAQ/9oACAECAQE/EIzR4rv/xAAfEAEAAwACAQUAAAAAAAAAAAABABEhMUFRYXGBodH/2gAIAQEAAT8QAjVRsF68R3WyhBpEB4otans9oxQXOZRxVfkow9YivuDFJrEfPmaECm2kqIiV2XP/2Q==","width":40,"height":40,"src":"/static/9d156e8486b343189790da372acb0018/987ea/my.jpg","srcSet":"/static/9d156e8486b343189790da372acb0018/987ea/my.jpg 1x,\n/static/9d156e8486b343189790da372acb0018/9c097/my.jpg 1.5x,\n/static/9d156e8486b343189790da372acb0018/bd6c6/my.jpg 2x"}}},"site":{"siteMetadata":{"title":"三洋的小站","author":"三洋"}},"markdownRemark":{"id":"ae499c39-cdba-50d6-b542-e6b565450b87","excerpt":"在跨平台客户端开发中，H5是使用最为广泛的方式，它既可以运行在iOS中，也可以运行在Android中，还可以运行在web浏览器中，可以说是”write once, run anywhere”。但是，H5最为人诟病的就是用户体验不如native…","html":"<p>在跨平台客户端开发中，H5是使用最为广泛的方式，它既可以运行在iOS中，也可以运行在Android中，还可以运行在web浏览器中，可以说是”write once, run anywhere”。但是，H5最为人诟病的就是用户体验不如native流畅，特别是对于低端机型和较差的网络环境，在页面加载时通常有较长一段时间的白屏等待时间。H5开发者想尽办法缩短首屏时间，用户可交互时间，为此使用了一系列的优化手段，比如ssr，code split，compress，lazy load，preload等等，其实主要是围绕<strong>尽量少</strong>这一核心原则。为了平衡跨终端能力和用户体验，现在流行的又有RN和Flutter解决方案等。咦，感觉跑题了，还是回到标题说的，具体来看看在IOS中，H5是怎么与native通信的。文字略长，但是我相信你看完了，会有所收获。</p>\n<p>说到通信，无非就是两种方式，native调用h5，h5调用native。H5在iOS中的宿主是UIWebView或者WKWebView，在IOS8中，Apple引入了WKWebView，将UIWebView标记为Deprecated。现在来说，大部分app应该都是使用的WKWebView，除非那些需要兼容IOS8以下系统的才会兼容使用UIWebView，本文也主要是说说使用WKWebView的场景。在实现H5与native之间的通信，比较流行的库就是<a href=\"https://github.com/marcuswestin/WebViewJavascriptBridge\">WebViewJavascriptBridge</a>，为了真正弄明白原理，我也是通读了它的源码，然后根据它的实现思路，自己用swift也实现了一遍。下面就结合一个小例子，谈谈它的实现原理。</p>\n<!--more-->\n<p>假如有一个需求，是H5在app内会有一个截屏按钮，点击这个按钮能对当前webView截图，然后显示在我们的H5中一个<code class=\"language-text\">img</code>元素里。</p>\n<a class=\"gatsby-resp-image-link\" href=\"/static/0281a7540bf12d756197b0ac913786cf/d266f/p.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 375px;\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 177.86666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAkCAYAAACJ8xqgAAAACXBIWXMAAAsSAAALEgHS3X78AAACSElEQVRIx+2WT28SQRiH96t4sD3UGkvx6MWT+nFM8At4NWk1pRbwK5jWowdMLNAS3V1gKVC6QIqQILC7XdiF3WWBnzOzyB9TzSa9GSZ58r4z8+aZnb3My7XbbTTqP1C/rqPZbIKO6XTKoMN1XdRqNZTLZSiKwtYmk8m87neMt5Io/CyDG7kjqIMe3LFLNiYrMtu2oaoqNE2DrutoNBps7kkWtRRrbMFxHSIkk4atwztzdbRabZyeJhGPf0E+X0AikUImk5sJcevgbKsD11ZAo/UHjqOQK2sk77I5zb15569whlGGYVyCRpPlHqZ5hZteFpouomdI6JsStF6GIJL9Etlf1C7DDQYVUExjgTGLqp7DcFiFLJ9B4D+TW1yTA/Lo9YnQqM7rGKbn4UxTZsloUsNousAlmG4ew/EF+rYEfZgleZGsSXAmMttfrh9aVCp7X2gYV6jmcpB5CRVhFVnIoSJKqIqznCEtRW9d7ZbIbcgXWlYVSreId0/j2NtMYX87ib0H/tinbKXwZusr8ikeLrnlTFjCh+cpRB+KiAUFRHf9EaMERLwPfEPxTGS/bS6MPkviaJtHZPc7jgL+iezwCO+kUbhdKDBhJMD7ZC1cC9fCtXAt/M+Evt+TfwljL5KIPCKv2WNSFPQHrY0GeRwGifB8Wdgp4fBJEgf3BIQ3eRxs+Ce8IeDt/TTyCYF1EBx97W+0S3x6ncDxyzROXp3jOOSfk1AaH0Mp1IpZOKPqorcZuGUMxndgKLOGifQ2XkI7qMEd8LovGb8AgaGmv2uAaGIAAAAASUVORK5CYII=&apos;); background-size: cover; display: block;\"></span>\n    <img class=\"gatsby-resp-image-image\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\" alt=\"p\" title src=\"/static/0281a7540bf12d756197b0ac913786cf/d266f/p.png\" srcset=\"/static/0281a7540bf12d756197b0ac913786cf/cf440/p.png 148w,\n/static/0281a7540bf12d756197b0ac913786cf/d2d38/p.png 295w,\n/static/0281a7540bf12d756197b0ac913786cf/d266f/p.png 375w\" sizes=\"(max-width: 375px) 100vw, 375px\">\n  </span>\n  </a>\n<p>如图可以看到，有一个截屏按钮，以及一个紫色区域，这个区域内有一个<code class=\"language-text\">img</code>，用来显示我们截屏之后的图片。</p>\n<p>这个通常需要H5与native配合才能完成，截屏的功能肯定是native那边完成，但是触发时机肯定是H5这边来控制。native需要提供一个bridge接口，比如takeSnapshot，然后在H5中就需要调用takeSnapshot接口并获得相应数据，</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">// h5部分代码</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">App</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">React<span class=\"token punctuation\">.</span>Component</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">props</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n      src<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>takeSnapshot <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">takeSnapshot</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function\">takeSnapshot</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>window<span class=\"token punctuation\">.</span>mpBridge<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      window<span class=\"token punctuation\">.</span>mpBridge<span class=\"token punctuation\">.</span><span class=\"token function\">ready</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">bridge</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        bridge<span class=\"token punctuation\">.</span><span class=\"token function\">callHandler</span><span class=\"token punctuation\">(</span><span class=\"token string\">'takeSnapshot'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> status<span class=\"token punctuation\">,</span> data <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n              <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n                src<span class=\"token punctuation\">:</span> data<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">,</span>\n              <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">className</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>operate<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n          </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span> <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>takeSnapshot<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">截屏</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>button</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">className</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>result<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n          </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>img</span> <span class=\"token attr-name\">src</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>src<span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n        </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> App<span class=\"token punctuation\">;</span></code></pre></div>\n<p>这段代码比较简单，就不解释。可以看到在调用takeSnapshot的回调中，h5拿到了path，然后将path赋值给了<code class=\"language-text\">img</code>标签。</p>\n<h4>Bridge的初始化</h4>\n<p>在完成上面这个例子时，H5和native两边都需要先完成bridge的初始化。H5这边通常会在<code class=\"language-text\">html</code>的 <code class=\"language-text\">head</code>中加载一段sdk代码，用来触发生成H5端bridge对象，每个公司都会自己提供一个对外的sdk脚本，比如微信提供的sdk等。通常放在<code class=\"language-text\">head</code> 中，是因为它需要最先执行完成，这样你代码中才可以使用。这个sdk脚本，其实就是提供了一个<code class=\"language-text\">ready</code>函数，bridge对象完成之后，会调用里面的回调函数，并提供<code class=\"language-text\">bridge</code>对象作为参数。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/* bridge sdk\n mpBridge.ready(bridge => {\n   bridge.callHandler('cmd', params, (error, data) => {\n\n   })\n})\n*/</span>\n\n<span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">w<span class=\"token punctuation\">,</span> d</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 已经加载了就直接返回，防止加载2遍</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>w<span class=\"token punctuation\">.</span>mpBridge<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// 是否bridge初始化完成</span>\n  <span class=\"token keyword\">let</span> initialized <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> queue <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">function</span> <span class=\"token function\">ready</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">handler</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>initialized<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 如果bridge初始化完成，则直接派发，执行</span>\n      <span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span>handler<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 否则，先缓存在队列里，等待bridge完成后派发，执行</span>\n      queue<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>handler<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">function</span> <span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">handler</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 派发，执行时，会提供bridge对象当作第一个参数</span>\n    <span class=\"token function\">handler</span><span class=\"token punctuation\">(</span>w<span class=\"token punctuation\">.</span>ClientBridge<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">function</span> <span class=\"token function\">_initialize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// bridge初始化完成了，就开始派发，执行先前缓存在队列里的</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> handler <span class=\"token keyword\">of</span> queue<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span>handler<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    queue <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    initialized <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// 通知native，注入bridge对象到当前的window对象上</span>\n  <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> iframe <span class=\"token operator\">=</span> d<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'iframe'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    iframe<span class=\"token punctuation\">.</span>hidden <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 这个src会被native那边拦截，然后根据host == 'bridgeinject',来判断是否注入bridge对象</span>\n    iframe<span class=\"token punctuation\">.</span>src <span class=\"token operator\">=</span> <span class=\"token string\">'https://bridgeinject'</span><span class=\"token punctuation\">;</span>\n    d<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>iframe<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      iframe<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// interface api</span>\n  <span class=\"token keyword\">const</span> mpBridge <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    ready<span class=\"token punctuation\">:</span> ready<span class=\"token punctuation\">,</span>\n    version<span class=\"token punctuation\">:</span> <span class=\"token string\">'1.0'</span><span class=\"token punctuation\">,</span>\n    _initialize<span class=\"token punctuation\">:</span> _initialize<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  window<span class=\"token punctuation\">.</span>mpBridge <span class=\"token operator\">=</span> mpBridge<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>window<span class=\"token punctuation\">,</span> document<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>这是我写的sdk，用于完成上面那个截屏的例子。最为主要功能是生成一个隐藏的iframe，来通知native注入bridge对象到window上，注入的bridge对象就是ClientBridge。它本身自己也会生成一个对象<code class=\"language-text\">mpBridge</code>，用来提供给开发人员。当然，这个 sdk的功能比较简单，其他公司的可能比较复杂，但是它绝对包含了最为重要的功能。这个时候h5中ClientBridge的初始化才算完成了一半，ClientBridge还没有被真正创建，真正被创建的过程是在native中完成的。</p>\n<p>在native端，在viewController中创建了webview并实现了navigationDelegate，并且也创建了NativeBridge。在navigationDelegate中，<strong>我们可以拦截h5中iframe发送的请求，理解这点非常重要，h5与native之间的通信就是通过这个拦截操完成的</strong>，后面会看到具体拦截细节，我们先看native端NativeBridge初始化的过程。</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token comment\">/// native 代码</span>\n<span class=\"token comment\">///  创建webview</span>\nwebView <span class=\"token operator\">=</span> <span class=\"token function\">WKWebView</span><span class=\"token punctuation\">(</span>frame<span class=\"token punctuation\">:</span> <span class=\"token builtin\">CGRect</span><span class=\"token punctuation\">.</span>zero<span class=\"token punctuation\">,</span> configuration<span class=\"token punctuation\">:</span> configuration<span class=\"token punctuation\">)</span>\nwebView<span class=\"token punctuation\">.</span>navigationDelegate <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span>\n<span class=\"token comment\">/// 初始化native端bridge</span>\n<span class=\"token keyword\">if</span> <span class=\"token keyword\">let</span> bridgeScriptPath <span class=\"token operator\">=</span> <span class=\"token builtin\">Bundle</span><span class=\"token punctuation\">.</span>main<span class=\"token punctuation\">.</span><span class=\"token function\">path</span><span class=\"token punctuation\">(</span>forResource<span class=\"token punctuation\">:</span> <span class=\"token string\">\"bridge\"</span><span class=\"token punctuation\">,</span> ofType<span class=\"token punctuation\">:</span> <span class=\"token string\">\"js\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>bridge <span class=\"token operator\">=</span> <span class=\"token function\">Bridge</span><span class=\"token punctuation\">(</span>webView<span class=\"token punctuation\">:</span> webView<span class=\"token punctuation\">,</span> scriptURL<span class=\"token punctuation\">:</span> <span class=\"token function\">URL</span><span class=\"token punctuation\">(</span>fileURLWithPath<span class=\"token punctuation\">:</span> bridgeScriptPath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>在native端，也会生成一个bridge对象，通过这个对象，native可以注册接口函数给h5调用，native也可以调用h5中注册的函数。通过sdk中生成的iframe，触发注入h5端ClientBridge，此时，native端才开始把ClientBridge注入到h5中去，</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token comment\">/// native 代码</span>\n<span class=\"token keyword\">func</span> <span class=\"token function\">injectClientBridge</span><span class=\"token punctuation\">(</span>completionHandler handler<span class=\"token punctuation\">:</span> <span class=\"token builtin\">EvaluateJavasriptHandler</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token keyword\">let</span> data <span class=\"token operator\">=</span> <span class=\"token keyword\">try</span><span class=\"token operator\">?</span> <span class=\"token function\">Data</span><span class=\"token punctuation\">(</span>contentsOf<span class=\"token punctuation\">:</span> scriptURL<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">let</span> code <span class=\"token operator\">=</span> <span class=\"token function\">String</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">:</span> data<span class=\"token punctuation\">,</span> encoding<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">.</span>utf8<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">/// 核心点就是，native可以直接执行JavaScript</span>\n        <span class=\"token function\">evaluateJavascript</span><span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">,</span> completionHandler<span class=\"token punctuation\">:</span> handler<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        handler<span class=\"token operator\">?</span><span class=\"token punctuation\">(</span><span class=\"token constant\">nil</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">BridgeError</span><span class=\"token punctuation\">.</span>injectBridgeError<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>在native端，可以直接以字符串形式执行JavaScript脚本</strong>。通常，会先准备好ClientBridge的脚本，然后在native直接执行，就可以将它注入到H5中去了。我准备的ClientBridge脚本如下，</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/*\n   ClientBridge.callHandler('cmd', params, (error, data) => {\n\n   })\n*/</span>\n\n<span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">w<span class=\"token punctuation\">,</span> d</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 已经注入了ClientBridge</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>w<span class=\"token punctuation\">.</span>ClientBridge<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// uid自增，用来标记callBackID的</span>\n  <span class=\"token keyword\">var</span> uid <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// h5中消息队列，用来发送到native中去的</span>\n  <span class=\"token keyword\">var</span> messageQueue <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// h5回调函数映射表，通过callBackID关联  </span>\n  <span class=\"token keyword\">var</span> callbacksMap <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// 通信的scheme，可以是其他字符串</span>\n  <span class=\"token keyword\">var</span> scheme <span class=\"token operator\">=</span> <span class=\"token string\">'https'</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// 通信的host，用来标记请求是h5通信发出的</span>\n  <span class=\"token keyword\">var</span> messageHost <span class=\"token operator\">=</span> <span class=\"token string\">'bridgemessage'</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">var</span> messageUrl <span class=\"token operator\">=</span> scheme <span class=\"token operator\">+</span> <span class=\"token string\">'://'</span> <span class=\"token operator\">+</span> messageHost<span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// 会创建一个iframe，h5发送消息给native，通过iframe触发  </span>\n  <span class=\"token keyword\">var</span> iframe <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> i <span class=\"token operator\">=</span> d<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'iframe'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    i<span class=\"token punctuation\">.</span>hidden <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    d<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> i<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">function</span> <span class=\"token function\">_noop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// 处理来自native端的消息，</span>\n  <span class=\"token keyword\">function</span> <span class=\"token function\">_handlerMessageFromNative</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">dataString</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'receive message from native: '</span> <span class=\"token operator\">+</span> dataString<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> data <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>dataString<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>responseId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 如果有responseId , 则说明消息是h5调用了native的接口，根据responseId可以找到存储的回调函数，然后执行回调，将数据传递给H5</span>\n      <span class=\"token keyword\">var</span> callback <span class=\"token operator\">=</span> callbacksMap<span class=\"token punctuation\">[</span>data<span class=\"token punctuation\">.</span>responseId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> callback <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>responseData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      callbacksMap<span class=\"token punctuation\">[</span>data<span class=\"token punctuation\">.</span>responseId<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 否则，就是native直接调用h5的接口，</span>\n      <span class=\"token keyword\">var</span> callback<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>callbackId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 如果有callbackId，则要回发结果</span>\n        <span class=\"token function-variable function\">callback</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token function\">_doSend</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> responseId<span class=\"token punctuation\">:</span> data<span class=\"token punctuation\">.</span>callbackId<span class=\"token punctuation\">,</span> responseData<span class=\"token punctuation\">:</span> res <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 否则，不处理</span>\n        callback <span class=\"token operator\">=</span> _noop<span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token comment\">// 通过handlerName,找到h5注册好的接口函数</span>\n      <span class=\"token keyword\">var</span> handler <span class=\"token operator\">=</span> callbacksMap<span class=\"token punctuation\">[</span>data<span class=\"token punctuation\">.</span>handlerName<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> handler <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">handler</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">,</span> callback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">warn</span><span class=\"token punctuation\">(</span><span class=\"token string\">'receive unknown message from native:'</span> <span class=\"token operator\">+</span> dataString<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// native 通过调用_fetchQueue函数来获取H5中消息队列里的消息</span>\n  <span class=\"token keyword\">function</span> <span class=\"token function\">_fetchQueue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> message <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>messageQueue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    messageQueue <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'send message to native : '</span> <span class=\"token operator\">+</span> message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> message<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// 发送消息  </span>\n  <span class=\"token keyword\">function</span> <span class=\"token function\">_doSend</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">message</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 将消息加到消息队列里，  </span>\n    messageQueue<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 然后通过iframe触发  </span>\n    iframe<span class=\"token punctuation\">.</span>src <span class=\"token operator\">=</span> messageUrl<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// ClientBridge对外H5的函数，h5可以通过callHandler来调用native中的接口</span>\n  <span class=\"token keyword\">function</span> <span class=\"token function\">callHandler</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">name<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">,</span> callback</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    uid <span class=\"token operator\">=</span> uid <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> data <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      callback <span class=\"token operator\">=</span> data<span class=\"token punctuation\">;</span>\n      data <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> callback <span class=\"token operator\">!==</span> <span class=\"token string\">'function'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      callback <span class=\"token operator\">=</span> _noop<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// 先生成一个唯一的callbackId， </span>\n    <span class=\"token keyword\">var</span> callbackId <span class=\"token operator\">=</span> <span class=\"token string\">'callback_'</span> <span class=\"token operator\">+</span> uid <span class=\"token operator\">+</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">valueOf</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 将回调函数保存在哈希表中，后面通过responseId可以取出  </span>\n    callbacksMap<span class=\"token punctuation\">[</span>callbackId<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> callback<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 发送  </span>\n    <span class=\"token function\">_doSend</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> handlerName<span class=\"token punctuation\">:</span> name<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">:</span> data<span class=\"token punctuation\">,</span> callbackId<span class=\"token punctuation\">:</span> callbackId <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// ClientBridge对外h5的函数，h5可以通过registerHandler来注册接口，供native来调用</span>\n  <span class=\"token keyword\">function</span> <span class=\"token function\">registerHandler</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">name<span class=\"token punctuation\">,</span> callback</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 直接将注册的接口保存在哈希表中  </span>\n    callbacksMap<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> callback<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// 在window上生成ClientBridge对象</span>\n  w<span class=\"token punctuation\">.</span>ClientBridge <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    callHandler<span class=\"token punctuation\">:</span> callHandler<span class=\"token punctuation\">,</span>\n    registerHandler<span class=\"token punctuation\">:</span> registerHandler<span class=\"token punctuation\">,</span>\n    _fetchQueue<span class=\"token punctuation\">:</span> _fetchQueue<span class=\"token punctuation\">,</span>\n    _handlerMessageFromNative<span class=\"token punctuation\">:</span> _handlerMessageFromNative<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// 调用sdk中的初始化方法  </span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>w<span class=\"token punctuation\">.</span>mpBridge<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    w<span class=\"token punctuation\">.</span>mpBridge<span class=\"token punctuation\">.</span><span class=\"token function\">_initialize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>window<span class=\"token punctuation\">,</span> document<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>核心原理也是通过在h5中生成一个iframe，通过iframe来充当h5与native之间的信使。<code class=\"language-text\">ClientBridge.callHandler</code>和<code class=\"language-text\">ClientBridge.registerHandler</code>是暴露给h5端使用的，<code class=\"language-text\">ClientBridge._fetchQueue</code>和<code class=\"language-text\">ClientBridge._handlerMessageFromNative</code>是提供给native端使用的。只有当native执行了这一段脚本，h5中bridge才算真正初始化完成。</p>\n<h4>拦截请求</h4>\n<p>在native端，通过实现WkWebView的WKNavigationDelegate，可以拦截h5中加载frame的请求，然后通过请求的scheme和host来判断是否是我们约定好的，例如上面注入bridge的sdk中，我们约定的scheme是https，host是bridgeinject。</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token comment\">/// native 部分代码   </span>\n<span class=\"token comment\">/// 此函数就是拦截h5中iframe发送的请求</span>\n<span class=\"token keyword\">func</span> <span class=\"token function\">webView</span><span class=\"token punctuation\">(</span><span class=\"token number\">_</span> webView<span class=\"token punctuation\">:</span> <span class=\"token builtin\">WKWebView</span><span class=\"token punctuation\">,</span> decidePolicyFor navigationAction<span class=\"token punctuation\">:</span> <span class=\"token builtin\">WKNavigationAction</span><span class=\"token punctuation\">,</span> decisionHandler<span class=\"token punctuation\">:</span> @escaping <span class=\"token punctuation\">(</span><span class=\"token builtin\">WKNavigationActionPolicy</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token builtin\">Void</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">guard</span> webView <span class=\"token operator\">==</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>webView<span class=\"token punctuation\">,</span>\n            <span class=\"token keyword\">let</span> bridge <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>bridge<span class=\"token punctuation\">,</span>\n            <span class=\"token keyword\">let</span> url <span class=\"token operator\">=</span> navigationAction<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">.</span>url\n        <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">decisionHandler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span>allow<span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">return</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">if</span> bridge<span class=\"token punctuation\">.</span><span class=\"token function\">isBridgeInjectURL</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">/// 如果注入bridge的请求，则开始注入bridge到h5中</span>\n            bridge<span class=\"token punctuation\">.</span><span class=\"token function\">injectClientBridge</span><span class=\"token punctuation\">(</span>completionHandler<span class=\"token punctuation\">:</span> <span class=\"token constant\">nil</span><span class=\"token punctuation\">)</span>\n            <span class=\"token comment\">/// 并取消掉本次请求，因为并不是真正的需要请求，</span>\n            <span class=\"token function\">decisionHandler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span>cancel<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> bridge<span class=\"token punctuation\">.</span><span class=\"token function\">isBridgeMessageURL</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">/// 如果是h5与native之间的消息请求，则处理h5那边的消息，</span>\n            bridge<span class=\"token punctuation\">.</span><span class=\"token function\">flushMessageQueue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token comment\">/// 同样的，需要取消掉本次请求，</span>\n            <span class=\"token function\">decisionHandler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span>cancel<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">/// 否则，其他情况，都正常请求</span>\n            <span class=\"token function\">decisionHandler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span>allow<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>上面的native中代码可以看到，通过实现了WKNavigationDelegate中decidePolicyForNavigationAction的方法，我们可以拦截iframe以及mainFrame的请求，然后做如下处理：</p>\n<ul>\n<li>如果请求是注入bridge到h5的请求，则开始处理注入bridge对象到h5中，并取消本次请求。这个请求就是上面sdk中创建的iframe触发的。它的请求url是<em><a href=\"https://bridgeinject\">https://bridgeinject</a></em></li>\n<li>如果请求是h5与native之间通信的请求，则开始处理h5中传递的消息，并取消本次请求。这个请求会在后面看到。它的请求url是<em><a href=\"https://bridgemessage\">https://bridgemessage</a></em></li>\n<li>否则，就是正常的mainFrame或者iframe请求，正常处理请求</li>\n</ul>\n<h4>H5调用native接口</h4>\n<p>先来看看第一种通信方式，就是h5调用native中的接口，比如例子中，h5调用native提供的takeSnapshot接口实现截屏功能。</p>\n<p>首先，native端必须先注册好takeSnapshot接口，这样h5才能使用。native端注册takeSnapshot接口代码如下，</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token comment\">/// native端，通过NativeBridge注册takeSnapshot接口</span>\nbridge<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">registerHandler</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"takeSnapshot\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token number\">_</span><span class=\"token punctuation\">,</span> callback <span class=\"token keyword\">in</span>\n    <span class=\"token comment\">/// 调用webView的takeSnapshot函数实现截屏</span>\n    <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>webView<span class=\"token punctuation\">.</span><span class=\"token function\">takeSnapshot</span><span class=\"token punctuation\">(</span>with<span class=\"token punctuation\">:</span> <span class=\"token constant\">nil</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        image<span class=\"token punctuation\">,</span> error <span class=\"token keyword\">in</span>\n        <span class=\"token keyword\">let</span> fileName <span class=\"token operator\">=</span> <span class=\"token string\">\"snapshot\"</span>\n        <span class=\"token keyword\">guard</span> <span class=\"token keyword\">let</span> image <span class=\"token operator\">=</span> image<span class=\"token punctuation\">,</span> error <span class=\"token operator\">==</span> <span class=\"token constant\">nil</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">Bridge</span><span class=\"token punctuation\">.</span><span class=\"token function\">HandlerResult</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">.</span><span class=\"token function\">fail</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">return</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token comment\">// 将得到的UIimage保存到cache file目录下</span>\n        <span class=\"token keyword\">guard</span> <span class=\"token keyword\">let</span> <span class=\"token number\">_</span> <span class=\"token operator\">=</span> <span class=\"token builtin\">LocalStore</span><span class=\"token punctuation\">.</span><span class=\"token function\">storeCacheImage</span><span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">,</span> fileName<span class=\"token punctuation\">:</span> fileName<span class=\"token punctuation\">)</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">Bridge</span><span class=\"token punctuation\">.</span><span class=\"token function\">HandlerResult</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">.</span><span class=\"token function\">fail</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">return</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token comment\">// 生成src，提供给h5</span>\n        <span class=\"token keyword\">guard</span> <span class=\"token keyword\">let</span> src <span class=\"token operator\">=</span> <span class=\"token builtin\">ImageBridge</span><span class=\"token punctuation\">.</span><span class=\"token function\">generateSRC</span><span class=\"token punctuation\">(</span>fileName<span class=\"token punctuation\">:</span> fileName<span class=\"token punctuation\">)</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">Bridge</span><span class=\"token punctuation\">.</span><span class=\"token function\">HandlerResult</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">.</span><span class=\"token function\">fail</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">return</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token comment\">// 生成返回数据，包含src</span>\n        <span class=\"token keyword\">var</span> result <span class=\"token operator\">=</span> <span class=\"token builtin\">Bridge</span><span class=\"token punctuation\">.</span><span class=\"token function\">HandlerResult</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">.</span>success<span class=\"token punctuation\">)</span>\n        result<span class=\"token punctuation\">.</span>data <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"path\"</span><span class=\"token punctuation\">:</span> src<span class=\"token punctuation\">]</span>\n        <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>至于native端的NativeBridge实现细节，其实与ClientBridge思路一样的，大致也是有一个字典保存注册的函数，然后根据h5调用handlerName来查找出这个函数，然后执行，具体细节就不说了，感兴趣可以看看<a href=\"https://github.com/snayan/MusicPlayer/blob/master/MusicPlayer/bridge/Bridge.swift\">这里</a>。可以看到，h5与native两边必须提供相同的handlerName。通常呢，这个handlerName是native开发人员定义好的，然后H5开发人员按照文档使用。native定义好了接口，那么h5这边就需要调用了，</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// h5端，调用native定义的接口</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>window<span class=\"token punctuation\">.</span>mpBridge<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    window<span class=\"token punctuation\">.</span>mpBridge<span class=\"token punctuation\">.</span><span class=\"token function\">ready</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">bridge</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        bridge<span class=\"token punctuation\">.</span><span class=\"token function\">callHandler</span><span class=\"token punctuation\">(</span><span class=\"token string\">'takeSnapshot'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> status<span class=\"token punctuation\">,</span> data <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n                        src<span class=\"token punctuation\">:</span> data<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">,</span>\n                    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>h5在调用<code class=\"language-text\">bridge.callHandler</code>时，生成唯一的callbackId，并将回调保存在哈希表中，然后通过iframe触发通知native。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">callHandler</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">name<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">,</span> callback</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    uid <span class=\"token operator\">=</span> uid <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> data <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        callback <span class=\"token operator\">=</span> data<span class=\"token punctuation\">;</span>\n        data <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> callback <span class=\"token operator\">!==</span> <span class=\"token string\">'function'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        callback <span class=\"token operator\">=</span> _noop<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// 生成一个唯一的callbackId</span>\n    <span class=\"token keyword\">var</span> callbackId <span class=\"token operator\">=</span> <span class=\"token string\">'callback_'</span> <span class=\"token operator\">+</span> uid <span class=\"token operator\">+</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">valueOf</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 将回调函数保存在哈希表中</span>\n    callbacksMap<span class=\"token punctuation\">[</span>callbackId<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> callback<span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// 触发iframe发送消息</span>\n    <span class=\"token function\">_doSend</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> handlerName<span class=\"token punctuation\">:</span> name<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">:</span> data<span class=\"token punctuation\">,</span> callbackId<span class=\"token punctuation\">:</span> callbackId <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>native通过拦截iframe的请求，判断是否h5中通信请求，如果是就开始处理，处理过程如下，</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token comment\">//native 核心代码如下</span>\n<span class=\"token keyword\">func</span> <span class=\"token function\">flushMessageQueue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 执行ClientBridge._fetchQueue,获取h5中消息队列中数据</span>\n    <span class=\"token function\">evaluateJavascript</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ClientBridge._fetchQueue()\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        result<span class=\"token punctuation\">,</span> error <span class=\"token keyword\">in</span>\n         <span class=\"token comment\">// 转成json</span>\n        <span class=\"token keyword\">let</span> jsonData <span class=\"token operator\">=</span> <span class=\"token keyword\">try</span> <span class=\"token builtin\">JSONSerialization</span><span class=\"token punctuation\">.</span><span class=\"token function\">jsonObject</span><span class=\"token punctuation\">(</span>with<span class=\"token punctuation\">:</span> result<span class=\"token punctuation\">,</span> options<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">let</span> messages <span class=\"token operator\">=</span> jsonData <span class=\"token keyword\">as</span><span class=\"token operator\">!</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">BridgeData</span><span class=\"token punctuation\">]</span>\n        <span class=\"token keyword\">for</span> message <span class=\"token keyword\">in</span> messages <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token keyword\">let</span> callbackId <span class=\"token operator\">=</span>  message<span class=\"token punctuation\">[</span><span class=\"token string\">\"callbackId\"</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">as</span><span class=\"token operator\">?</span> <span class=\"token builtin\">String</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token comment\">/// 生成RequestMesage，调用native接口</span>\n                <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span><span class=\"token function\">resumeWebCallHandlerMessage</span><span class=\"token punctuation\">(</span><span class=\"token function\">RequestMessage</span><span class=\"token punctuation\">(</span>handlerName<span class=\"token punctuation\">:</span> message<span class=\"token punctuation\">[</span><span class=\"token string\">\"handlerName\"</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">as</span><span class=\"token operator\">?</span> <span class=\"token builtin\">String</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">:</span> message<span class=\"token punctuation\">[</span><span class=\"token string\">\"data\"</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">as</span><span class=\"token operator\">?</span> <span class=\"token builtin\">BridgeData</span><span class=\"token punctuation\">,</span> callbackId<span class=\"token punctuation\">:</span> callbackId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n            <span class=\"token punctuation\">}</span> \n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>获取了h5中消息之后，判断消息中是否包含了callbackId，如果包含了，则说明是h5发送的一个RequestMessage。通过handlerName取出native注册好的接口函数，然后执行，并返回结果。</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">func</span> <span class=\"token function\">resumeWebCallHandlerMessage</span><span class=\"token punctuation\">(</span><span class=\"token number\">_</span> message<span class=\"token punctuation\">:</span> <span class=\"token builtin\">RequestMessage</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 通过handlerName拿到native注册的接口，</span>\n    <span class=\"token keyword\">guard</span> <span class=\"token keyword\">let</span> name <span class=\"token operator\">=</span> message<span class=\"token punctuation\">.</span>handlerName<span class=\"token punctuation\">,</span> <span class=\"token keyword\">let</span> handler <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>responseHandlersMap<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">debugPrint</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"unkown handler name\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// 然后执行接口，并返回数据</span>\n    <span class=\"token function\">handler</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        result <span class=\"token keyword\">in</span>\n        <span class=\"token comment\">// callbackId对应变成了responseId，返回的数据在responseData中</span>\n        <span class=\"token keyword\">let</span> responseMessage <span class=\"token operator\">=</span> <span class=\"token function\">ResponseMessage</span><span class=\"token punctuation\">(</span>responseData<span class=\"token punctuation\">:</span> result<span class=\"token punctuation\">.</span><span class=\"token function\">getData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> responseId<span class=\"token punctuation\">:</span> message<span class=\"token punctuation\">.</span>callbackId<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span><span class=\"token function\">sendToWeb</span><span class=\"token punctuation\">(</span>responseMessage<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>最后，native通过执行<code class=\"language-text\">ClientBridge._handlerMessageFromNative</code>来将结果返回给h5。</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token comment\">/// 将消息发送给h5端</span>\n<span class=\"token keyword\">func</span> <span class=\"token function\">sendToWeb</span><span class=\"token punctuation\">(</span><span class=\"token number\">_</span> message<span class=\"token punctuation\">:</span> <span class=\"token builtin\">MessageProtocol</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">do</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">/// 先序列化json数据</span>\n        <span class=\"token keyword\">let</span> data <span class=\"token operator\">=</span> <span class=\"token keyword\">try</span> <span class=\"token builtin\">JSONSerialization</span><span class=\"token punctuation\">.</span><span class=\"token function\">data</span><span class=\"token punctuation\">(</span>withJSONObject<span class=\"token punctuation\">:</span> message<span class=\"token punctuation\">.</span><span class=\"token function\">serialization</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> options<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">let</span> result <span class=\"token operator\">=</span> <span class=\"token function\">String</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">:</span> data<span class=\"token punctuation\">,</span> encoding<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">.</span>utf8<span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span><span class=\"token operator\">?</span> <span class=\"token string\">\"\"</span>\n        <span class=\"token comment\">// 最后执行ClientBridge._handlerMessageFromNative</span>\n        <span class=\"token function\">evaluateJavascript</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token delimiter variable\">\\(</span>clientBridgeName<span class=\"token delimiter variable\">)</span></span>._handlerMessageFromNative('<span class=\"token interpolation\"><span class=\"token delimiter variable\">\\(</span>result<span class=\"token delimiter variable\">)</span></span>')\"</span><span class=\"token punctuation\">,</span> completionHandler<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token number\">_</span><span class=\"token punctuation\">,</span><span class=\"token number\">_</span> <span class=\"token keyword\">in</span>\n                                                                                                            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">debugPrint</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>native调用h5接口</h4>\n<p>再来看看第二种通信方式，就是native调用h5端的接口，比如h5中会注册一个监听导航条上的返回按钮的函数，比较叫做onBackEvent，native通过调用h5中onBackEvent的接口函数，决定是否直接关闭当前webView。</p>\n<p>类似的，h5中必须先注册onBackEvent接口，</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>window<span class=\"token punctuation\">.</span>mpBridge<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    window<span class=\"token punctuation\">.</span>mpBridge<span class=\"token punctuation\">.</span><span class=\"token function\">ready</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">bridge</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        bridge<span class=\"token punctuation\">.</span><span class=\"token function\">registerHandler</span><span class=\"token punctuation\">(</span><span class=\"token string\">'onBackEvent'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">data<span class=\"token punctuation\">,</span> done</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// do something, </span>\n            <span class=\"token comment\">// 返回true 则直接关闭当前webView，false 则不关闭当前webView</span>\n            <span class=\"token function\">done</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>然后，在native中监听导航条那个返回按钮的点击事件中，调用h5的onBackEvent，根据结果来决定是否关闭当前webView。</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token comment\">/// 导航条返回按钮的点击事件 </span>\n<span class=\"token atrule\">@objc</span> <span class=\"token keyword\">private</span> <span class=\"token keyword\">func</span> <span class=\"token function\">handleBackTap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token keyword\">let</span> bridge <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>bridge <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">/// 调用h5中注册的onBackEvent函数，</span>\n        bridge<span class=\"token punctuation\">.</span><span class=\"token function\">callHandler</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"onBackEvent\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            data <span class=\"token keyword\">in</span>\n            <span class=\"token keyword\">guard</span> <span class=\"token keyword\">let</span> pop <span class=\"token operator\">=</span> data <span class=\"token keyword\">as</span><span class=\"token operator\">?</span> <span class=\"token builtin\">Bool</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token comment\">// 如果为true，则关闭当前webView</span>\n            <span class=\"token keyword\">if</span> pop <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>navigationController<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">popViewController</span><span class=\"token punctuation\">(</span>animated<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>navigationController<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">popViewController</span><span class=\"token punctuation\">(</span>animated<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>NativeBridge中的callHandler函数实现思路和h5中的一样，也是生成一个唯一的callbackId，然后将回调保存在字典表中，再将消息发送到h5。</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token comment\">/// native 端 callHandler的实现</span>\n<span class=\"token keyword\">func</span> <span class=\"token function\">callHandler</span><span class=\"token punctuation\">(</span><span class=\"token number\">_</span> name<span class=\"token punctuation\">:</span> <span class=\"token builtin\">String</span><span class=\"token punctuation\">,</span> callback<span class=\"token punctuation\">:</span> @escaping <span class=\"token builtin\">RequestCallback</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 生成一个唯一的callbackId</span>\n    <span class=\"token keyword\">let</span> uuid <span class=\"token operator\">=</span> <span class=\"token function\">UUID</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>uuidString\n    <span class=\"token comment\">// 将回调保存在字典表中</span>\n    requestHandlersMap<span class=\"token punctuation\">[</span>uuid<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> callback\n    <span class=\"token comment\">// 生成一个requestmessage，</span>\n    <span class=\"token keyword\">let</span> requestMessage <span class=\"token operator\">=</span> <span class=\"token function\">RequestMessage</span><span class=\"token punctuation\">(</span>handlerName<span class=\"token punctuation\">:</span> name<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">:</span> <span class=\"token constant\">nil</span><span class=\"token punctuation\">,</span> callbackId<span class=\"token punctuation\">:</span> uuid<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// 然后发送到h5去</span>\n    <span class=\"token function\">sendToWeb</span><span class=\"token punctuation\">(</span>requestMessage<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>h5这边通过<code class=\"language-text\">ClientBridge._handlerMessageFromNative</code> 可以接受这个消息，然后根据handlerName查找到h5已经注册的接口函数，最后执行并返回数据给native。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// native call web</span>\n<span class=\"token keyword\">var</span> callback<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>callbackId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 如果有callbackId，则要回发结果</span>\n    <span class=\"token function-variable function\">callback</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">_doSend</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> responseId<span class=\"token punctuation\">:</span> data<span class=\"token punctuation\">.</span>callbackId<span class=\"token punctuation\">,</span> responseData<span class=\"token punctuation\">:</span> res <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 否则，不处理</span>\n    callback <span class=\"token operator\">=</span> _noop<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">var</span> handler <span class=\"token operator\">=</span> callbacksMap<span class=\"token punctuation\">[</span>data<span class=\"token punctuation\">.</span>handlerName<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> handler <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">handler</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">,</span> callback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">warn</span><span class=\"token punctuation\">(</span><span class=\"token string\">'receive unknown message from native:'</span> <span class=\"token operator\">+</span> dataString<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>通信流程图</h4>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c78f3d5d8d1f9a327267e7a657ea5206/207b7/WebViewJavascriptBridge.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 150.5903723887375%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAeCAYAAAAsEj5rAAAACXBIWXMAAAsSAAALEgHS3X78AAAFdElEQVRIx3VV2Y4bRRT1X/Ex/AEP8ACKEIhISDwinniJFCkSUoQCUYISERLIZPPMeGvvdntrt3tv71t7GY/bfThVPc5kiLB0dLuq7j11z63yrUQEQED8DocIq9U6HochYDuA3wc8P4YYE1G7A5imjAkZswxWuNyHcpyQdNFO4mK9gGvriPZbRCGBPaLo8hqILTgvY/YbhBcBXFPDJpjK1BJbpwCv+Bxr/YzZ5BF5irQHV0Hk5m4gdHLAIIecksatB2XcflRFT81hbWSxtegzrCARWmfYGSkcnCxCO4sLfkOQegz2lQ+Qj20/j6H6FsXkM+il15hoWdi9NiZGFYfeX0hEbpqOBSKHuVWFbXQRmHmse2nMtDQW3ZTMft09xUpLShvajHEziOwULs2UnEO/hEv9OQmdNOUoMqudlcXOzGCs5fDV/Rx+eFLH7cd1qMVT7HtJLNrvsBGloe9BliEuy97kXL+I/XtCLybcGhnMmdVaT+Hd019QT/4Bu3yCpXYa1/eKIBTlIUSZLswsJu0UtjYJe4LQJjud4GUwM0ow9Y6UutHeIOi8xar9hjU+kzL3VopIIxTg+GCdY97NwrN0jHs1hDpriFkHB6+I0CthZyvYUDL8EjCqEhVKqci10P0/MDM7T1tANNOQmPaX0CsmTNWB2xhj1JqhXPDw9e86vntkIJOz4Tc9rnuwGh/DFrbuwlJdzIYrJJqKjtybMmrpDjLZU5ycP0YyeYZfH6bx54s6SkoHTs9Dt27BqPowaj7MWmwF9KoDs+HA4IZawUKiV3W5u89dhrj78lt8+fgTPHpzB265Dy3fQUftoD/y0W33oJUsNJQuSmcqqpkWOkULaqENrdOF1uihkdavCOvcre7BqY/h1Wew1RHHfgwhtRVboxbDJBxVwEev5qKZ1+nrop0zPiCUElz0KOEYGIPz1SsryOpCpodKwUVRsdEsk0w30G3+J0NJKgLluP9+TkK9Wif85gDnaROf3VPxxX0dKX6bVUsqbH2YYbfCSc2C1bWgqXG99Ioj0S3bV4jnWpSovM6jdq6iXe6i0+zCaDPbTO+aUJxWu6KjRQdhuxVbyhcEtUxbopJqSnRKJjRu0C7Q8sq1Khp01UIzS0IRYNbjQus1Zlc3KNGV46NkS72J6/mr0rBU4ruTN5Ho96bMok85JGza/Ou5vHMiM3EIfZ4iUb0JMW/VxFWLD7NHQuE/MKf8L4cX2E017CZtrAdNrPyGtOth42MMYhtwfeR1MHBbWPZVBH4Fq2ETB3bwxH6pYmq+wMw+ARZsFEtixX63YsMIsrE9IiAucrDYHG49zOKbJ2UM/SKfghawKSNat9ixF2VsBknMnSSGNh3sCpHHbszOMs3gcpLBBb8FtqNzOV66b9FSfsPCeIVa6x4eZD5HqvETN21QcsCuslIQzhRM+w1MBy1MKeGSZPtZTtoFCQRm1mtpxUb7ObOfF1DV7uLOu09xUvmePM2YMFpkCTbYURpLjy2eRNgIeQxas/kG+ZtYKtdYM6GtRv86oqCOxEFkuGTnHWcxHpjwXR0DFlxpFfGyUobnXtVvyZa/+BgHJrOfsdnO0zGhlMxJsdvlhJ14lsGKmf789BV+fJZDQeVDxPptRhlJikD5T6YkZgwWfLRWR0JmuJtkMfRafLQbGDo1bJ2/geE/GPBRcv0xXMdC0BeHQvLBmTyg/TSFkZWBY7Qwcoo4LKvXhKJu6zHvE7EecXHBtk5Jm3EBq7mFFe/qfipKcy4PZt0/RcSD2bJUC77V2zHlB7WbkgWxvHtBXJ+jpMMsxeB0PBaSV0fJOf4pCpgPqGhyzHDrMpj66SxO+hrHwgvSuF43DyROIBgW4dttXrUyDhsL/wK+eICLIsIKBQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"WebViewJavascriptBridge原理图\"\n        title=\"\"\n        src=\"/static/c78f3d5d8d1f9a327267e7a657ea5206/b9e4f/WebViewJavascriptBridge.png\"\n        srcset=\"/static/c78f3d5d8d1f9a327267e7a657ea5206/cf440/WebViewJavascriptBridge.png 148w,\n/static/c78f3d5d8d1f9a327267e7a657ea5206/d2d38/WebViewJavascriptBridge.png 295w,\n/static/c78f3d5d8d1f9a327267e7a657ea5206/b9e4f/WebViewJavascriptBridge.png 590w,\n/static/c78f3d5d8d1f9a327267e7a657ea5206/f9b6a/WebViewJavascriptBridge.png 885w,\n/static/c78f3d5d8d1f9a327267e7a657ea5206/207b7/WebViewJavascriptBridge.png 1101w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </span>\n  </a></p>\n<h4>展示截屏图片</h4>\n<p>其实，在h5调用native中takeSnapshot接口后，native实现了截屏，获得到UIImage，有两种返回可以返回数据给h5</p>\n<ol>\n<li>native直接返回图片的base64数据，h5端直接展示</li>\n<li>native现将图片存在cache 目录里，生成一个src，返回给h5，h5请求这个src的图片</li>\n</ol>\n<p>其中第一种方式简单，但是图片直接生成的base64格式，数据太大，对于传递和调试极为不方便。第二种方式，麻烦一点，生成的src又必须是一个约定好的scheme格式，native又通过拦截请求，然后从cache目录里拿到图片，作为response返回。这次的拦截与iframe的拦截方式又不同，是通过<code class=\"language-text\">WKWebViewConfiguration.setURLSchemeHandler</code>来实现的，具体就不详细讨论了，感兴趣可以查看<a href=\"https://github.com/snayan/MusicPlayer/blob/master/MusicPlayer/Controllers/MPWebViewController.swift#L56-L58\">这里</a>。</p>\n<h4>小结</h4>\n<p>通过一个例子，详细的讨论了h5与native之间的通信方式，核心原理如下</p>\n<ul>\n<li>native可以直接执行JavaScript字符串形式执行js脚本，与h5通信</li>\n<li>native可以拦截iframe的请求，执行h5的通信请求</li>\n<li>h5通过iframe来发送数据给native</li>\n</ul>","frontmatter":{"title":"理解h5与native(ios)通信细节","date":"December 31, 2018"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/understand_the_details_of_h5_and_native(ios)_communication/","previous":{"fields":{"slug":"/understand_the_details_of_vritual_dom_snabbdom/"},"frontmatter":{"title":"理解virtual dom的实现细节-snabbdom"}},"next":{"fields":{"slug":"/summary_of_2018/"},"frontmatter":{"title":"2018年小结"}}}}