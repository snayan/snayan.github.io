{"data":{"avatar":{"childImageSharp":{"fixed":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGAABAAMBAAAAAAAAAAAAAAAAAAIEBQP/xAAWAQEBAQAAAAAAAAAAAAAAAAACAQD/2gAMAwEAAhADEAAAAcSerUQpOzXUqiMAb//EABsQAAMAAgMAAAAAAAAAAAAAAAABAhESAxQh/9oACAEBAAEFAjzJ1VJcZepyU9x0z//EABURAQEAAAAAAAAAAAAAAAAAABEg/9oACAEDAQE/AWP/xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/AR//xAAbEAADAAIDAAAAAAAAAAAAAAAAASEQERIxMv/aAAgBAQAGPwImPUNtcTodiz//xAAcEAACAgMBAQAAAAAAAAAAAAAAAREhMUFRYXH/2gAIAQEAAT8hWbK7l6NWStvasZEW4S7fwfTTAkNzkQZ//9oADAMBAAIAAwAAABAs1wP/xAAXEQEBAQEAAAAAAAAAAAAAAAABABEQ/9oACAEDAQE/EMLbwL//xAAXEQEBAQEAAAAAAAAAAAAAAAABEQAQ/9oACAECAQE/EIzR4rv/xAAfEAEAAwACAQUAAAAAAAAAAAABABEhMUFRYXGBodH/2gAIAQEAAT8QAjVRsF68R3WyhBpEB4otans9oxQXOZRxVfkow9YivuDFJrEfPmaECm2kqIiV2XP/2Q==","width":40,"height":40,"src":"/static/9d156e8486b343189790da372acb0018/987ea/my.jpg","srcSet":"/static/9d156e8486b343189790da372acb0018/987ea/my.jpg 1x,\n/static/9d156e8486b343189790da372acb0018/9c097/my.jpg 1.5x,\n/static/9d156e8486b343189790da372acb0018/bd6c6/my.jpg 2x"}}},"site":{"siteMetadata":{"title":"三羊的小站","author":"三羊","postPath":"/post","contentUrl":"https://github.com/snayan/blog-source/tree/master/content/blog","ableZan":true,"menu":{"search":{"name":"搜索","link":"/search"}}}},"markdownRemark":{"id":"aae71640-9909-5826-a72b-5322a619c615","excerpt":"最近在组内分享了一些关于 React Hooks 的内容，主要从源码实现，项目中错误的使用例子，以及使用建议等方面介绍了几个常用的 Hooks。整理了文字稿如下，由于错误例子涉及公司内部项目代码，所以就没有列举出来。useEffect 是最常见，使用最频繁的 Hooks…","html":"<p>最近在组内分享了一些关于 React Hooks 的内容，主要从源码实现，项目中错误的使用例子，以及使用建议等方面介绍了几个常用的 Hooks。整理了文字稿如下，由于错误例子涉及公司内部项目代码，所以就没有列举出来。</p>\n\n        <h2 id='toc-2-1' >\n          useEffect\n        </h2>\n      \n<p>useEffect 是最常见，使用最频繁的 Hooks 之一了。它的使用方式如下</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span>\n  <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// do some side effects</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// optional, clean up</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token comment\">/* [deps] */</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>先来简单分析一下它的源码，react 对 hooks 的实现，都是分了首次 mount 和后续 update 两个场景。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">mountEffectImpl</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fiberEffectTag<span class=\"token punctuation\">,</span> hookEffectTag<span class=\"token punctuation\">,</span> create<span class=\"token punctuation\">,</span> deps</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> hook <span class=\"token operator\">=</span> <span class=\"token function\">mountWorkInProgressHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> nextDeps <span class=\"token operator\">=</span> deps <span class=\"token operator\">===</span> <span class=\"token keyword\">undefined</span> <span class=\"token operator\">?</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">:</span> deps\n  sideEffectTag <span class=\"token operator\">|=</span> fiberEffectTag\n  <span class=\"token comment\">// 这里传递的destroy为undefined</span>\n  hook<span class=\"token punctuation\">.</span>memoizedState <span class=\"token operator\">=</span> <span class=\"token function\">pushEffect</span><span class=\"token punctuation\">(</span>hookEffectTag<span class=\"token punctuation\">,</span> create<span class=\"token punctuation\">,</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">,</span> nextDeps<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>在 mount 中实现时，useEffect 传递的 cleanup 为 undefined，所以在首次 mount 时，不会调用 cleanup。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">updateEffectImpl</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fiberEffectTag<span class=\"token punctuation\">,</span> hookEffectTag<span class=\"token punctuation\">,</span> create<span class=\"token punctuation\">,</span> deps</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> hook <span class=\"token operator\">=</span> <span class=\"token function\">updateWorkInProgressHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> nextDeps <span class=\"token operator\">=</span> deps <span class=\"token operator\">===</span> <span class=\"token keyword\">undefined</span> <span class=\"token operator\">?</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">:</span> deps\n  <span class=\"token keyword\">let</span> destroy <span class=\"token operator\">=</span> <span class=\"token keyword\">undefined</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>currentHook <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 获取上一次的值</span>\n    <span class=\"token keyword\">const</span> prevEffect <span class=\"token operator\">=</span> currentHook<span class=\"token punctuation\">.</span>memoizedState\n    destroy <span class=\"token operator\">=</span> prevEffect<span class=\"token punctuation\">.</span>destroy\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nextDeps <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 如果没有传递deps，则每次都会执行</span>\n      <span class=\"token keyword\">const</span> prevDeps <span class=\"token operator\">=</span> prevEffect<span class=\"token punctuation\">.</span>deps\n      <span class=\"token comment\">// 如果deps相等，则不需要执行（标识为NoHookEffect）</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">areHookInputsEqual</span><span class=\"token punctuation\">(</span>nextDeps<span class=\"token punctuation\">,</span> prevDeps<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">pushEffect</span><span class=\"token punctuation\">(</span>NoHookEffect<span class=\"token punctuation\">,</span> create<span class=\"token punctuation\">,</span> destroy<span class=\"token punctuation\">,</span> nextDeps<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  sideEffectTag <span class=\"token operator\">|=</span> fiberEffectTag\n  <span class=\"token comment\">// 这里的destroy是上一次effect返回的值</span>\n  hook<span class=\"token punctuation\">.</span>memoizedState <span class=\"token operator\">=</span> <span class=\"token function\">pushEffect</span><span class=\"token punctuation\">(</span>hookEffectTag<span class=\"token punctuation\">,</span> create<span class=\"token punctuation\">,</span> destroy<span class=\"token punctuation\">,</span> nextDeps<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>在 update 中实现时，有两点需要注意，其一是会进行 deps 的比较，如果相等，则忽略本次 effect；其二是传递的 destroy 是上一次 effect 中返回的返回的 cleanup 函数。</p>\n<p>在 render 阶段保存了 effect 相关数据，在 commit 阶段就会一个个去执行了，源码如下，</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">commitHookEffectList</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">unmountTag<span class=\"token punctuation\">,</span> mountTag<span class=\"token punctuation\">,</span> finishedWork</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> updateQueue <span class=\"token operator\">=</span> finishedWork<span class=\"token punctuation\">.</span>updateQueue\n  <span class=\"token keyword\">let</span> lastEffect <span class=\"token operator\">=</span> updateQueue <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">?</span> updateQueue<span class=\"token punctuation\">.</span>lastEffect <span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>lastEffect <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> firstEffect <span class=\"token operator\">=</span> lastEffect<span class=\"token punctuation\">.</span>next\n    <span class=\"token keyword\">let</span> effect <span class=\"token operator\">=</span> firstEffect\n    <span class=\"token keyword\">do</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>effect<span class=\"token punctuation\">.</span>tag <span class=\"token operator\">&amp;</span> unmountTag<span class=\"token punctuation\">)</span> <span class=\"token operator\">!==</span> NoHookEffect<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Unmount</span>\n        <span class=\"token keyword\">const</span> destroy <span class=\"token operator\">=</span> effect<span class=\"token punctuation\">.</span>destroy\n        effect<span class=\"token punctuation\">.</span>destroy <span class=\"token operator\">=</span> <span class=\"token keyword\">undefined</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>destroy <span class=\"token operator\">!==</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token comment\">// 先执行destroy，就是cleanup</span>\n          <span class=\"token function\">destroy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>effect<span class=\"token punctuation\">.</span>tag <span class=\"token operator\">&amp;</span> mountTag<span class=\"token punctuation\">)</span> <span class=\"token operator\">!==</span> NoHookEffect<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Mount</span>\n        <span class=\"token comment\">// 然后再执行side effect</span>\n        <span class=\"token keyword\">const</span> create <span class=\"token operator\">=</span> effect<span class=\"token punctuation\">.</span>create\n        <span class=\"token comment\">// 并且保存返回的cleanup</span>\n        effect<span class=\"token punctuation\">.</span>destroy <span class=\"token operator\">=</span> <span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token comment\">// effect 是一个链表结构，所以是一个一个执行</span>\n      effect <span class=\"token operator\">=</span> effect<span class=\"token punctuation\">.</span>next\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>effect <span class=\"token operator\">!==</span> firstEffect<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>从源码实现可以得出，</p>\n<ol>\n<li>如果没有传递 deps 依赖，那么在每次 render 后都会被执行，如果传递了 deps，则会与上一次 deps 的值进行 <a href=\"https://github.com/facebook/react/blob/v16.9.0/packages/shared/objectIs.js#L14-L18\">is</a> 比较，不相等才会被触发，如果传递<code class=\"language-text\">[]</code>，只会触发执行一次</li>\n<li>它的执行顺序是这样的，render（render 阶段触发） -> clean up（commit 阶段触发） -> side effect（commit 阶段触发）</li>\n<li>由于每次 render 时，function component 每次都会重新执行，它内部定义的变量每次都会重新定义，如果被 effect 引用了，则保存的就是那被定义的那次的值</li>\n<li>cleanup 的执行是在下一个 effect 里被执行，所以它里面引用的变量值跟下一个 effect 里的是不同的。</li>\n</ol>\n<p>使用建议如下，</p>\n<ol>\n<li>\n<p>添加正确的 deps，可以避免 effect 无意义的执行，或者避免一些 bug</p>\n</li>\n<li>\n<p>每次 render 时，function 里定义的变量都是独立的，没有任何值的关联（除非使用 useRef 或者定义在 function 外部），应该将每次 render 独立对待思考</p>\n</li>\n<li>\n<p>对于将 function 作为 deps 时，需要额外注意，由于是 <a href=\"https://github.com/facebook/react/blob/v16.9.0/packages/shared/objectIs.js#L14-L18\">is</a> 比较，function 每次定义都不相等，所以需要使用到<code class=\"language-text\">useCallback</code>。</p>\n</li>\n<li>\n<p>对于 effect 内部执行异步方法时，需要考虑竞态问题（上一次 effect 里的异步方法在当前 effect 里的异步方法后面返回），解决方法是增加一个变量判断是否 unmount 了，如下</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n <span class=\"token keyword\">let</span> didUnmount <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n\n <span class=\"token function\">doSomething</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n   <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>didUnmount<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n     <span class=\"token comment\">// 说明已经重新render了，数据可能是旧的（或者错误的），不需要在处理了</span>\n     <span class=\"token keyword\">return</span>\n   <span class=\"token punctuation\">}</span>\n <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n   didUnmount <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n</li>\n</ol>\n\n        <h2 id='toc-2-2' >\n          useCallback\n        </h2>\n      \n<p>上面说过，如果 function 作为<code class=\"language-text\">useEffect</code>的 deps，会导致一些依赖失效，因为 function 是引用类型，每次在重新定义时，它的值就是不相同的。在 function 作为 props 传递给子组件时，同样会有这个问题。这个时候，为了解决这个问题，我们需要保持 function 值不变（就是同一个引用），有如下两种方法，</p>\n<ol>\n<li>将 function 定义到组件外部，所以 function 一经定义就不会再变了，如果定义在组件外部就只能通过传参来引用组件内部变量了</li>\n<li>使用<code class=\"language-text\">useCallback</code>来包裹，通过添加必要的 deps，来保持不变，如果 deps 变了，则 function 值就变了，否则不变</li>\n</ol>\n<p>使用方式如下，</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> handlerClick <span class=\"token operator\">=</span> <span class=\"token function\">useCallback</span><span class=\"token punctuation\">(</span>\n  <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// your function implement</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token comment\">/* [deps] */</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>简单分析一下它的源码实现，</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">function</span> mountCallback<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>callback<span class=\"token punctuation\">:</span> <span class=\"token constant\">T</span><span class=\"token punctuation\">,</span> deps<span class=\"token punctuation\">:</span> <span class=\"token builtin\">Array</span><span class=\"token operator\">&lt;</span>mixed<span class=\"token operator\">></span> <span class=\"token operator\">|</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token constant\">T</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> hook <span class=\"token operator\">=</span> <span class=\"token function\">mountWorkInProgressHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> nextDeps <span class=\"token operator\">=</span> deps <span class=\"token operator\">===</span> undefined <span class=\"token operator\">?</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">:</span> deps\n  <span class=\"token comment\">// 将callback和deps存起来</span>\n  hook<span class=\"token punctuation\">.</span>memoizedState <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>callback<span class=\"token punctuation\">,</span> nextDeps<span class=\"token punctuation\">]</span>\n  <span class=\"token comment\">// 并直接返回callback</span>\n  <span class=\"token keyword\">return</span> callback\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>在首次 mount 时，只是使用数组将 callback 和 deps 保存起来，并直接返回 callback，接着看下 update 场景的实现，</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">function</span> updateCallback<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>callback<span class=\"token punctuation\">:</span> <span class=\"token constant\">T</span><span class=\"token punctuation\">,</span> deps<span class=\"token punctuation\">:</span> <span class=\"token builtin\">Array</span><span class=\"token operator\">&lt;</span>mixed<span class=\"token operator\">></span> <span class=\"token operator\">|</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token constant\">T</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> hook <span class=\"token operator\">=</span> <span class=\"token function\">updateWorkInProgressHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> nextDeps <span class=\"token operator\">=</span> deps <span class=\"token operator\">===</span> undefined <span class=\"token operator\">?</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">:</span> deps\n  <span class=\"token comment\">// 取出上一次存的值，是一个数组，</span>\n  <span class=\"token keyword\">const</span> prevState <span class=\"token operator\">=</span> hook<span class=\"token punctuation\">.</span>memoizedState\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>prevState <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nextDeps <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// index 0 保存是callback，index 1保存是deps</span>\n      <span class=\"token keyword\">const</span> prevDeps<span class=\"token punctuation\">:</span> <span class=\"token builtin\">Array</span><span class=\"token operator\">&lt;</span>mixed<span class=\"token operator\">></span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">=</span> prevState<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>\n      <span class=\"token comment\">// 如果deps相同，则直接返回上次存的callback，</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">areHookInputsEqual</span><span class=\"token punctuation\">(</span>nextDeps<span class=\"token punctuation\">,</span> prevDeps<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> prevState<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// 如果deps不相同，则将新的callback和deps存起来</span>\n  hook<span class=\"token punctuation\">.</span>memoizedState <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>callback<span class=\"token punctuation\">,</span> nextDeps<span class=\"token punctuation\">]</span>\n  <span class=\"token comment\">// 返回新的callback</span>\n  <span class=\"token keyword\">return</span> callback\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>在 update 实现中，会取出上一次存的 callback 和 deps，通过对比 deps 是否相同，如果是，则直接返回上一次的 callback。</p>\n<p>从实现可以得出，</p>\n<ol>\n<li>\n<p>如果没有传递 deps 依赖，那么<code class=\"language-text\">useCallback</code>每次返回的都是当前传入的 callback，这样使用没有任何意义。如果传递了 deps，则会与上一次 deps 的值进行 <a href=\"https://github.com/facebook/react/blob/v16.9.0/packages/shared/objectIs.js#L14-L18\">is</a> 比较，如果相等直接返回上一次的 callback。如果传递<code class=\"language-text\">[]</code>，那么<code class=\"language-text\">useCallback</code>返回的总是第一次 mount 中传入的 callback，后面都不会再变化</p>\n</li>\n<li>\n<p><code class=\"language-text\">useCallback</code>并不关心 callback 是否相同，只是根据 deps 来判断是否返回上一次的 callback</p>\n</li>\n</ol>\n<p>使用建议，</p>\n<ol>\n<li>\n<p>如果 callback 里有引用了组件内部的一些变量（包括 props 参数），则需要将这些变量作为 deps，避免 deps 不正确导致 callback 里引用的变量值不正确，特别是 props 参数引用，比如</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// deps 不正确</span>\n<span class=\"token keyword\">const</span> handlerClick <span class=\"token operator\">=</span> <span class=\"token function\">useCallback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n <span class=\"token comment\">// do something</span>\n\n props<span class=\"token punctuation\">.</span><span class=\"token function\">onSave</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n</li>\n<li>\n<p>不需要过渡使用，某些场景下<code class=\"language-text\">useCallback</code>的 deps 可能在每次 render 时都不一样，会导致得到的 callback 每次都不一样，而这种场景使用<code class=\"language-text\">useCallback</code>会适得其反，比如</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// 过度使用例子</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>count<span class=\"token punctuation\">,</span> setCount<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> handlerClick <span class=\"token operator\">=</span> <span class=\"token function\">useCallback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n <span class=\"token function\">setCount</span><span class=\"token punctuation\">(</span>count <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>count<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></code></pre></div>\n</li>\n</ol>\n\n        <h2 id='toc-2-3' >\n          useMemo\n        </h2>\n      \n<p>跟<code class=\"language-text\">useCallback</code>类型，但是不同的是，<code class=\"language-text\">useMemo</code>返回的是 callback 执行之后的结果，而不是<code class=\"language-text\">useCallback</code>中返回的 callback。它的使用方式如下，</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> cacheResult <span class=\"token operator\">=</span> <span class=\"token function\">useMemo</span><span class=\"token punctuation\">(</span>\n  <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> result\n    <span class=\"token comment\">// do something, then return result</span>\n    <span class=\"token keyword\">return</span> result\n  <span class=\"token punctuation\">}</span> <span class=\"token comment\">/* [deps] */</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>简单分析一下它的源码实现，</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">function</span> mountMemo<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>\n  <span class=\"token function-variable function\">nextCreate</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token constant\">T</span><span class=\"token punctuation\">,</span>\n  deps<span class=\"token punctuation\">:</span> <span class=\"token builtin\">Array</span><span class=\"token operator\">&lt;</span>mixed<span class=\"token operator\">></span> <span class=\"token operator\">|</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token constant\">T</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> hook <span class=\"token operator\">=</span> <span class=\"token function\">mountWorkInProgressHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> nextDeps <span class=\"token operator\">=</span> deps <span class=\"token operator\">===</span> undefined <span class=\"token operator\">?</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">:</span> deps\n  <span class=\"token comment\">// 这里存的是callback执行之后的值</span>\n  <span class=\"token keyword\">const</span> nextValue <span class=\"token operator\">=</span> <span class=\"token function\">nextCreate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  hook<span class=\"token punctuation\">.</span>memoizedState <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>nextValue<span class=\"token punctuation\">,</span> nextDeps<span class=\"token punctuation\">]</span>\n  <span class=\"token keyword\">return</span> nextValue\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">function</span> updateMemo<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>\n  <span class=\"token function-variable function\">nextCreate</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token constant\">T</span><span class=\"token punctuation\">,</span>\n  deps<span class=\"token punctuation\">:</span> <span class=\"token builtin\">Array</span><span class=\"token operator\">&lt;</span>mixed<span class=\"token operator\">></span> <span class=\"token operator\">|</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token constant\">T</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> hook <span class=\"token operator\">=</span> <span class=\"token function\">updateWorkInProgressHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> nextDeps <span class=\"token operator\">=</span> deps <span class=\"token operator\">===</span> undefined <span class=\"token operator\">?</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">:</span> deps\n  <span class=\"token keyword\">const</span> prevState <span class=\"token operator\">=</span> hook<span class=\"token punctuation\">.</span>memoizedState\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>prevState <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Assume these are defined. If they're not, areHookInputsEqual will warn.</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nextDeps <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> prevDeps<span class=\"token punctuation\">:</span> <span class=\"token builtin\">Array</span><span class=\"token operator\">&lt;</span>mixed<span class=\"token operator\">></span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">=</span> prevState<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">areHookInputsEqual</span><span class=\"token punctuation\">(</span>nextDeps<span class=\"token punctuation\">,</span> prevDeps<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> prevState<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// 同样，保存的也是callback执行之后的值</span>\n  <span class=\"token keyword\">const</span> nextValue <span class=\"token operator\">=</span> <span class=\"token function\">nextCreate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  hook<span class=\"token punctuation\">.</span>memoizedState <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>nextValue<span class=\"token punctuation\">,</span> nextDeps<span class=\"token punctuation\">]</span>\n  <span class=\"token keyword\">return</span> nextValue\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>与<code class=\"language-text\">useCallback</code>的实现基本一样，只是它保存的是 callback 执行之后的值，而并不是 callback 本身。<code class=\"language-text\">useCallback</code>可以直接使用<code class=\"language-text\">useMemo</code>来实现如下，</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> handlerClick <span class=\"token operator\">=</span> <span class=\"token function\">useMemo</span><span class=\"token punctuation\">(</span>\n  <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// your function implement</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token comment\">/* [deps] */</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>通过分析可以得出，</p>\n<ol>\n<li><code class=\"language-text\">useMemo</code>定义时会立即执行 callback 得到结果，而<code class=\"language-text\">useCallback</code>并不会立即执行 callback</li>\n</ol>\n\n        <h2 id='toc-2-4' >\n          小结\n        </h2>\n      \n<p>本次分析了 React Hooks 中最常见，也最容易误用的三个 Hooks，<code class=\"language-text\">useEffect</code>，<code class=\"language-text\">useCallback</code>，<code class=\"language-text\">useMemo</code>。通过简单的源码分析，了解它们的实现方式，得出一些结论，然后给出了一些使用建议。最后，给出如下两条通用性建议，</p>\n<ol>\n<li>强烈建议使用<a href=\"https://www.npmjs.com/package/eslint-plugin-react-hooks\">eslint-plugin-react-hooks</a>，并开启 error level，这样可以避免很多错误的 deps</li>\n<li>不确定是否需要使用<code class=\"language-text\">useEffect</code>，<code class=\"language-text\">useCallback</code>，<code class=\"language-text\">useMemo</code>时，就不要用，不用可能只有性能问题，错误使用可能就会产生业务逻辑问题</li>\n</ol>\n\n        <h2 id='toc-2-5' >\n          参考\n        </h2>\n      \n<ol>\n<li><a href=\"https://github.com/facebook/react/tree/v16.9.0\">react v16.9.0 源码</a></li>\n<li><a href=\"https://overreacted.io/a-complete-guide-to-useeffect/\">https://overreacted.io/a-complete-guide-to-useeffect/</a></li>\n</ol>","tableOfContents":"<ul><li><a href=\"#toc-2-1\">useEffect</a></li><li><a href=\"#toc-2-2\">useCallback</a></li><li><a href=\"#toc-2-3\">useMemo</a></li><li><a href=\"#toc-2-4\">小结</a></li><li><a href=\"#toc-2-5\">参考</a></li></ul>","frontmatter":{"title":"React Hooks 分享","date":"February 19, 2021","tags":["react"],"zan":null}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/post/2021/guide_to_react_hooks/","previous":{"fields":{"slug":"/post/2021/summary_of_2020/"},"frontmatter":{"title":"2020年小结"}},"next":null}}