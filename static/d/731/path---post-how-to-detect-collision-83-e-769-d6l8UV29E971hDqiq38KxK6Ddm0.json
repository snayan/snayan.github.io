{"data":{"avatar":{"childImageSharp":{"fixed":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGAABAAMBAAAAAAAAAAAAAAAAAAIEBQP/xAAWAQEBAQAAAAAAAAAAAAAAAAACAQD/2gAMAwEAAhADEAAAAcSerUQpOzXUqiMAb//EABsQAAMAAgMAAAAAAAAAAAAAAAABAhESAxQh/9oACAEBAAEFAjzJ1VJcZepyU9x0z//EABURAQEAAAAAAAAAAAAAAAAAABEg/9oACAEDAQE/AWP/xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/AR//xAAbEAADAAIDAAAAAAAAAAAAAAAAASEQERIxMv/aAAgBAQAGPwImPUNtcTodiz//xAAcEAACAgMBAQAAAAAAAAAAAAAAAREhMUFRYXH/2gAIAQEAAT8hWbK7l6NWStvasZEW4S7fwfTTAkNzkQZ//9oADAMBAAIAAwAAABAs1wP/xAAXEQEBAQEAAAAAAAAAAAAAAAABABEQ/9oACAEDAQE/EMLbwL//xAAXEQEBAQEAAAAAAAAAAAAAAAABEQAQ/9oACAECAQE/EIzR4rv/xAAfEAEAAwACAQUAAAAAAAAAAAABABEhMUFRYXGBodH/2gAIAQEAAT8QAjVRsF68R3WyhBpEB4otans9oxQXOZRxVfkow9YivuDFJrEfPmaECm2kqIiV2XP/2Q==","width":40,"height":40,"src":"/static/9d156e8486b343189790da372acb0018/987ea/my.jpg","srcSet":"/static/9d156e8486b343189790da372acb0018/987ea/my.jpg 1x,\n/static/9d156e8486b343189790da372acb0018/9c097/my.jpg 1.5x,\n/static/9d156e8486b343189790da372acb0018/bd6c6/my.jpg 2x"}}},"site":{"siteMetadata":{"title":"三洋的小站","author":"三洋"}},"markdownRemark":{"id":"fa6b6f53-e174-5aeb-bebf-d9d267173e7e","excerpt":"这篇是学习和回顾 canvas 系列笔记的第六篇，完整笔记详见：canvas 核心技术。在上一篇canvas…","html":"<p>这篇是学习和回顾 canvas 系列笔记的第六篇，完整笔记详见：<a href=\"/post/core_html5_canvas/\">canvas 核心技术</a>。</p>\n<p>在上一篇<a href=\"/post/how_to_implement_complex_animations/\">canvas 核心技术-如何实现复杂的动画</a>笔记中，我们详细讨论了在制作复杂动画时，需要考虑时间因素，物理因素等，同时还回顾了如何使用缓动函数来扭曲时间轴实现非线性运动，比如常见的缓入，缓出，缓入缓出等。在游戏或者动画中，运动的物体在变化的过程中，它们是有可能碰撞在一起的，那么这一篇我们就来详细学习下如何进行碰撞检测。</p>\n<h3>边界值检测</h3>\n<p>最简单的检测手段就是边界值检测了，就是对一个运动的物体的某些属性进行条件判断，如果达到了这个条件，则说明发生了碰撞。例如在上一篇中的示例，小球自由下落，当在检测小球是否与地面发生碰撞时，我们是检测小球下落的高度 fh 是否达到了小球本身距离地面的高度 dh，如果 fh > dh，则说明小球与地面发生了碰撞。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">let</span> distance <span class=\"token operator\">=</span> ball<span class=\"token punctuation\">.</span>currentSpeed <span class=\"token operator\">*</span> t\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ball<span class=\"token punctuation\">.</span>offset <span class=\"token operator\">+</span> distance <span class=\"token operator\">></span> ball<span class=\"token punctuation\">.</span>verticalHeight<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">//落到地面了，发生了碰撞</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 还没有落到地面，没有发生碰撞</span>\n  ball<span class=\"token punctuation\">.</span>offset <span class=\"token operator\">+=</span> distance\n<span class=\"token punctuation\">}</span></code></pre></div>\n<!--more-->\n<p><a href=\"https://snayan.github.io/canvas-demo/?module=free_fall\">这里是我的小球自由落体完整在线示例</a></p>\n<p>这种检测方式非常的简单且准确，在针对类似业务开发时，我们可以简化成边界值检测。但是当我们开发较为复杂游戏时，边界值检测通常不能很好的实现，为了更加真实，它通常与其他检测方法一起使用。</p>\n<h3>外接图形检测</h3>\n<p>在 canvas 游戏中，对于不规则的物体，比如运动的小人等，我们可以通过抽象成一个矩形，使得这个矩形恰好可以包裹这个物体，在进行碰撞检测时，就可以使用这个矩形来代替实际的物体。这种方法，实际上就是通过抽象，将复杂简单化，对于精确度不是那么高的动画或者游戏，我们直接使用这种外接图形来检测就可以了。在抽象图形的时候，我们要根据具体的物体，比如小人可以抽象成矩形，太阳就要抽象成圆了，把具体的物体抽象的跟它相似的形状，这样在检测时就会更加准确。</p>\n<p>进行了图形抽象之后，我们在检测就只需对图形进行检测了。对于两个图形是否发生碰撞，我们只需要判断它们是否存在相交的部分，如果存在相交的部分，那么则可以认为是发生了碰撞，否则就没有。下面，我们分别来学习矩形和矩形的碰撞检测，圆和圆的碰撞检测，矩形和圆的碰撞检测。</p>\n<p>矩形与矩形碰撞情况，</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/021a715ec6d28ef7020269ad140b05c4/44e11/rect_rect.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 46.128500823723236%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAACvElEQVQoz2No2OirWX9BTr31OpdSxyozkWWpURzh3Yc0vbqeqju1/VNiQAKn/zMwt95lUWq4IKdae15VEiZuU/9f1KXth6J/3zU1hoYbosp5a3LlY1bNMEtYNd0us+k/p1vvS9Ws5bWKyRubPEpP2GvM/snAKhv2ny1q6RKTpPXtzunzuiQarkiqgQxrvC4ikbKpwbtwb4hGUs12XobWO6wKsUDD8vZFaaZvL9Jw7/gi5dLxXSF7T4pF8Jy9JgVH/CU67jNIWVT+l8nbHymRtTvDKnrFfO32+wwKwbMOMTVeE1UNnHVML/9guIXn1DsCDIv/M7DHr55sm7ktTzNu6iol74m3lRQi/7NmbM93ils2U61il6tiy20OGbum/wqxCxcIpq1osU5c12W++T8Dq3Xxf8aG6+IaqYt65HN2pHl4T7oDC4b/TJaV/yWcm/7JO7X+5QeJbPvPwNH7lEGy9Qan/Px/DOzO7b/4PXpfKJqX/JeWDvvPDgu/mosqcp33GOSnvGcQAwvUXVSQqT+rpFN/RVax7R6T0qyfDLwurb9kfXvu6Hr0PVewb/6v4NL5VQBs7X8GhvbrrLpTXjDwgPhZW3MYQbR16X8J1/q/6hAbzmlqJCyZbuU95ZYW0OsmE98ySPj039HJ255oXX1RUz11U60R0HXSQl7/mWKWzVfN3x3jm7yxUU879z8HSH/TLX6huOXTHWKWzHetvS4nzFB20kbVb/oFXcuc/2LBMw6azP/PIBAyb6d29UUNrVnPGYSLDvkZm1X8FwR6VyFw5nG32FUzgyJmbw4DJis9sA8vKdrl7o8JydmdFFRz1NCRoe6ygmrKpkajiFlbjdM3VRhNeMsg7tb1US19a5lJyV4/w7gVM/SBXpYGaS467CdQfUHLquKEpQyIn3ciEOxl3ylXtX0nXzOq2eTCAgAu6BLSdwABiAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"rect_rect\"\n        title=\"\"\n        src=\"/static/021a715ec6d28ef7020269ad140b05c4/b9e4f/rect_rect.png\"\n        srcset=\"/static/021a715ec6d28ef7020269ad140b05c4/cf440/rect_rect.png 148w,\n/static/021a715ec6d28ef7020269ad140b05c4/d2d38/rect_rect.png 295w,\n/static/021a715ec6d28ef7020269ad140b05c4/b9e4f/rect_rect.png 590w,\n/static/021a715ec6d28ef7020269ad140b05c4/f9b6a/rect_rect.png 885w,\n/static/021a715ec6d28ef7020269ad140b05c4/2d849/rect_rect.png 1180w,\n/static/021a715ec6d28ef7020269ad140b05c4/44e11/rect_rect.png 1214w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </span>\n  </a></p>\n<p>这里列举两个矩形发生碰撞的所有情况，在 canvas 中具体代码实现如下，</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/* 判断是否两个矩形发生碰撞 */</span>\n<span class=\"token keyword\">private</span> <span class=\"token function\">didRectCollide</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">sprite<span class=\"token punctuation\">:</span> RectSprite<span class=\"token punctuation\">,</span> otherSprite<span class=\"token punctuation\">:</span> RectSprite</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> horizontal <span class=\"token operator\">=</span> sprite<span class=\"token punctuation\">.</span>left <span class=\"token operator\">+</span> sprite<span class=\"token punctuation\">.</span>width <span class=\"token operator\">></span> otherSprite<span class=\"token punctuation\">.</span>left <span class=\"token operator\">&amp;&amp;</span> sprite<span class=\"token punctuation\">.</span>left <span class=\"token operator\">&lt;</span> otherSprite<span class=\"token punctuation\">.</span>left <span class=\"token operator\">+</span> otherSprite<span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> vertical <span class=\"token operator\">=</span> sprite<span class=\"token punctuation\">.</span>top <span class=\"token operator\">&lt;</span> otherSprite<span class=\"token punctuation\">.</span>top <span class=\"token operator\">+</span> otherSprite<span class=\"token punctuation\">.</span>height <span class=\"token operator\">&amp;&amp;</span> sprite<span class=\"token punctuation\">.</span>top <span class=\"token operator\">+</span> sprite<span class=\"token punctuation\">.</span>height <span class=\"token operator\">></span> otherSprite<span class=\"token punctuation\">.</span>top<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> horizontal <span class=\"token operator\">&amp;&amp;</span> vertical<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>其实就是分别在水平方向和垂直方向判断这两个矩形是否发生重叠。</p>\n<p>圆和圆碰撞情况，</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b27fa0837a69a17b2ef1367bafc49b05/59a95/circle_circle.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 416px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 63.22115384615385%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsSAAALEgHS3X78AAADM0lEQVQ4y12SaUxTQRDHFwoCMRIVIRWicsgVxKiJBhSLUNLy1koBkdZiCIJRI0jwKMghogLKTRWNGCMiJhA+qPGDX4zhg+IdoiJ4IKVUgbTSvqZgrS3tuO9RTMMk/8zszM5vdt9bBABxdrt9bnp62jo5OWFVjY9b9XqdVaPRWHQ6nUWlGrN8H1VaaJq2KJVKC5Nn9mq02jmNRmuemJgAm832FBGbnZ11RQSY+MdsArCTyArwU61lYzvYYHbGCOa/f8E4MwOM0Xo9GI3zsWmGBlqnBYd9YIDEs0B/0y848oMerv1q6Ot4P/X4jtowWE/yR/VafdFvs0lO4lNzNigGM32Upg2nB5TGG/1f6M7nQ5rrZHYZqYscQMRa7gDCh96hrKyXSJj9BgnzXiNZ9guUhhZbxnBgRPlozjr5t1TuiZGk4FKVOLhkJBsdHAphyjE1Yy7o3GCIvObTRsHiXoUuekvNaGjJFNR5MWvJ3T+81HZ94W0AT+d9FQ+0y8VXfxRTLepdbKJyMEjI+BMPoziM35ubuDolUxDhgi5653dtkuR3RFUnJhyW4aonCsyPW4u3hwfgtKxwfLLTAxvAZQGMW9UlRL7sIq9pqyvjk3akrBMkiE4J+SIBRWExL0rCP6yIrE8tq69PlsrzMS+aj5OFu7GAn4mTdh5gQZcG3BzAGCIpCyzuC3N3gDcc74nmMXEvIG/mGzcZUaqs91Hztg7gSgHcKQN4UQBLcNEtCZVT4XxCH6JmdlGr8SdT2l1K+0N9Sl+ERpLrryl/G7K+4EHSiguflx6Qdva28cohXNT4KgDXfQzGZ+4H4SuTYVi0xwPnnWdvh1vG/QjwMirsjWaniDMFK/kx4tVxYfsCtvnKPBYmV4945qXffCYTNOhi2cZ0GQfHb1mDY9evxZgKwgXXvBzAeAJMZ35KBpPoIm+yweTHaZpbxWm0rGKnnv0Yklw1zJWQF+a6W6GsxK0q9ntR3eBGtencqB7gzMPG3AisjGgZAzy2AHU2kkuuHAw8KbvXPd/UqtpEGsqJuM77yMm4jvxm52YxUSvRGSI5kYJIulDf/x+qDiQ6S9RAVODwlUzeUXf9B3IPv0bauQfzAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"circle_circle\"\n        title=\"\"\n        src=\"/static/b27fa0837a69a17b2ef1367bafc49b05/59a95/circle_circle.png\"\n        srcset=\"/static/b27fa0837a69a17b2ef1367bafc49b05/cf440/circle_circle.png 148w,\n/static/b27fa0837a69a17b2ef1367bafc49b05/d2d38/circle_circle.png 295w,\n/static/b27fa0837a69a17b2ef1367bafc49b05/59a95/circle_circle.png 416w\"\n        sizes=\"(max-width: 416px) 100vw, 416px\"\n      />\n  </span>\n  </a></p>\n<p>判断两个圆是否发生碰撞，就是判断两个圆的圆心之间的距离是否小于它们的半径之和，如果小于半径之和，则发生碰撞，否则就没有发生碰撞。主要就是计算两个圆心之间的距离，可以根据坐标系中两点之间距离公式得到，</p>\n<p>$$\n|AB| = \\sqrt{(x<em>1-x</em>2)^2 + (y_1-y2)^2}\n$$</p>\n<p>在 canvas 中具体代码实现如下，</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/* 判断是否两个圆发生碰撞 */</span>\n<span class=\"token keyword\">private</span> <span class=\"token function\">didCircleCollide</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">sprite<span class=\"token punctuation\">:</span> CircleSprite<span class=\"token punctuation\">,</span> otherSprite<span class=\"token punctuation\">:</span> CircleSprite</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">distance</span><span class=\"token punctuation\">(</span>sprite<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">,</span> sprite<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">,</span> otherSprite<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">,</span> otherSprite<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> sprite<span class=\"token punctuation\">.</span>radius <span class=\"token operator\">+</span> otherSprite<span class=\"token punctuation\">.</span>radius<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>矩形和圆碰撞情况，</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d85889d3d0b988f032d5297b8cea1e7f/75624/rect_circle.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 260px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 101.15384615384615%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAALEgHS3X78AAAD9klEQVQ4y51UUUxbVRj+T6HNEJmZbIXS2dGVdhRcQ7Wt3VBBN+MeTHjRxOAWHnQmhMjDZLK6tljoPedeUDe3iXGQLC5MrbS01A2cZeDmyEIIlHYUhclW4Jb4oDGaLFn24PXc261pmDNuJ/lzTs/9znf+//zfV4A1Awd5JM7MAF9CQvxL3CD/AhPkrXe+wQMN8QAeWJHWlMj+du/KRtibXNcV5iu9A/zm7AvvO14RAMbadKi/V4lciwpELu2ViftsOGlz9s3qGz8ZV9G1lQnNbZIIL9fLSBwQiQFiZgF9fCUXXXYYpN/tP/3HRcQjKJjQbVvH2Zs7cZ+w+X+XuVWAnKkWMJz9HLa4kqBhozItG5Vrnaug/uqLDYbvGHNV659QzE0ptDSzUhxLB82olLkq1x6ZAM1MM+jJLKjax1sQuBPmyt7TBxzdX3tfa1tYZ2BjoKOkemcSdL5TxdsvusqePpQCHTeN9JSkTIo4jRm53nsNtnw0Vm31c+0NeErzOk5CHpDvu/cfHj1mcfgEDfnm76oHamKP8AgO3HzWOSQU4cjJBhw5UgLsGNP0ZuBlI2wX5Gx4seb94fdkbALAuQTId6oI/eDWIcdKLiIjHhkedclwTIbwSKfUOBK6YfIEZrZaGinhxI5deGh4N+BIdwMZOfoM9t+uxMGlqrvyIcFURkpslv6IKK070qGzhgkmd9YdEOR4pKseDwfLAUcLjThyvBbTkrP1uFbIdF1GQ3sPZnBeR/oFM/5x36vkuviGcaggK7BB+njlRbSG5O5so64x0tlEI1NFNpYkoArHFOsBx1AFjhaopc2ZfFgL9vj5gg/D/FO7mBvKTY2LeZ1h3tIR4NdncKPuHOlsHCx4WvlYOsM4qKTNGNyTnavnIuDQanX7lwlDh++aHodSdktRGkP9nrEhntxWy94CBWBK2DklkzL0zANio9RW8XRQm0kHPEMLj3b1J6q5wLzdM3w1TyIY6ZI67f12spDz37Jxo+59zLnzO4CN5lQ0/yUvhIccXOAP2+5OIf+dCftz3LlIHbRdB2OoB2yXONjoWgIVvUBNs1PT8tXUYmox+4O/QfEQtpsGTpjKHasiBomYEhLNfcI7eqbuxHH3k8fOmJs6LkT2QMvCW8rTJw81f+ZrfaNtIb+CWq+cNspICaWgljM6UmA4z2ms/p4iMxX8NvosRhyTG9lZMHwwWW/51Hd0f19va5Mr8osVSOD32ncHhFJnUNATn2B62NKty4Ii/Qbh5RrLwcnH9+DpAm4w+bxoPfKzJAOpMdwUQq2/AoowWhTsVqHDy2LjEMKxXMTOAfKMuzKddl2YQ6I8arjBlJIK13A/0f7r/2UWJhv/DwmE4i8WE7XcAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"rect_circle\"\n        title=\"\"\n        src=\"/static/d85889d3d0b988f032d5297b8cea1e7f/75624/rect_circle.png\"\n        srcset=\"/static/d85889d3d0b988f032d5297b8cea1e7f/cf440/rect_circle.png 148w,\n/static/d85889d3d0b988f032d5297b8cea1e7f/75624/rect_circle.png 260w\"\n        sizes=\"(max-width: 260px) 100vw, 260px\"\n      />\n  </span>\n  </a></p>\n<p>这种情况，就是判断圆形到矩形上最近的一点的距离是否小于圆的半径，如果小于圆的半径，则发生碰撞，否则就没有发生碰撞。我们首先要找到圆距离矩形上最近的点的坐标，这种就要考虑圆心在矩形左侧，圆心在矩形上面，圆心在矩形右侧，圆心在矩形下面，圆心在矩形里面这五种情况。如果圆心在矩形里面，那么一定是碰撞的。其他四种情况根据每一种情况来计算得到矩形上离圆心最近的一点，下面举例其中一种情况，其他情况原理类似，比如圆心在矩形左侧，</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/439ef263b5a5e41bf8685b5f1b0dfb91/10448/rect_circle_left.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 313px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 74.4408945686901%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAAB+0lEQVQ4y2NgAILW9U8429Y/sW7f8NSmbf1TdZBY8/E4po7zrIztlxgI44sINkgvQ8eGJ8q1q57KAZmMHetvWWRv/8/JQAkAuk6gbd1j0/qNL9SnzL9otHaqjkbdPQa5jvNM8m0XGeTbLhHG7RCsADIM4sr1d/iaNv2Xmr24SGbuZma72ocMYkAD5YCKZIjAskBviwNpI4b2jY8Y2jdADV39Ra1lz26buhNt7mT59CKDMMiFTBAXPlCu2vhfsS1XU2zuwuoMpwf/WcGKThkQEzFgM4C0FNz0jvXXOVrWfTZoW7/MoGdbaxRIbNUtBniQ4AOw2AV6WxKUZEQ6Njw1aN34RLxz5n/W5n2r9OuuK+mAFNRfdGQkxqsoBgLDzzZt2nWB9tU3zdtXfhU9MoGBa+EaXgOQgkVrmBhJdiHIQKOKGxxta+4aNK//I7V5CoPA8kVSRiAFC1cLMQEDGqSBEGaEGiwJCiMZYMI2atvwWAUkWPSPgbP2HoMGObEMdKEYmJG34AGYbl7zX6h/c4XihOMMRhUPxVg7LjDwAm3lJgKD1LECsSrIhRDnrnuoXL/lvdbMWfvs5y4LCap7zKAMzMvaQFu1COJLYKwJZOvDk0XnxicmEsln2crmXZBsX/dZn5J8DKNVgUnIDEhbtm+4C06gbfsaQSUJAykYAMJ0RLxDjoiyAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"rect_circle_left\"\n        title=\"\"\n        src=\"/static/439ef263b5a5e41bf8685b5f1b0dfb91/10448/rect_circle_left.png\"\n        srcset=\"/static/439ef263b5a5e41bf8685b5f1b0dfb91/cf440/rect_circle_left.png 148w,\n/static/439ef263b5a5e41bf8685b5f1b0dfb91/d2d38/rect_circle_left.png 295w,\n/static/439ef263b5a5e41bf8685b5f1b0dfb91/10448/rect_circle_left.png 313w\"\n        sizes=\"(max-width: 313px) 100vw, 313px\"\n      />\n  </span>\n  </a></p>\n<p>这种情况下，最近一点的 X 轴坐标跟矩形左上角坐标的 X 轴坐标相等，跟圆心 Y 轴坐标相等，这样就可以得出来了，$(rect<em>x,circle</em>y)$。在 canvas 中具体代码实现如下，</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/* 判断是否矩形和圆形发生碰撞 */</span>\n<span class=\"token keyword\">private</span> <span class=\"token function\">didRectWidthCircleCollide</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">rectSprite<span class=\"token punctuation\">:</span> RectSprite<span class=\"token punctuation\">,</span> circleSprite<span class=\"token punctuation\">:</span> CircleSprite</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> closePoint <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> x<span class=\"token punctuation\">:</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">:</span> <span class=\"token keyword\">undefined</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>circleSprite<span class=\"token punctuation\">.</span>x <span class=\"token operator\">&lt;</span> rectSprite<span class=\"token punctuation\">.</span>left<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    closePoint<span class=\"token punctuation\">.</span>x <span class=\"token operator\">=</span> rectSprite<span class=\"token punctuation\">.</span>left<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>circleSprite<span class=\"token punctuation\">.</span>x <span class=\"token operator\">&lt;</span> rectSprite<span class=\"token punctuation\">.</span>left <span class=\"token operator\">+</span> rectSprite<span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    closePoint<span class=\"token punctuation\">.</span>x <span class=\"token operator\">=</span> circleSprite<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    closePoint<span class=\"token punctuation\">.</span>x <span class=\"token operator\">=</span> rectSprite<span class=\"token punctuation\">.</span>left <span class=\"token operator\">+</span> rectSprite<span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>circleSprite<span class=\"token punctuation\">.</span>y <span class=\"token operator\">&lt;</span> rectSprite<span class=\"token punctuation\">.</span>top<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    closePoint<span class=\"token punctuation\">.</span>y <span class=\"token operator\">=</span> rectSprite<span class=\"token punctuation\">.</span>top<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>circleSprite<span class=\"token punctuation\">.</span>y <span class=\"token operator\">&lt;</span> rectSprite<span class=\"token punctuation\">.</span>top <span class=\"token operator\">+</span> rectSprite<span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    closePoint<span class=\"token punctuation\">.</span>y <span class=\"token operator\">=</span> circleSprite<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    closePoint<span class=\"token punctuation\">.</span>y <span class=\"token operator\">=</span> rectSprite<span class=\"token punctuation\">.</span>top <span class=\"token operator\">+</span> rectSprite<span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">distance</span><span class=\"token punctuation\">(</span>circleSprite<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">,</span> circleSprite<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">,</span> closePoint<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">,</span> closePoint<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> circleSprite<span class=\"token punctuation\">.</span>radius<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><a href=\"https://snayan.github.io/canvas-demo/?module=collide_01\">这里是我的外接图形碰撞检测在线示例</a>。</p>\n<h3>光线投射检测</h3>\n<blockquote>\n<p>光线投射法：画一条与物体的速度向量相重合的线，然后再从另外一个待检测物体出发，绘制第二条线，根据两条线的交点位置来判定是否发生碰撞。</p>\n</blockquote>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ee3929ae6a4c3a0fc9ec566974c52cd9/156be/light_collide.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 97.96557120500783%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAALEgHS3X78AAAD2UlEQVQ4y41TbUybVRS+0NIhmWYx+sPE/fGf2cx+qIkJy+KP1YyB8YfizDQmxiVGozPRxBkyfsh0yrIZWb9oIVPgjYk6oySGsMUFs5XS0mJLocDGVwUK/XgLvP1uL5zjuS8tH9tknuTJOffcc+99nvOelzGy5uZmZrVaRcia7C+UCf/lyMGnm7wHWjq7v9vXZul43Nh2SSfytjYbq6+vZ3q9ntXW1qpnao4d24wZIrKSmc1mbdsVi+7ce12ak6ePPvHB5cOHTrz+xv6GhoaHu6ROncFg0LC77J23392Z0P/Myi98c1HX2tr6qMlsKv+94y81f6DsZLnw1dXVFaVak8mou9L+fcXR2sPaU+aD2ppXj2hF/pXXarYYCjv31RdPdnZ2VbH/Yd39bWUfn2p4RMRvvfRp1aUtgex47XHqmfvZz5Fh2YXeE+Vmq0FrsVg0BK3RaNS0t7dXUFxhMpk0pEBr/OFrlW1L9+mnmlzP/3Tx+puHxPrlev3eurq6DSVn7c+8L/y35vNVVptFZ2i5vMdkMlf29fVpbTbbfkmS9gUCAW1vb2/lH9d+q1RuosZ67cxj5x0vfmj65exzeB01n3z20d7GxsaH6HuUPUjhnt23yyvvSflH/JLD4ZCuXv1Vcg+6pRt/3pAGBpxSaHFRohe7CNJ/4EdCR2kNAKpn4XAYFxYWcHZ2FsfHxnHQNYhOpwvX1wHTmTQqioJzc3PIOcdoRNSGMJVMYTaXw1wuj/Pz8wi4ZSwY/IcvLi7ypaUlPj4+zoeH/Xzi9m0eDAYp9nG3283tdjunB7nf5+U+n49PT03zmZkZTpfRvkc9S3dxYsmZYDc1OUks5lGOy7iysoK5fB6GhjwQXgoTmyTG43FUEgnc3UAlygqFAqytrYHwvMCRFwqYz+eLJUDS14VcEJbNZlEgk8lALpcDkU+n0yIPok7UMJID9v5+6Onpgb+HhsDv98Pw8DCQHIhGIxCTZfRSfikcAdeAE71eL96iMy6nE6amp2FsbAwGB90QiUY3LlxZXcFINIKhUAhjsRhQC1S2wujVkscioGhIqtTcNiVqnvX3O4B6CHmSurEH921QEXevoXhgc495fT6Yn5uDcCSC0WgUUqkULi8vEwMO220bu02WRexYM8GMr3HMZDOYSCbUhq+urgI+8JveXwpLJBIgx2SIEURMDNXnaHxAlmWgwaZ4GajHQOOjrksyt8ndBBsNBNDj8ah/Bw02TtJMxmkeR0ZHcZQweecOTkxMoP3mLaQvSvtTuzJn1C+FXldo2hVioAgT62gspiSTSUWWNzzV7gCRuycn8C+G9FsqdBty4wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"light_collide\"\n        title=\"\"\n        src=\"/static/ee3929ae6a4c3a0fc9ec566974c52cd9/b9e4f/light_collide.png\"\n        srcset=\"/static/ee3929ae6a4c3a0fc9ec566974c52cd9/cf440/light_collide.png 148w,\n/static/ee3929ae6a4c3a0fc9ec566974c52cd9/d2d38/light_collide.png 295w,\n/static/ee3929ae6a4c3a0fc9ec566974c52cd9/b9e4f/light_collide.png 590w,\n/static/ee3929ae6a4c3a0fc9ec566974c52cd9/156be/light_collide.png 639w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </span>\n  </a></p>\n<p>光线投射法一般还会结合边界值检测来进行严格准确的判断，这种方法要求我们在动画更新中，不断计算出两个速度向量的交点坐标，根据交点坐标判断是否满足碰撞条件，交点满足了条件，我们还要运用边界值检测方法来检测运动物体是否满足边界值条件，只有同时满足才判断为发生碰撞。这种检测，准确度一般比较高，特别是适用于运动速度快的物体。以小球投桶示例，检测代码如下，</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/* 是否发生碰撞 */</span>\n<span class=\"token keyword\">public</span> <span class=\"token function\">didCollide</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">ball<span class=\"token punctuation\">:</span> CircleSprite<span class=\"token punctuation\">,</span> bucket<span class=\"token punctuation\">:</span> ImageSprite</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> k1 <span class=\"token operator\">=</span> ball<span class=\"token punctuation\">.</span>verticalVelocity <span class=\"token operator\">/</span> ball<span class=\"token punctuation\">.</span>horizontalVelocity<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> b1 <span class=\"token operator\">=</span> ball<span class=\"token punctuation\">.</span>y <span class=\"token operator\">-</span> k1 <span class=\"token operator\">*</span> ball<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> inertSectionY <span class=\"token operator\">=</span> bucket<span class=\"token punctuation\">.</span>mockTop<span class=\"token punctuation\">;</span> <span class=\"token comment\">//计算交点Y坐标</span>\n  <span class=\"token keyword\">let</span> insertSectionX <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>inertSectionY <span class=\"token operator\">-</span> b1<span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> k1<span class=\"token punctuation\">;</span> <span class=\"token comment\">//计算交点X坐标</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    insertSectionX <span class=\"token operator\">></span> bucket<span class=\"token punctuation\">.</span>mockLeft <span class=\"token operator\">&amp;&amp;</span>\n    insertSectionX <span class=\"token operator\">&lt;</span> bucket<span class=\"token punctuation\">.</span>mockLeft <span class=\"token operator\">+</span> bucket<span class=\"token punctuation\">.</span>mockWidth <span class=\"token operator\">&amp;&amp;</span>\n    ball<span class=\"token punctuation\">.</span>x <span class=\"token operator\">></span> bucket<span class=\"token punctuation\">.</span>mockLeft <span class=\"token operator\">&amp;&amp;</span>\n    ball<span class=\"token punctuation\">.</span>x <span class=\"token operator\">&lt;</span> bucket<span class=\"token punctuation\">.</span>mockLeft <span class=\"token operator\">+</span> bucket<span class=\"token punctuation\">.</span>mockWidth <span class=\"token operator\">&amp;&amp;</span>\n    ball<span class=\"token punctuation\">.</span>y <span class=\"token operator\">></span> bucket<span class=\"token punctuation\">.</span>mockTop <span class=\"token operator\">&amp;&amp;</span>\n    ball<span class=\"token punctuation\">.</span>y <span class=\"token operator\">&lt;</span> bucket<span class=\"token punctuation\">.</span>mockTop <span class=\"token operator\">+</span> bucket<span class=\"token punctuation\">.</span>mockHeight\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><a href=\"https://snayan.github.io/canvas-demo/?module=collide_02\">这里是我的光线投射检测在线示例</a>。</p>\n<h3>分离轴检测</h3>\n<p>在判断凸多边形的碰撞检测时，我们可以使用分离轴方法。在学习分离轴检测之前，我们需要先熟悉向量的一些基础知识。</p>\n<p>向量基础知识：</p>\n<ul>\n<li>在平面二维坐标系中，我们可以使用向量来表示某个点的位置。向量表示法就是从坐标原点（0，0）指向目标点（x，y） 。</li>\n<li>两个向量相减，结果是另外一条新的向量。</li>\n<li>两个向量做点积，可以得到投影的值。</li>\n<li>单位向量，就是长度为 1 的向量，其实际作用是表示方向。</li>\n<li>一个向量垂直于另外一个向量，我们叫做法向量。</li>\n</ul>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/423cbfbd7588a0c331062f0086befa24/bb59d/system.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 64.1566265060241%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA80lEQVQoz5WS22qEMBCGff+3KwixFMGSVcz5OInizf5doV0LW+13NSHzmZlxmvwgpVRKMcZIKRHgmC/QfMvruvZ937bttm3/kwERWWuVUniZfrj2MhyYQghl9CyUdzGGFHyiTFdlKaSyEkEIySg3fQzOWCp0Lmutp2kMyRMVb3Q0inL8o/+jrDS/8Zhics5KEULImU56xlhgLsvivee3zxJ9Dr7UWl5Ta0V+sw8Zc0LN3Ttj7ZuWX43LJ8QTOCJzGIau6w4yYwy/GquyJ70C4xzHkXP+u2xcIChnLA8OA8NX53m+uJ7IOWyYcw41Qz4199W7A+Fr3wFYGbujAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"system\"\n        title=\"\"\n        src=\"/static/423cbfbd7588a0c331062f0086befa24/b9e4f/system.png\"\n        srcset=\"/static/423cbfbd7588a0c331062f0086befa24/cf440/system.png 148w,\n/static/423cbfbd7588a0c331062f0086befa24/d2d38/system.png 295w,\n/static/423cbfbd7588a0c331062f0086befa24/b9e4f/system.png 590w,\n/static/423cbfbd7588a0c331062f0086befa24/f9b6a/system.png 885w,\n/static/423cbfbd7588a0c331062f0086befa24/2d849/system.png 1180w,\n/static/423cbfbd7588a0c331062f0086befa24/bb59d/system.png 1328w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </span>\n  </a></p>\n<p>图中可以看到，$\\overrightarrow{oa} -\\overrightarrow{ob} = \\overrightarrow{ba}$，$\\overrightarrow{oa} * \\overrightarrow{ob} = |od|$。多余凸多边形的每个顶点，我们可以用向量来表示。</p>\n<p>分离轴检测思路，</p>\n<ol>\n<li>先获取被检测多边形的所有的投影轴，一般只需要计算出多边形对应边的投影轴即可</li>\n<li>计算出被检测多边形在每一条投影轴上的投影</li>\n<li>判断它们的投影是否重叠，如果存在在任意一条投影轴的投影不重叠，则说明它们没有发生碰撞，否则就发生了碰撞</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">/* 判断是否发生碰撞 */</span>\n<span class=\"token keyword\">public</span> <span class=\"token function\">didCollide</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">sprite<span class=\"token punctuation\">:</span> Sprite<span class=\"token punctuation\">,</span> otherSprite<span class=\"token punctuation\">:</span> Sprite</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> axes1 <span class=\"token operator\">=</span> sprite<span class=\"token punctuation\">.</span><span class=\"token keyword\">type</span> <span class=\"token operator\">===</span> <span class=\"token string\">'circle'</span> <span class=\"token operator\">?</span> <span class=\"token punctuation\">(</span>sprite <span class=\"token keyword\">as</span> Circle<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getAxes</span><span class=\"token punctuation\">(</span>otherSprite <span class=\"token keyword\">as</span> Polygon<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span>sprite <span class=\"token keyword\">as</span> Polygon<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getAxes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> axes2 <span class=\"token operator\">=</span> otherSprite<span class=\"token punctuation\">.</span><span class=\"token keyword\">type</span> <span class=\"token operator\">===</span> <span class=\"token string\">'circle'</span> <span class=\"token operator\">?</span> <span class=\"token punctuation\">(</span>otherSprite <span class=\"token keyword\">as</span> Circle<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getAxes</span><span class=\"token punctuation\">(</span>sprite <span class=\"token keyword\">as</span> Polygon<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span>otherSprite <span class=\"token keyword\">as</span> Polygon<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getAxes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// 第一步：获取所有的投影轴</span>\n  <span class=\"token comment\">// 第二步：获取多边形在各个投影轴的投影</span>\n  <span class=\"token comment\">// 第三步：判断是否存在一条投影轴上，多边形的投影不相交，如果存在不相交的投影则直接返回false，如果有所的投影轴上的投影都存在相交，则说明相碰了。</span>\n  <span class=\"token keyword\">let</span> axes <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">...</span>axes1<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>axes2<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> axis <span class=\"token keyword\">of</span> axes<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> projections1 <span class=\"token operator\">=</span> sprite<span class=\"token punctuation\">.</span><span class=\"token function\">getProjection</span><span class=\"token punctuation\">(</span>axis<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> projections2 <span class=\"token operator\">=</span> otherSprite<span class=\"token punctuation\">.</span><span class=\"token function\">getProjection</span><span class=\"token punctuation\">(</span>axis<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>projections1<span class=\"token punctuation\">.</span><span class=\"token function\">overlaps</span><span class=\"token punctuation\">(</span>projections2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>下面我们就按照这三个步骤来，一步一步实现分离轴检测方法。</p>\n<p>获取投影轴</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5fafe9f889de95c487257a33aa9a0957/3a666/projection.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 434px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 118.20276497695855%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAYAAAD6S912AAAACXBIWXMAAAsSAAALEgHS3X78AAADxUlEQVQ4y5VVWUgdSRTtfk/Me2rGrPJkYkbGgHE+xgQSUVFn9EdxQRRBXPBLcUPc8UNEXBBiHAX3DcUdlRH1ZxjBffsQ9xk1iqLign/6Fchi59xKV9PtM4RcKO6tqlunz71167YgfEcGBweZDggIcAoKCvIKDAz8nebQovCjUl9fz3RDQ8Oj4uJiA9nh4eE6GfDHwKampoTm5mZmNzU1ObS3t9uTnZycLKoB8TGhsbFRsc2kq6tLmJ2dVeYzMzN60m5ubrb+/v5O0dHRbB4aGspBRA5kBjgyMiIsLy8ze2JiQtzf32eHh4aGrBYXF9+Mj48/ofno6KjY2tqqOZufny94eHh8nbS1tQnz8/PKJkD13F5YWPhjc3Pz/8vLS2lpaSmD1i4uLnR8H8AO/f39dzXo09PTTA8MDAh7e3sMrLCw0HJlZeWv3d1d6eDgQAJbaWNj411CQoK+o6NDRF4fIsTHpaWljvHx8Y+8vb0NwcHBtupcKTbYeuHwf2dnZ9LOzs719vb2J+hPh4eHEj6egoPWfX19NuTr4+PjiJJ6gZJyxkW90oDB6QFYvd3a2pKOjo4I7APArqElAqU17C/zD9PlSZJkfrN0AaSRi1/W19dPTk9PCeA9AckMr2Xgz5QCRPCnXPQWpMGOlRFpRRAeA+3u7v4Z4a6fnJwwhhxUZvnx+PhYWltb+9doNN6Pi4uz4TXJBxNO++rqSpS//BigG2pQmeGH8/NzCvufyMhIK/KdnJwUfH19tSHTi+js7GT28PCwQdb3OCjACPQjXRLY/e3i4qKvq6u7gzVGAG7Ka2HCJ/RK5LBt5YJ+wMOnsbq62s3PoHatCFR93gyUL9TW1lr29vayYh0bG7sL0E0wa+e+c3NzuoyMDKpFG74GWxv2zfcIcOvq6mpLmDowIXBRTo/yirBvqKmpsQfYPXQmvQYQr0HTORCiHrdoHxIS4uXu7m6l9g0LC9OlpqbaZWVlPauqqjIhRXqzkG+2opaWFuoi1nzP09PTAHDnqKgo3+zsbKfc3FxTUVGRwsqswAkIuWM28sc0QjX09PToY2Ji7qSlpTkib86ZmZl26sMVFRWsS93KkAR1JqiSb1FWVuYKRs/Qnn5S++Xk5CgE8vLyqJl83eAVTs+mpKSE0xdTUlKeFxQU2ONZWnCQ2NhYBsSlsrJSKC8v1zIiIP4WExMTebM0RkREuJpMJpYj5E1MT09ne0lJSQzk1nZ/U9Dimfbz8zN+y0fTAG4TMHuJ4YPxK5wdoH+DforhCvs1hgsG/T7t1J3lW/IF8wwwtBPCeowAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"projection\"\n        title=\"\"\n        src=\"/static/5fafe9f889de95c487257a33aa9a0957/3a666/projection.png\"\n        srcset=\"/static/5fafe9f889de95c487257a33aa9a0957/cf440/projection.png 148w,\n/static/5fafe9f889de95c487257a33aa9a0957/d2d38/projection.png 295w,\n/static/5fafe9f889de95c487257a33aa9a0957/3a666/projection.png 434w\"\n        sizes=\"(max-width: 434px) 100vw, 434px\"\n      />\n  </span>\n  </a></p>\n<p>在多边形中，我们是以边来建立边向量的，边向量的法向量，就是这条边的投影轴了。对于投影轴，我们只需它的方向，所以一般会把它格式化为单位向量。</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">//获取凸多边形的投影轴</span>\n<span class=\"token keyword\">public</span> <span class=\"token function\">getAxes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> points <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>points<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> axes <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> j <span class=\"token operator\">=</span> points<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> j<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">let</span> v1 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Vector</span><span class=\"token punctuation\">(</span>points<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">,</span> points<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">let</span> v2 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Vector</span><span class=\"token punctuation\">(</span>points<span class=\"token punctuation\">[</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">,</span> points<span class=\"token punctuation\">[</span>i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      axes<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>\n          v1\n          <span class=\"token punctuation\">.</span><span class=\"token function\">subtract</span><span class=\"token punctuation\">(</span>v2<span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">.</span><span class=\"token function\">perpendicular</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">.</span><span class=\"token function\">normalize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">let</span> firstPoint <span class=\"token operator\">=</span> points<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> lastPoint <span class=\"token operator\">=</span> points<span class=\"token punctuation\">[</span>points<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> v1 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Vector</span><span class=\"token punctuation\">(</span>lastPoint<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">,</span> lastPoint<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> v2 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Vector</span><span class=\"token punctuation\">(</span>firstPoint<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">,</span> firstPoint<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  axes<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>\n      v1\n      <span class=\"token punctuation\">.</span><span class=\"token function\">subtract</span><span class=\"token punctuation\">(</span>v2<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">perpendicular</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">normalize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> axes<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>获取了待检测图形的投影轴之后，我们就需要计算图形在每条投影轴上的投影</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">public</span> <span class=\"token function\">getProjection</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">v<span class=\"token punctuation\">:</span> Vector</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> min <span class=\"token operator\">=</span> Number<span class=\"token punctuation\">.</span><span class=\"token constant\">MAX_SAFE_INTEGER</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> max <span class=\"token operator\">=</span> Number<span class=\"token punctuation\">.</span><span class=\"token constant\">MIN_SAFE_INTEGER</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> point <span class=\"token keyword\">of</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>points<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> p <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Vector</span><span class=\"token punctuation\">(</span>point<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">,</span> point<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> dotProduct <span class=\"token operator\">=</span> p<span class=\"token punctuation\">.</span><span class=\"token function\">dotProduct</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    min <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span>min<span class=\"token punctuation\">,</span> dotProduct<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    max <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">max</span><span class=\"token punctuation\">(</span>max<span class=\"token punctuation\">,</span> dotProduct<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Projection</span><span class=\"token punctuation\">(</span>min<span class=\"token punctuation\">,</span> max<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>最后判断投影是否重叠</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">/* 投影是否重叠 */</span>\n<span class=\"token function\">overlaps</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">p<span class=\"token punctuation\">:</span> Projection</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>max <span class=\"token operator\">></span> p<span class=\"token punctuation\">.</span>min <span class=\"token operator\">&amp;&amp;</span> p<span class=\"token punctuation\">.</span>max <span class=\"token operator\">></span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>min<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>其中，如果是一个圆形与一个凸多边形的检测时，在计算圆对应的投影轴时比较特殊，圆只有一条投影轴，就是圆心与它距离多边形最近顶点的向量，</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">//获取圆的投影轴</span>\n<span class=\"token keyword\">public</span> <span class=\"token function\">getAxes</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">polygon<span class=\"token punctuation\">:</span> Polygon</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 对于圆来说，获取其投影轴就是将圆心与他距离多边形最近顶点的连线</span>\n  <span class=\"token keyword\">let</span> <span class=\"token punctuation\">{</span> x<span class=\"token punctuation\">,</span> y <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> nearestPoint <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> nearestDistance <span class=\"token operator\">=</span> Number<span class=\"token punctuation\">.</span><span class=\"token constant\">MAX_SAFE_INTEGER</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> <span class=\"token punctuation\">[</span>index<span class=\"token punctuation\">,</span> point<span class=\"token punctuation\">]</span> <span class=\"token keyword\">of</span> polygon<span class=\"token punctuation\">.</span>points<span class=\"token punctuation\">.</span><span class=\"token function\">entries</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> d <span class=\"token operator\">=</span> <span class=\"token function\">distance</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">,</span> point<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">,</span> point<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>d <span class=\"token operator\">&lt;</span> nearestDistance<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      nearestDistance <span class=\"token operator\">=</span> d<span class=\"token punctuation\">;</span>\n      nearestPoint <span class=\"token operator\">=</span> point<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">let</span> v1 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Vector</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> v2 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Vector</span><span class=\"token punctuation\">(</span>nearestPoint<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">,</span> nearestPoint<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>v1<span class=\"token punctuation\">.</span><span class=\"token function\">subtract</span><span class=\"token punctuation\">(</span>v2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">normalize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><a href=\"https://snayan.github.io/canvas-demo/?module=collide_03\">这里是我的分离轴检测在线示例</a>。</p>\n<h3>小结</h3>\n<p>这篇笔记详细记录了 2d 图形中碰撞检测的方法，比较简单的方法是外接图形法和边界值检测法，它们相对不是那么精确，比较复杂和精确的方法有光线投射法和分离轴法。根据不同的场景和精确度要求，我们选择不同的方法。其他，除了上面几种，还有像素检测等方法也可以实现碰撞检测，像素检测是以像素为单位来检测，如果存在不透明的像素在同一个坐标上重叠，则说明发生了碰撞，具体实现可以查看<a href=\"https://benjaminhorn.io/code/pixel-accurate-collision-detection-with-javascript-and-canvas/\">Pixel accurate collision detection with Javascript and Canvas</a>。</p>\n<p>对于这几种检测方法，强力建议熟悉掌握分离轴法，因为它使用的范围最为广泛，对于任意的凸多边形，它都可以较精确的检测出来。由于分离轴检测法计算量一般比较大，所以在检测之前，我们先过滤掉那些根本不可能发生碰撞的图形，一般方法是空间分隔法，或者过滤可视区间不可见的图形等，然后再对较小的一部分可能发生碰撞的图形来进行计算检测，这样可以提升检测的速度。</p>\n<h4>参考</h4>\n<ul>\n<li><a href=\"https://github.com/JChehe/blog/issues/8\">“等一下，我碰！”——常见的 2D 碰撞检测</a> <em>[部分图片引用这篇文章的，这篇文章写的较好，建议读者看看]</em></li>\n<li><a href=\"https://book.douban.com/subject/24533314/\">《HTML5 Canvas 核心技术：图形、动画与游戏开发》</a></li>\n</ul>","frontmatter":{"title":"canvas-核心技术-如何实现碰撞检测","date":"August 26, 2018"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/post/how_to_detect_collision/","previous":{"fields":{"slug":"/post/how_to_implement_complex_animations/"},"frontmatter":{"title":"canavs核心技术-如何实现复杂的动画"}},"next":{"fields":{"slug":"/post/resolve_vue_style_update_problem/"},"frontmatter":{"title":"看vue源码解决组件style更新问题"}}}}