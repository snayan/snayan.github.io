{"data":{"avatar":{"childImageSharp":{"fixed":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGAABAAMBAAAAAAAAAAAAAAAAAAIEBQP/xAAWAQEBAQAAAAAAAAAAAAAAAAACAQD/2gAMAwEAAhADEAAAAcSerUQpOzXUqiMAb//EABsQAAMAAgMAAAAAAAAAAAAAAAABAhESAxQh/9oACAEBAAEFAjzJ1VJcZepyU9x0z//EABURAQEAAAAAAAAAAAAAAAAAABEg/9oACAEDAQE/AWP/xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/AR//xAAbEAADAAIDAAAAAAAAAAAAAAAAASEQERIxMv/aAAgBAQAGPwImPUNtcTodiz//xAAcEAACAgMBAQAAAAAAAAAAAAAAAREhMUFRYXH/2gAIAQEAAT8hWbK7l6NWStvasZEW4S7fwfTTAkNzkQZ//9oADAMBAAIAAwAAABAs1wP/xAAXEQEBAQEAAAAAAAAAAAAAAAABABEQ/9oACAEDAQE/EMLbwL//xAAXEQEBAQEAAAAAAAAAAAAAAAABEQAQ/9oACAECAQE/EIzR4rv/xAAfEAEAAwACAQUAAAAAAAAAAAABABEhMUFRYXGBodH/2gAIAQEAAT8QAjVRsF68R3WyhBpEB4otans9oxQXOZRxVfkow9YivuDFJrEfPmaECm2kqIiV2XP/2Q==","width":40,"height":40,"src":"/static/9d156e8486b343189790da372acb0018/987ea/my.jpg","srcSet":"/static/9d156e8486b343189790da372acb0018/987ea/my.jpg 1x,\n/static/9d156e8486b343189790da372acb0018/9c097/my.jpg 1.5x,\n/static/9d156e8486b343189790da372acb0018/bd6c6/my.jpg 2x"}}},"site":{"siteMetadata":{"title":"三洋的小站","author":"三洋"}},"markdownRemark":{"id":"61acb6ff-a555-56b4-b3c2-56bfe6db2f18","excerpt":"最近想了解一下 React 和 Vue 框架分别在 virtual dom 部分的实现，以及他们的不同之处。于是先翻开 Vue 的源码去找 virtual dom 的实现，看到开头，它就提到了 Vue 的 virtual dom 更新算法是基于 Snabbdom 实现的。于是，又去克隆了 Snabbdom…","html":"<p>最近想了解一下 React 和 Vue 框架分别在 virtual dom 部分的实现，以及他们的不同之处。于是先翻开 Vue 的源码去找 virtual dom 的实现，看到开头，它就提到了 Vue 的 virtual dom 更新算法是基于 Snabbdom 实现的。于是，又去克隆了 Snabbdom 的源码，发现它的源码并不是很复杂并且星星 🌟 还很多，所以就仔细看了一遍了，这里就将详细学习一下它是如何实现 virtual dom 的。</p>\n<p>在 Snabbdom 的 GitHub 上就解释了，它是一个实现 virtual dom 的库，简单化，模块化，以及强大的特性和性能。</p>\n<blockquote>\n<p>A virtual DOM library with focus on simplicity, modularity, powerful features and performance.</p>\n</blockquote>\n<p><a href=\"https://github.com/snabbdom/snabbdom\">这里是 Snabbdom 的仓库地址</a>。</p>\n<h3>init</h3>\n<!--more-->\n<p>Snabbdom 的简单是基于它的模块化，它对 virtual dom 的设计非常巧妙，在核心逻辑中只会专注于 vNode 的更新算法计算，而把每个节点具体要更新的部分，比如<code class=\"language-text\">props</code>，<code class=\"language-text\">class</code>，<code class=\"language-text\">styles</code>，<code class=\"language-text\">datalist</code>等放在独立的模块里，通过在不同时机触发不同 module 的钩子函数去完成。通过这样的方式解耦，不仅可以使代码组织结构更加清晰，更可以使得每一部分都专注于实现特定的功能，在设计模式中，这个也叫做单一职责原则。在实际场景使用时，可以只引入需要用到的特定模块。比如我们只会更新节点的类名和样式，而不关心属性以及事件，那么就只需要引用 class 和 style 的模块就可以了。例如下面这样，</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// 这里我们只需要用到class和style模块，所以就可以只需要引用这2个模块</span>\n<span class=\"token keyword\">var</span> patch <span class=\"token operator\">=</span> snabbdom<span class=\"token punctuation\">.</span><span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n  <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"snabbdom/modules/class\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>default<span class=\"token punctuation\">,</span>\n  <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"snabbdom/modules/style\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>default<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>它的核心方法就是这个<code class=\"language-text\">init</code>，我们先来简单看一下这个函数的实现，</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">// 这里是module中的钩子函数</span>\n<span class=\"token keyword\">const</span> hooks <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"create\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"update\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"remove\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"destroy\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"pre\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"post\"</span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">modules<span class=\"token punctuation\">:</span> <span class=\"token builtin\">Array</span><span class=\"token operator\">&lt;</span>Partial<span class=\"token operator\">&lt;</span>Module<span class=\"token operator\">>></span><span class=\"token punctuation\">,</span> domApi<span class=\"token operator\">?</span><span class=\"token punctuation\">:</span> <span class=\"token constant\">DOMAPI</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> i<span class=\"token punctuation\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span>\n    j<span class=\"token punctuation\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span>\n    cbs <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span> <span class=\"token keyword\">as</span> ModuleHooks\n  <span class=\"token keyword\">const</span> api<span class=\"token punctuation\">:</span> <span class=\"token constant\">DOMAPI</span> <span class=\"token operator\">=</span> domApi <span class=\"token operator\">!==</span> undefined <span class=\"token operator\">?</span> domApi <span class=\"token punctuation\">:</span> htmlDomApi\n  <span class=\"token comment\">// cbs存储了引入的modules中定义的钩子函数，</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> hooks<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>i<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    cbs<span class=\"token punctuation\">[</span>hooks<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>j <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> j <span class=\"token operator\">&lt;</span> modules<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>j<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> hook <span class=\"token operator\">=</span> modules<span class=\"token punctuation\">[</span>j<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>hooks<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>hook <span class=\"token operator\">!==</span> undefined<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        cbs<span class=\"token punctuation\">[</span>hooks<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>hook<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// 还定义了一些其他的内部方法，这些方法都是服务于patch</span>\n  <span class=\"token keyword\">function</span> <span class=\"token function\">emptyNodeAt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/* ... */</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">function</span> <span class=\"token function\">createRmCb</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/* ... */</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">function</span> <span class=\"token function\">createElm</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/* ... */</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">function</span> <span class=\"token function\">addVnodes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/* ... */</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">function</span> <span class=\"token function\">invokeDestroyHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/* ... */</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">function</span> <span class=\"token function\">removeVnodes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/* ... */</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">function</span> <span class=\"token function\">updateChildren</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/* ... */</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">function</span> <span class=\"token function\">patchVnode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/* ... */</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// init返回了一个patch函数，这个函数接受2个参数，第一个是将被更新的vNode或者真实dom节点，第二个是用来更新的新的vNode</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span> <span class=\"token function\">patch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">oldVnode<span class=\"token punctuation\">:</span> VNode <span class=\"token operator\">|</span> Element<span class=\"token punctuation\">,</span> vnode<span class=\"token punctuation\">:</span> VNode</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> VNode <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//...</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>从<code class=\"language-text\">init</code>函数整体来看，它接受一个 modules 数组，返回一个新的函数<code class=\"language-text\">patch</code>。这不就是我们熟悉的闭包函数吗？在<code class=\"language-text\">init</code>中，它会将引入模块的钩子函数通过遍历存储在<code class=\"language-text\">cbs</code>变量里，后面在执行更新算法时会相应的触发这些钩子函数。只需要初始化一次，后面 virtual dom 的更新都是通过<code class=\"language-text\">patch</code>来完成的。</p>\n<p>流程图如下，</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/720190efae0f3770bf6ccfb58a5a8c47/332be/main.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 120px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 242.50000000000003%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAxCAIAAABVih7fAAAACXBIWXMAAAsTAAALEwEAmpwYAAAD+klEQVRIx7VWWW/TQBD2T0fiL/COEA+oD0g8FSjQA6pC6N2kZxzncOMr8RnH98G3u/GRJmmDqq5GyXp2xzszO9985vI8zzL85GN72uyqp7xcSVuee+TlM15uD/UoTnM6OGqYu34Ibb7GsFxfkE12JJfRcwea7XghJnGSJmmWZtk0iMyJ74exjVlMlEQScmZPMb0goidT445keGHM3s00fdXaOuS/HfEHrUEYJw+WbDeojO9HDs4pl5kLOBKbwigpfWargmwEVMkxLdy7FcdRUrhHPc/oXkyYJk6JpWq6XaWImfxRe2cawHnEU4ogGcd3EibdUiMbomanhXdc5dJCYtM0w+sWl8pH7kE8D4y77FbqlrVt3CNXutS4Pp5nnK0YMMH1Xg9G1NPlY/nJZTG8erfziGtcT7FQITWxqTiS7vBDfbNxJ+surmd+D9vmcKi+JE0nfugFMSp2ysQP2SSKk4kXuhA/xAQy9bEakZp3Aw4oy2dllKazaGfZWry8MihScEnKtbraeUf5sN38cyUe3gzPOvJAtdr3+vapcHA5+HnRO7qV9s57f2+GP04EFBzeaTgewgH+uYuOMrKmra6qOx60mjUFBgESxZhoposlSZ9IY2c4dljkuAIAExWOGLkLQYVB4/r+6HaI9NIatuDL4e0QTqGZwAy+4Jzr/gjggYNXfe1mMALa4Lbak82Pe5fQsi5z0pbgFZxEFHC4cSXuN/u/L8WDSxEHbOy24Dwalh9GHLayhK2q8FWDJGy/OYBLiErWJxBcL5swGWiWTGOmG4o9Y2yb4Ko5ZxqabmAtE8PxEby9esMTwOgpL4eqR4yTFZ1kvZOzDDf838bswlTDffvl5DFIlruDMC7FDyIEjGPffGqgGPFYW4qjggNmTR81CPSCdJChstHiEfq+QmqW6OmSOLJbPW2ObsBdQY0ZVo2CXmyApzIGJALCVRnipGXkENwHES0GH4ADnoAqTJixUzcGkhAJyvVzo7171gUSto74r4c8UA1IfD/ubP6929hpNQV1iTFOZlSIaiUdxw/Htuf6VSeCHr+M9JAIxscVxcIGGa6ENSbabug/aT0R5WdkrqTYnHEfst1XQWWzxGLSKYhOkGcCPXxEJ6AJeqq2hXXKcykhoDzAqaxO64M21pcmOuEZkEwZJPMnjRcZHMB4/X5vPeMss2v9CWWALocGPPHIBxlTsi+z8qTKmH2sKEXfRIvEb72xQkAjYKLio6soEs0ktLJO30YWUU6sz5fAMGf+kGtM6etcEAgBuWoV/EkKFkviIqr8+c9HUByI5heI5krM5vmEGodVbY8tEts6bgMe/L3OtlUJ4yUD+Si/ACBoFwyJdUHCWEuA+T/jRgYSeg3yowAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"main\"\n        title=\"\"\n        src=\"/static/720190efae0f3770bf6ccfb58a5a8c47/332be/main.png\"\n        srcset=\"/static/720190efae0f3770bf6ccfb58a5a8c47/332be/main.png 120w\"\n        sizes=\"(max-width: 120px) 100vw, 120px\"\n      />\n  </span>\n  </a></p>\n<h3>patch</h3>\n<p>最为复杂也最为耗时的部分就是如何实现 virtual dom 的更新，更新算法的好坏直接影响整个框架的性能，比如 React 中的 react-reconciler 模块，到 vue 中的 vdom 模块，都是最大可能优化这一部分。在 Snabbdom 中 virtual dom 的更新逻辑大致如下，</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">// 这个patch就是init返回的</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">patch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">oldVnode<span class=\"token punctuation\">,</span> vnode</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 第一步：如果oldVnode是Element，则根据Element创建一个空的vnode，这个也是vnode tree的根节点</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">isVnode</span><span class=\"token punctuation\">(</span>oldVnode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    oldVnode <span class=\"token operator\">=</span> <span class=\"token function\">emptyAtNode</span><span class=\"token punctuation\">(</span>oldVnode<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// 第二步：判断oldVnode是否与vnode相同的元素，如果是，则更新元素即可。</span>\n  <span class=\"token comment\">// 这里判断它们是否相同，是对比了它们的key相同且tagName相同且ID属性相同且类相同</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">sameVnode</span><span class=\"token punctuation\">(</span>oldVnode<span class=\"token punctuation\">,</span> vnode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">patchVnode</span><span class=\"token punctuation\">(</span>oldVnode<span class=\"token punctuation\">,</span> vnode<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 第三步：如果不相同，则直接用vnode创建新的element元素替换oldVnode，且删除掉oldVnode。</span>\n    elm <span class=\"token operator\">=</span> oldVnode<span class=\"token punctuation\">.</span>elm\n    parent <span class=\"token operator\">=</span> api<span class=\"token punctuation\">.</span><span class=\"token function\">parentNode</span><span class=\"token punctuation\">(</span>elm<span class=\"token punctuation\">)</span>\n    <span class=\"token function\">createElm</span><span class=\"token punctuation\">(</span>vnode<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>parent <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      api<span class=\"token punctuation\">.</span><span class=\"token function\">insertBefore</span><span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">,</span> vnode<span class=\"token punctuation\">.</span>elm<span class=\"token punctuation\">,</span> api<span class=\"token punctuation\">.</span><span class=\"token function\">nextSlibing</span><span class=\"token punctuation\">(</span>elm<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      <span class=\"token function\">removeVnodes</span><span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>oldVnode<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">patch</code>逻辑可以简化为下面：</p>\n<ol>\n<li>如果 oldVnode 是 Element 类型，则根据 oldVnode 创建一个空 vnode，这个空 vnode 也是这个 vnode tree 的 root 节点</li>\n<li>比较 oldVnode 与 vnode，如果是同一个 vnode（key 值相同）或者是相同类型的元素（tagName 相同且 id 相同且 class 相同），则直接调用<code class=\"language-text\">patchVnode</code></li>\n<li>否则，直接根据 vnode 创建一个新的 element，且用新的 element 替换掉 oldVnode 的 element，且删除掉 oldVnode</li>\n</ol>\n<p>流程图如下，</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4999d84bbe5e1352efca33b220329530/df24b/structure.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 269px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 196.6542750929368%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAnCAIAAACABf9ZAAAACXBIWXMAAAsTAAALEwEAmpwYAAAC40lEQVRIx52V53KjMBSFef9H2z9bJrObbIkTNzBgigSIIsn7ScQlLhliRsYScNs550pBN+i0qAup0rJm+ElTNd1uwhWUVdsPhlku1SIumFhrM6EmGRO5qNqm64kmajcRTVupfpIxPyKrbqhUl+SkoclkN+0KDjNtjNiXaj9rPBhT1u10y4vIdbf7zHU0BrlMNHdGjvPqeZ15qo6vD1OtbT9oAvT7MWgT8CnwYhnn9SaX87io296Yd+G1gfmmVn3T9tzhhftWNME6lUWlooyw+eM8+fmKHxVuJe/wskoF3z3MNklRy6b7NU+ivFomJYrCUaC1A/k5zFZpucmrH/+iKJOkZH32JMX/m4RdDImEt2VTVoonwaE2HOP+Flyu4J5AlphkNPhlYPeo8GJUJaHsBWBvS2vpBbuH9Ig2ChVeJB9cZEupB6fvjMsLY2Ano14bEM6d5XCF5zF50IIS2kv6geBwx2DedoPx2doTGRxrpjH/rLZjkzkZaKONnaQwDIAaevte2wsTnlAU8BIfpBnM6fwAhEn1aZFC/Twuvz9H3KlwQJC7HfDgF/7XW4FUfi/SdSqe5sm3vyGcBwTEGFW/bgoU9uVxiRdkkEunR5SHo5coZ2MbBsM3i7ichRm4OIW5TtYmkw2yJG2CEPUsc+O14VRU1qQQZhJSM6kCe6IhvjjThhOMXwD14OrYAT4Fs8RjcOr+jMYzzMYNA1Ku9LOTgY98i5+xOsJe38NA7lTVZNf6DYCMkDSDfri1h9mvf8IRGOGFBaQQyVId5fVeJCQD6NyjrYQwqoIh1V7Z9C/LQSQd28XDSwz7y7h8mMWzMKfvTzV/U55kSGCkggCWiUAPV9vrujElgQSlrhLBQZcUlRPAxINuFMDI4RjQWHvfidHeeWIAeFl93viwAUp/St5z3LgG3MpLJXxkDDzCNedAu0GV6jSVU8JUqtAgwnbbRSpQMrTnlZpq3PpGwcCdGL43i2nI/Qfjc/LjXfxRFgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"structure\"\n        title=\"\"\n        src=\"/static/4999d84bbe5e1352efca33b220329530/df24b/structure.png\"\n        srcset=\"/static/4999d84bbe5e1352efca33b220329530/cf440/structure.png 148w,\n/static/4999d84bbe5e1352efca33b220329530/df24b/structure.png 269w\"\n        sizes=\"(max-width: 269px) 100vw, 269px\"\n      />\n  </span>\n  </a></p>\n<p>在进行第 3 步时，当 oldVnode 与 vnode 不相同，是直接抛弃了旧的节点，创建新的节点来替换，在用新 vnode 来创建节点时会检查当前 vnode 有没有 children，如果有，则也会遍历 children 创建出新的 element。这意味 oldVnode 以及包含的所有子节点将被作为一个整体被新的 vnode 替换。示意图如下，</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d314eb8360980f79354cff845e8c9083/59a95/replace.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 416px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 53.605769230769226%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAABb0lEQVQoz22Q207jMBCG8/6vwg03oOVQqBYERSAEWu5WidL0SJImwa5P48MwSdoSBL9Glmfm/+yxI0RcdsqybDabpWm6Xq/jOFZKYSdjTJIkZVlOp9OsE9moQoaI2nVdV6025CiKgjGW5zkA9LBzjoqc87Jr00JWqpAhwr2sD9r6Qxr2OlR8IMMgR4x6G+2arVpt+KCFXb0N3xm40uuKW+eH8E5CeSZ0z9BU9PLFYqGk6o+hRerABQxPj8BnFKsqbdSUS13z1g2dhFQSluBT47JVmXCdNII1XO+Ham8+03A1e59zPfkQYll+Te4CgntCPNH1mMVvFv7kbFU0+vARBP9VMObi3rg7sNaA+4I9wS+I1/BxYfKR89cSKtMOvoeVPufyEvHSuJsQ/PBJBNvwAuWRVxdenKr62CHrv3IHz4uYywnB+ieMQfJ/In4IbmSbMUsfwdbf4Ir91zD59WZKNHs1788hjNz2djt/BdgM4U8tLXYbsgjxsAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"replace\"\n        title=\"\"\n        src=\"/static/d314eb8360980f79354cff845e8c9083/59a95/replace.png\"\n        srcset=\"/static/d314eb8360980f79354cff845e8c9083/cf440/replace.png 148w,\n/static/d314eb8360980f79354cff845e8c9083/d2d38/replace.png 295w,\n/static/d314eb8360980f79354cff845e8c9083/59a95/replace.png 416w\"\n        sizes=\"(max-width: 416px) 100vw, 416px\"\n      />\n  </span>\n  </a></p>\n<p>如果 B 与 B’不相同，则 B 在被 B’替换的过程中，B 的子节点 D 也就被 B’的子节点 D’和 E’一起替换掉了。</p>\n<h3>patchVnode</h3>\n<p>我们再来看看第 2 步，如果 oldVnode 与 vnode 相同，则会复用之前已经创建好的 dom，只是更新这个 dom 上的差异点，比如 text，class，datalist，style 等。这个是在函数<code class=\"language-text\">patchVnode</code>中实现的，下面为它的大致逻辑，</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">function</span> <span class=\"token function\">patchVnode</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">oldVnode<span class=\"token punctuation\">,</span> vnode</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n   <span class=\"token comment\">// 获取oldVnode的dom对象</span>\n  <span class=\"token keyword\">const</span> elm <span class=\"token operator\">=</span> oldVnode<span class=\"token punctuation\">.</span>elm\n  <span class=\"token comment\">// 将vnode的elm直接指向elm，复用oldVnode的dom对象，因为它们类型相同</span>\n  vnode<span class=\"token punctuation\">.</span>elm <span class=\"token operator\">=</span> elm\n  <span class=\"token comment\">// 如果oldVnode与vnode相等，则直接返回，根本不用更新了</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oldVnode <span class=\"token operator\">===</span> vnode<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// 如果vnode是包含text，且不等于oldVnode.text，则直接更新elm的textContent为vnode.text</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isDef</span><span class=\"token punctuation\">(</span>vnode<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> vnode<span class=\"token punctuation\">.</span>text <span class=\"token operator\">!==</span> oldVnode<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> api<span class=\"token punctuation\">.</span><span class=\"token function\">setTextContext</span><span class=\"token punctuation\">(</span>elm<span class=\"token punctuation\">,</span> vnode<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">let</span> oldCh <span class=\"token operator\">=</span> oldVnode<span class=\"token punctuation\">.</span>children <span class=\"token comment\">// 获取oldVnode的子节点</span>\n  <span class=\"token keyword\">let</span> ch <span class=\"token operator\">=</span> vnode<span class=\"token punctuation\">.</span>children <span class=\"token comment\">// 获取vnode的子节点</span>\n\n  <span class=\"token comment\">// 如果oldVnode没有子节点，而vnode有子节点,则添加vnode的子节点</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isUndef</span><span class=\"token punctuation\">(</span>oldCh<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">isDef</span><span class=\"token punctuation\">(</span>ch<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 如果oldVnode有text值，则先将elm的textContent清空</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">idDef</span><span class=\"token punctuation\">(</span>oldVnode<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      api<span class=\"token punctuation\">.</span><span class=\"token function\">setTextContext</span><span class=\"token punctuation\">(</span>elm<span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">addVnodes</span><span class=\"token punctuation\">(</span>elm<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> ch<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> ch<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// 如果oldVnode有子节点，而vnode没有子节点，则删除oldVnode的子节点</span>\n  <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isUndef</span><span class=\"token punctuation\">(</span>ch<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">isDef</span><span class=\"token punctuation\">(</span>oldCh<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">reoveVnodes</span><span class=\"token punctuation\">(</span>elm<span class=\"token punctuation\">,</span> oldCh<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> oldCh<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// 如果它们都有子节点，并且子节点不相同，则更新它们的子节点</span>\n  <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ch <span class=\"token operator\">!==</span> oldCh<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">updateChildren</span><span class=\"token punctuation\">(</span>elm<span class=\"token punctuation\">,</span> oldCh<span class=\"token punctuation\">,</span> ch<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// 否则就是它们都有子节点，且子节点相同，如果oldVnode有text值，则将elm的textContent清空</span>\n  <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">ifDef</span><span class=\"token punctuation\">(</span>oldVnode<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    api<span class=\"token punctuation\">.</span><span class=\"token function\">setTextContext</span><span class=\"token punctuation\">(</span>elm<span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">patchVnode</code>逻辑可以简化为下面：</p>\n<ol>\n<li>直接将 vnode 的 elm 设置为 oldVnode 的 elm，以达到复用已有的 dom 对象，避免了创建新的 dom 对象的开销</li>\n<li>比较 oldVnode === vnode，如果相等，则直接返回，不同更新，因为它们就是同一个对象</li>\n<li>如果 vnode 有 text 值，则说明 elm 就只包含了纯 text 文本，无其他类型子节点，如果它的值与 oldVnode 的 text 不相同，则更新 elm 的 textContent，并返回。</li>\n<li>\n<p>这一步开始，真正比较它们的 children 了，</p>\n<ul>\n<li>如果 vnode 有 children，oldVnode 没有 children，先清空 elm 的 textContext，再将 vnode 的 children 添加进来</li>\n<li>如果 vnode 没有 children，oldVnode 有 children，则直接删除 oldVnode 的 children</li>\n<li>如果它们都有 children，且不相同，则更新它们的 children</li>\n<li>如果它们都有 children，且相同，则清空 elm 的 textContext</li>\n</ul>\n</li>\n</ol>\n<p>流程图如下，</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e80ee100db03233ea070370bf65d67be/60c44/patchVnode.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 106.85249709639955%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAIAAADJt1n/AAAACXBIWXMAAAsTAAALEwEAmpwYAAABzklEQVQ4y42TTU4DMQyF52ywgQ1IXIOrIRYsWaAegxUSLJCKgM5fJoljO7zEbWlRZ8QoijJOnv3Fdpo88wVK3egjcZ7/mpNWVYW4dxFirGERGUb/0Lt75+87dzeFJ9hOi0V0M/p29L3zlIgoO/fSDjcf7cX71/Vndz6425y5mUNilRq4SOFLVUT6nFuRrs7jErYL1DmPGdQsWvUgygezzohz9jGNgTAnFhss22G/SEqzkExsn4SyFCbmWewp0GbwiAzmEpAFa1g6F6wEIaY5cSYWHMLMhp0YIPA4xVQcCnzRInZMC7t/saUQ1sFqkJYw3mVrSUww7M6BGQ0CS2L4AqYW2Jqq02JfqqoLyT8MvhWDE/Zhil/9hLmcOXCBNdKGbvnup25EHsAihlnEKRVOA0Pkws6/EbBFqQDXHJfOgrqquCkFDERIke6LxLEetxRijSC2C9Ga5S2kNUoFMd7sZ+dAazBIb+8CjD4kywK2wOxrt72yXPXTWesuB/8cqIFXCBDaQlknoRmosoECbq1g+HWqK+LHQCvmb7I716seVfv4zkcVrq9se+d/iNWg9g8OlFpVjSW9NsP2rcV6kRBLk6BVULvyPPYPs5YNBmz9AIGp0lKX3ASTAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"patchVnode\"\n        title=\"\"\n        src=\"/static/e80ee100db03233ea070370bf65d67be/b9e4f/patchVnode.png\"\n        srcset=\"/static/e80ee100db03233ea070370bf65d67be/cf440/patchVnode.png 148w,\n/static/e80ee100db03233ea070370bf65d67be/d2d38/patchVnode.png 295w,\n/static/e80ee100db03233ea070370bf65d67be/b9e4f/patchVnode.png 590w,\n/static/e80ee100db03233ea070370bf65d67be/60c44/patchVnode.png 861w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </span>\n  </a></p>\n<p>在<code class=\"language-text\">patchVnode</code>更新时，vnode 会先是通过触发定义在 data 数据上的钩子函数来更新自己节点上的信息，比如 class 或者 styles 等，然后再去更新 children 节点信息。</p>\n<h3>updateChildren</h3>\n<p>更新 vnode.children 信息是通过<code class=\"language-text\">updateChildren</code>函数来完成的。只有当 oldVnode 上存在 children，且 vnode 上也存在 children 时，并且<code class=\"language-text\">oldVnode.children !== vnode.children</code>时，才会去调用<code class=\"language-text\">updateChildren</code>。下面来梳理一下<code class=\"language-text\">updateChildren</code>的大致逻辑，</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">function</span> <span class=\"token function\">updateChildren</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">parentElm<span class=\"token punctuation\">,</span> oldCh<span class=\"token punctuation\">,</span> newCh</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 旧的children</span>\n  <span class=\"token keyword\">let</span> oldStartIdx <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n  <span class=\"token keyword\">let</span> oldEndIdx <span class=\"token operator\">=</span> oldCh<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token number\">1</span>\n  <span class=\"token keyword\">let</span> oldStartVnode <span class=\"token operator\">=</span> oldCh<span class=\"token punctuation\">[</span>oldStartIdx<span class=\"token punctuation\">]</span>\n  <span class=\"token keyword\">let</span> oldEndVnode <span class=\"token operator\">=</span> <span class=\"token function\">oldCh</span><span class=\"token punctuation\">(</span>oldEndIdx<span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// 新的children</span>\n  <span class=\"token keyword\">let</span> newStartIdx <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n  <span class=\"token keyword\">let</span> newEndIdx <span class=\"token operator\">=</span> newCh<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token number\">1</span>\n  <span class=\"token keyword\">let</span> newStartVnode <span class=\"token operator\">=</span> <span class=\"token function\">newCh</span><span class=\"token punctuation\">(</span>newStartIdx<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">let</span> newEndVnode <span class=\"token operator\">=</span> <span class=\"token function\">newCh</span><span class=\"token punctuation\">(</span>newEndIdx<span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">let</span> before <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n\n  <span class=\"token comment\">// 循环比较</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>oldStartIdx <span class=\"token operator\">&lt;=</span> oldEndIdx <span class=\"token operator\">&amp;&amp;</span> newStartIdx <span class=\"token operator\">&lt;=</span> newEndIdx<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oldStartVnode <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 当前节点可能被移动了</span>\n      oldStartVnode <span class=\"token operator\">=</span> oldCh<span class=\"token punctuation\">[</span><span class=\"token operator\">++</span>oldStartIdx<span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oldEndVnode <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      oldEndVnode <span class=\"token operator\">=</span> oldCh<span class=\"token punctuation\">[</span><span class=\"token operator\">--</span>oldEndIdx<span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>newStartVnode <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      newStartVnode <span class=\"token operator\">=</span> newCh<span class=\"token punctuation\">[</span><span class=\"token operator\">++</span>newStartIdx<span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>newEndVnode <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      newEndVnode <span class=\"token operator\">=</span> newCh<span class=\"token punctuation\">[</span><span class=\"token operator\">--</span>newEndIdx<span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">sameVnode</span><span class=\"token punctuation\">(</span>oldStartVnode<span class=\"token punctuation\">,</span> newStartVnode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">patchVnode</span><span class=\"token punctuation\">(</span>oldStartVnode<span class=\"token punctuation\">,</span> newStartVnode<span class=\"token punctuation\">)</span> <span class=\"token comment\">// 更新newStartVnode</span>\n      oldStartVnode <span class=\"token operator\">=</span> oldCh<span class=\"token punctuation\">[</span><span class=\"token operator\">++</span>oldStartIdx<span class=\"token punctuation\">]</span> <span class=\"token comment\">// oldStartIdx 向右移动</span>\n      newStartVnode <span class=\"token operator\">=</span> newCh<span class=\"token punctuation\">[</span><span class=\"token operator\">++</span>newStartIdx<span class=\"token punctuation\">]</span> <span class=\"token comment\">// newStartIdx 向右移动</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">sameVnode</span><span class=\"token punctuation\">(</span>oldEndVnode<span class=\"token punctuation\">,</span> newEndVnode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">patchVnode</span><span class=\"token punctuation\">(</span>oldEndVnode<span class=\"token punctuation\">,</span> newEndVnode<span class=\"token punctuation\">)</span> <span class=\"token comment\">// 更新newEndVnode</span>\n      oldEndVnode <span class=\"token operator\">=</span> oldCh<span class=\"token punctuation\">[</span><span class=\"token operator\">--</span>oldEndIdx<span class=\"token punctuation\">]</span> <span class=\"token comment\">// oldEndIdx 向左移动</span>\n      newEndVnode <span class=\"token operator\">=</span> newCh<span class=\"token punctuation\">[</span><span class=\"token operator\">--</span>newEndIdx<span class=\"token punctuation\">]</span> <span class=\"token comment\">// newEndIdx 向左移动</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">sameVnode</span><span class=\"token punctuation\">(</span>oldStartVnode<span class=\"token punctuation\">,</span> newEndVnode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">patchVnode</span><span class=\"token punctuation\">(</span>oldStartVnode<span class=\"token punctuation\">,</span> newEndVnode<span class=\"token punctuation\">)</span> <span class=\"token comment\">//更新newEndVnode</span>\n      <span class=\"token keyword\">let</span> oldAfterVnode <span class=\"token operator\">=</span> api<span class=\"token punctuation\">.</span><span class=\"token function\">nextSibling</span><span class=\"token punctuation\">(</span>oldEndVnode<span class=\"token punctuation\">)</span>\n      <span class=\"token comment\">// 将oldStartVnode移动到当前oldEndVnode后面</span>\n      api<span class=\"token punctuation\">.</span><span class=\"token function\">insertBefore</span><span class=\"token punctuation\">(</span>parentElm<span class=\"token punctuation\">,</span> oldStartVnode<span class=\"token punctuation\">.</span>elm<span class=\"token punctuation\">,</span> oldAfterVnode<span class=\"token punctuation\">)</span>\n      oldStartVnode <span class=\"token operator\">=</span> oldCh<span class=\"token punctuation\">[</span><span class=\"token operator\">++</span>oldStartIdx<span class=\"token punctuation\">]</span> <span class=\"token comment\">// oldStartIdx 向右移动</span>\n      newEndVnode <span class=\"token operator\">=</span> newCh<span class=\"token punctuation\">[</span><span class=\"token operator\">--</span>newOldVnode<span class=\"token punctuation\">]</span> <span class=\"token comment\">// newEndIdx 向左移动</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">sameVnode</span><span class=\"token punctuation\">(</span>oldEndVnode<span class=\"token punctuation\">,</span> newStartVnode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">patchVnode</span><span class=\"token punctuation\">(</span>oldEndVnode<span class=\"token punctuation\">,</span> newStartVnode<span class=\"token punctuation\">)</span> <span class=\"token comment\">// 更新newStartVnode</span>\n      <span class=\"token comment\">//将oldEndVnode移动到oldStartVnode前面</span>\n      api<span class=\"token punctuation\">.</span><span class=\"token function\">insertBefore</span><span class=\"token punctuation\">(</span>parentElm<span class=\"token punctuation\">,</span> oldEndVnode<span class=\"token punctuation\">.</span>elm<span class=\"token punctuation\">,</span> oldStartVnode<span class=\"token punctuation\">.</span>elm<span class=\"token punctuation\">)</span>\n      oldEndVnode <span class=\"token operator\">=</span> oldCh<span class=\"token punctuation\">[</span><span class=\"token operator\">--</span>oldEndIdx<span class=\"token punctuation\">]</span> <span class=\"token comment\">// oldEndVnode 向右移动</span>\n      newStartVnode <span class=\"token operator\">=</span> newCh<span class=\"token punctuation\">[</span><span class=\"token operator\">++</span>newStartIdx<span class=\"token punctuation\">]</span> <span class=\"token comment\">// newStartVnode 向左移动</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">//获取当前旧的children的节点的key与其index的对应值，</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oldKeyIdx <span class=\"token operator\">==</span> undefined<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        oldKeyIdx <span class=\"token operator\">=</span> <span class=\"token function\">createKeyToOldIdx</span><span class=\"token punctuation\">(</span>oldCh<span class=\"token punctuation\">,</span> oldStartIdx<span class=\"token punctuation\">,</span> oldEndIdx<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token comment\">//获取当前newStartVnode的key是否存在旧的children数组里</span>\n      idxInOld <span class=\"token operator\">=</span> oldKeyIdx<span class=\"token punctuation\">[</span>newStartVnode<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">]</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isUndef</span><span class=\"token punctuation\">(</span>idxInOld<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">//如果当前newStartVnode的key不存在旧的children数组里，那么这个newStartVnode就是新的，需要新建dom</span>\n        <span class=\"token keyword\">let</span> newDom <span class=\"token operator\">=</span> <span class=\"token function\">createElm</span><span class=\"token punctuation\">(</span>newStartVnode<span class=\"token punctuation\">)</span>\n        api<span class=\"token punctuation\">.</span><span class=\"token function\">insertBefore</span><span class=\"token punctuation\">(</span>parentElm<span class=\"token punctuation\">,</span> newDom<span class=\"token punctuation\">,</span> oldStartVnode<span class=\"token punctuation\">.</span>elm<span class=\"token punctuation\">)</span>\n        newStartVnode <span class=\"token operator\">=</span> newCh<span class=\"token punctuation\">[</span><span class=\"token operator\">++</span>newStartIdx<span class=\"token punctuation\">]</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">//否则，当前newStartVnode的key存在旧的children里，说明它们之前是同一个Vnode,</span>\n        elmToMove <span class=\"token operator\">=</span> oldCh<span class=\"token punctuation\">[</span>idxInOld<span class=\"token punctuation\">]</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>elmToMove<span class=\"token punctuation\">.</span>sel <span class=\"token operator\">!==</span> newStartVnode<span class=\"token punctuation\">.</span>sel<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token comment\">//节点类型变了，不是同一个类型的dom元素了,也是需要新建的</span>\n          <span class=\"token keyword\">let</span> newDom <span class=\"token operator\">=</span> <span class=\"token function\">createElm</span><span class=\"token punctuation\">(</span>newStartVnode<span class=\"token punctuation\">)</span>\n          api<span class=\"token punctuation\">.</span><span class=\"token function\">insertBefore</span><span class=\"token punctuation\">(</span>parentElm<span class=\"token punctuation\">,</span> newDom<span class=\"token punctuation\">,</span> oldStartVnode<span class=\"token punctuation\">.</span>elm<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token comment\">// 否则，它们是同一个Vnode且dom元素也相同，则不需要新建，只需要更新即可</span>\n          <span class=\"token function\">patchVnode</span><span class=\"token punctuation\">(</span>elmToMove<span class=\"token punctuation\">,</span> newStartVnode<span class=\"token punctuation\">)</span>\n          oldCh<span class=\"token punctuation\">[</span>idxInOld<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> undefined <span class=\"token comment\">// 标志旧的children当前位置的元素被移走了，</span>\n          api<span class=\"token punctuation\">.</span><span class=\"token function\">insertBefore</span><span class=\"token punctuation\">(</span>parentElm<span class=\"token punctuation\">,</span> elmToMove<span class=\"token punctuation\">,</span> oldStartVnode<span class=\"token punctuation\">.</span>elm<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n        newStartVnode <span class=\"token operator\">=</span> newCh<span class=\"token punctuation\">[</span><span class=\"token operator\">++</span>newStartIdx<span class=\"token punctuation\">]</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// 如果循环之后，还有未处理的children，</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oldStartIdx <span class=\"token operator\">&lt;=</span> oldEndIdx <span class=\"token operator\">||</span> newStartIdx <span class=\"token operator\">&lt;=</span> newEndIdx<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 如果新的children还有部分未处理，则把多的部分增加进去</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oldStartIdx <span class=\"token operator\">></span> oldEndIdx<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      before <span class=\"token operator\">=</span> newCh<span class=\"token punctuation\">[</span>newEndIdx <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">?</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">:</span> newCh<span class=\"token punctuation\">[</span>newEndIdx <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span>\n      <span class=\"token function\">addVnodes</span><span class=\"token punctuation\">(</span>parentElm<span class=\"token punctuation\">,</span> before<span class=\"token punctuation\">,</span> newCh<span class=\"token punctuation\">,</span> newStartIdx<span class=\"token punctuation\">,</span> newEndIdx<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">//如果旧的children还有未处理，则把多的部分删除掉</span>\n      <span class=\"token function\">removeVnodes</span><span class=\"token punctuation\">(</span>parentElm<span class=\"token punctuation\">,</span> oldCh<span class=\"token punctuation\">,</span> oldStartIdx<span class=\"token punctuation\">,</span> oldEndIdx<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">updateChildren</code>函数逻辑可以简化为，</p>\n<ol>\n<li>初始化循环变量</li>\n<li>根据变量循环遍历 old children 与 new children，并逐个比较更新，当类型相同时，则调用<code class=\"language-text\">patchVnode</code>更新，当类型不同时，则直接新建 new vnode 的 dom 元素，并插入到合适的位置</li>\n<li>循环完了之后，增加新增的 new vnode 节点和移除旧的冗余的 old vnode</li>\n</ol>\n<p>流程图如下，</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9014e691bff7fad272912e7dcd597b1f/afda5/updateChildren.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 109.6728307254623%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAIAAABPIytRAAAACXBIWXMAAAsTAAALEwEAmpwYAAACCElEQVQ4y5VUS47TQBT0lRDSCFYI9lwAIVhzHljAhiOgWXEEFkhIXAEpyQyM8/GnP+9rqpMY4skkA61W27JdXe9VVbsa7hrmHjNv+hRJ3H04MapTL1QtZFY9iTwHxiDW4ey4A6zmJNpFmt80kTgLHvi/gs0cyFndXi27xbINif8DrKqrTbiq27oJ16tu3Se/H+yDslDmnLmsibo+YqcpUg/nCHZnYNCr2fjA+8TlIuJ2htmMiQG8ZRWs3u+lCuvNheWz6CfRS0zWywI2VCvyt3xwRoJaaHix7CCemAlZH1chP0v0IOSLNlyQPKywq4jKtDDeWtWGjAm3wQ/uGDchv4n5RZ9edfF1ppeVC2RSQ81qhdTKWugHI2GswzCqAArr3NvMa7MGhlaoGWBZN7xupGm5abULu68TTeTxUXkZ816BF7JMT0Um+cb6tUtfsBJ/hxUFjPQYyK3kpmjkB+Cym20bnl0vn87rxz9+PpnXjxb1c9HVFqxoPZFsugQj/IjZt9neZHof8rtf6w8hv0300SzuenbfF7y7VFuf7DgAeMtyu+dhmlNYZVTk9kOfWeGPNH2ADbjfyW8iRwnDU57EC65it1UbZzcN2qMSM4RUj4/HPp5CzEXIoijK6BMtm4DfECYUQoxKQk+eKmSIuRiuBiZ8/6eRcjBU7z2S2wMEkrE8RzEsw+kf4G+egwXRoay62AAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"updateChildren\"\n        title=\"\"\n        src=\"/static/9014e691bff7fad272912e7dcd597b1f/b9e4f/updateChildren.png\"\n        srcset=\"/static/9014e691bff7fad272912e7dcd597b1f/cf440/updateChildren.png 148w,\n/static/9014e691bff7fad272912e7dcd597b1f/d2d38/updateChildren.png 295w,\n/static/9014e691bff7fad272912e7dcd597b1f/b9e4f/updateChildren.png 590w,\n/static/9014e691bff7fad272912e7dcd597b1f/afda5/updateChildren.png 703w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </span>\n  </a></p>\n<p>在<code class=\"language-text\">updateChildren</code>函数中，逐个更新 children 中节点时，当比较的两个节点类型相同时，又会反过来调用<code class=\"language-text\">patchVnode</code>来更新节点，这样，实际上存在了间接的递归调用。</p>\n<h3>life cycle hooks</h3>\n<p>在使用 React 或者 Vue 时，你会发现它们都分别定义了组件的生命周期方法，虽然名称或触发时机不完全相同，但是基本的顺序和目的是差不多的。Snabbdom 也提供了相应的生命周期钩子函数，不同的是它提供了 2 套，一套是针对 virtual dom 的，比如一个 Vnode 的<code class=\"language-text\">create</code>,<code class=\"language-text\">update</code>,<code class=\"language-text\">remove</code>等；一套是针对 modules 的，通过在不同时机触发不同 module 的钩子函数去完成当前 Vnode 的更新操作。</p>\n<p>modules 的上的钩子函数如下,</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">Module</span> <span class=\"token punctuation\">{</span>\n  pre<span class=\"token punctuation\">:</span> PreHook\n  create<span class=\"token punctuation\">:</span> CreateHook\n  update<span class=\"token punctuation\">:</span> UpdateHook\n  destroy<span class=\"token punctuation\">:</span> DestroyHook\n  remove<span class=\"token punctuation\">:</span> RemoveHook\n  post<span class=\"token punctuation\">:</span> PostHook\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>它的触发时机图如下，</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/49caa1ff4e35f00e776cda82c9004a9f/4f3bc/module_hooks.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 112.9360465116279%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAXCAIAAACEf/j0AAAACXBIWXMAAAsTAAALEwEAmpwYAAADbUlEQVQ4y4VU329UVRDeP8ekCUFAKEhpayplSyGkGqMPYioPEEAD0lqoUVTQuKgxiKClhoqakNqEBAOaUBMhRH3Ql4ZIBIV0t9uyWdZtd3t37z3z4xvP3nYLFtB7z8s5Z7755pszMwl7yMeiQUilIIyIH2aTeNChmolfjl0lDAGZ25rhv8ESI+s+YCT33mKRi8S/CQ0wwR3Wy4JB0req9Lrah4xzghsKrpvpvWDENB72J+shwSaz1UCL4x2VcI/iKbNVilbW7azfK6QOqTPDK8MAbCWswWyF2XLmrko4Vq5kIjoKLDU0GpYADYJtivRcCIm6tg+InxfpNekzvGraI7KvGvWVg37iHkWvmV99wH7inY63Cf6aZ2YdYlnjKMuwcyGnirNngqgcS5M4xsxN9+1w9fxIkMtGfhu5/YouQTUhSCueIG03yZwy2xmUjuUm95ZnUl4basImczj58fTZ0/mzQ7nBT4qFaR/pO2aPkHyeYP3MiyTtNEn3w044dy3iYce7xZeJB+Pq7zwwKNdvuT9u0rHjfGvcOzxktkzwnAd3mzayJD1zVm2XcxtYtxKPxRHHz4ALo3w4RYdT7scr5A8dve35gGSCZb3lV0nUzpqJH1HL8y9erwxlK0WaM50xCwK/I/bgx4A2z5w0axLZwMhI2arH/3b7iuFwSWLBNdmwSzPfvVHc81HhYDa4UUsYvxmDn/Tg7b4GRDrIxukgygdy05/mgpcLdIp9sv1/0X7onn12cOroian3X5vdW7RQ2SdseRy2fmn2qGonyQTvtui0VseMUkbveWANfgYjL8iOn3hsVH7ZJa9MoWh8xGyJYGtCcUexUaUtst+ia7fDF8cpORH2pl1hgi3LNBlx+gj1dPCyLlo7Sl8Zl0LqN2sgHZkrkgvACtWkYKNPAbmkWIciydIeUbsPz/QZJ+tFNps+LboJWMn6ki/yxFxLsH4BX9K6xtBits50HbTFUWdQ3aJoU3vcrBnWotZktlTUl2dhoTHE40kvCrbUGkA9vpmku+puB6Fz9DWwFtYKW61oYn1XUbrbGAvNrMizDvjSAZoVjY42V0IfZyvQCHSyHhD9FfP9iEXDAPUBEgmuCs6TDlXppNo3gp8Fedw1wwPHEBamRG02qIW06Bb/OwBr9KKczU9fn8gHYRh7xP1G/wBQNsPpLeECLwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"modules_hook\"\n        title=\"\"\n        src=\"/static/49caa1ff4e35f00e776cda82c9004a9f/b9e4f/module_hooks.png\"\n        srcset=\"/static/49caa1ff4e35f00e776cda82c9004a9f/cf440/module_hooks.png 148w,\n/static/49caa1ff4e35f00e776cda82c9004a9f/d2d38/module_hooks.png 295w,\n/static/49caa1ff4e35f00e776cda82c9004a9f/b9e4f/module_hooks.png 590w,\n/static/49caa1ff4e35f00e776cda82c9004a9f/4f3bc/module_hooks.png 688w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n  </span>\n  </a></p>\n<p>在触发 modules 的 hooks 函数时，不同的函数会接受不同的参数，下面为 modukes 中钩子函数接受参数情况，</p>\n<table>\n<thead>\n<tr>\n<th>Name</th>\n<th>Triggered when</th>\n<th>Arguments to callback</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code class=\"language-text\">pre</code></td>\n<td>在<code class=\"language-text\">patch</code>函数开始处</td>\n<td>无</td>\n</tr>\n<tr>\n<td><code class=\"language-text\">create</code></td>\n<td>在<code class=\"language-text\">createElm</code>函数中创建一个 element 时</td>\n<td><code class=\"language-text\">vnode</code></td>\n</tr>\n<tr>\n<td><code class=\"language-text\">update</code></td>\n<td>在<code class=\"language-text\">pathVnode</code>函数中更新 Vnode 时，</td>\n<td><code class=\"language-text\">oldVnode</code>，<code class=\"language-text\">newVnode</code></td>\n</tr>\n<tr>\n<td><code class=\"language-text\">destroy</code></td>\n<td>在<code class=\"language-text\">removeVnodes</code>函数中移除 Vnode 时，</td>\n<td><code class=\"language-text\">vnode</code></td>\n</tr>\n<tr>\n<td><code class=\"language-text\">remove</code></td>\n<td>在<code class=\"language-text\">removeVnodes</code>函数中移除 Vnode 时，</td>\n<td><code class=\"language-text\">vnode</code>，<code class=\"language-text\">removeCallback</code></td>\n</tr>\n<tr>\n<td><code class=\"language-text\">post</code></td>\n<td>在<code class=\"language-text\">patch</code>函数最后处，</td>\n<td>无</td>\n</tr>\n</tbody>\n</table>\n<p>大部分 module 中都没有定义<code class=\"language-text\">pre</code>函数和<code class=\"language-text\">post</code>函数，主要是在<code class=\"language-text\">create</code>，<code class=\"language-text\">update</code>， <code class=\"language-text\">destory</code>，<code class=\"language-text\">remove</code>中对当前 Vnode 进行操作。比如，在 class module 中在<code class=\"language-text\">create</code>函数内对 Vnode 上的操作如下，</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">// class modules 中在create钩子函数中对当前Vnode操作</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">updateClass</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">oldVnode<span class=\"token punctuation\">:</span> VNode<span class=\"token punctuation\">,</span> vnode<span class=\"token punctuation\">:</span> VNode</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">var</span> cur<span class=\"token punctuation\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">,</span>\n    name<span class=\"token punctuation\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span>\n    elm<span class=\"token punctuation\">:</span> Element <span class=\"token operator\">=</span> vnode<span class=\"token punctuation\">.</span>elm <span class=\"token keyword\">as</span> Element<span class=\"token punctuation\">,</span>\n    oldClass <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>oldVnode<span class=\"token punctuation\">.</span>data <span class=\"token keyword\">as</span> VNodeData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 旧的class</span>\n    klass <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>vnode<span class=\"token punctuation\">.</span>data <span class=\"token keyword\">as</span> VNodeData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span> <span class=\"token comment\">// 新的class</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>oldClass <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>klass<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token comment\">// 都不存在class,直接返回</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oldClass <span class=\"token operator\">===</span> klass<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token comment\">// 相等，直接返回</span>\n  oldClass <span class=\"token operator\">=</span> oldClass <span class=\"token operator\">||</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n  klass <span class=\"token operator\">=</span> klass <span class=\"token operator\">||</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// 删除那些存在oldVnode上而不存在vnode上的</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>name <span class=\"token keyword\">in</span> oldClass<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>klass<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      elm<span class=\"token punctuation\">.</span>classList<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// 遍历当前vnode上的class，</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>name <span class=\"token keyword\">in</span> klass<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    cur <span class=\"token operator\">=</span> klass<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span>\n    <span class=\"token comment\">//如果不想等</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>cur <span class=\"token operator\">!==</span> oldClass<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 如果值为true，则添加class，否则移除class</span>\n      <span class=\"token punctuation\">;</span><span class=\"token punctuation\">(</span>elm<span class=\"token punctuation\">.</span>classList <span class=\"token keyword\">as</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>cur <span class=\"token operator\">?</span> <span class=\"token string\">\"add\"</span> <span class=\"token punctuation\">:</span> <span class=\"token string\">\"remove\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>其他 module 的其他 hook 函数也都会对当前 vnode 更新，这里就不一一列举了。</p>\n<p>我们再来看看对 Vnode 上的钩子函数如下，</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">Hooks</span> <span class=\"token punctuation\">{</span>\n  init<span class=\"token operator\">?</span><span class=\"token punctuation\">:</span> InitHook\n  create<span class=\"token operator\">?</span><span class=\"token punctuation\">:</span> CreateHook\n  insert<span class=\"token operator\">?</span><span class=\"token punctuation\">:</span> InsertHook\n  prepatch<span class=\"token operator\">?</span><span class=\"token punctuation\">:</span> PrePatchHook\n  update<span class=\"token operator\">?</span><span class=\"token punctuation\">:</span> UpdateHook\n  postpatch<span class=\"token operator\">?</span><span class=\"token punctuation\">:</span> PostPatchHook\n  destroy<span class=\"token operator\">?</span><span class=\"token punctuation\">:</span> DestroyHook\n  remove<span class=\"token operator\">?</span><span class=\"token punctuation\">:</span> RemoveHook\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>它的触发时机以及接受参数情况如下，</p>\n<table>\n<thead>\n<tr>\n<th>Name</th>\n<th>Triggered when</th>\n<th>Arguments to callback</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code class=\"language-text\">init</code></td>\n<td>在<code class=\"language-text\">createElm</code>时会先触发<code class=\"language-text\">init</code></td>\n<td><code class=\"language-text\">vnode</code></td>\n</tr>\n<tr>\n<td><code class=\"language-text\">create</code></td>\n<td>在<code class=\"language-text\">createElm</code>时，已经建好了 element，已经对应的 children 都创建完毕，之后在触发<code class=\"language-text\">create</code></td>\n<td><code class=\"language-text\">emptyVnode</code>，<code class=\"language-text\">vnode</code></td>\n</tr>\n<tr>\n<td><code class=\"language-text\">insert</code></td>\n<td>当<code class=\"language-text\">vnode.elm</code>已经更新到 dom 文档上了，最后在<code class=\"language-text\">patch</code>函数结尾处触发</td>\n<td><code class=\"language-text\">vnode</code></td>\n</tr>\n<tr>\n<td><code class=\"language-text\">prepatch</code></td>\n<td>在<code class=\"language-text\">patchVnode</code>开始处就触发了<code class=\"language-text\">prepatch</code></td>\n<td><code class=\"language-text\">oldVnode</code>，<code class=\"language-text\">vnode</code></td>\n</tr>\n<tr>\n<td><code class=\"language-text\">update</code></td>\n<td>在<code class=\"language-text\">patchVnode</code>中，<code class=\"language-text\">vnode.elm=oldVnode.elm</code>之后，更新 children 之前触发</td>\n<td><code class=\"language-text\">oldVnode</code>，<code class=\"language-text\">vnode</code></td>\n</tr>\n<tr>\n<td><code class=\"language-text\">postpatch</code></td>\n<td>在<code class=\"language-text\">patchVnode</code>中结尾处，已经更新为 children 后触发，</td>\n<td><code class=\"language-text\">oldvnode</code>，<code class=\"language-text\">vnode</code></td>\n</tr>\n<tr>\n<td><code class=\"language-text\">destroy</code></td>\n<td>在<code class=\"language-text\">removeVnodes</code>中触发，此时还没有被移除</td>\n<td><code class=\"language-text\">vnode</code></td>\n</tr>\n<tr>\n<td><code class=\"language-text\">remove</code></td>\n<td>在<code class=\"language-text\">removeVnodes</code>中，<code class=\"language-text\">destroy</code>之后触发，此时还没有真正被移除，需调用<code class=\"language-text\">removeCallback</code>才真正将 element 移除</td>\n<td><code class=\"language-text\">vnode</code>，<code class=\"language-text\">removeCallback</code></td>\n</tr>\n</tbody>\n</table>\n<p>在<code class=\"language-text\">Vnode</code>上的钩子函数就是我们自己定义的了，定义在<code class=\"language-text\">data.hooks</code>中，例如，</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token function\">h</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"div.row\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  key<span class=\"token punctuation\">:</span> movie<span class=\"token punctuation\">.</span>rank<span class=\"token punctuation\">,</span>\n  hook<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function-variable function\">insert</span><span class=\"token punctuation\">:</span> <span class=\"token parameter\">vnode</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      movie<span class=\"token punctuation\">.</span>elmHeight <span class=\"token operator\">=</span> vnode<span class=\"token punctuation\">.</span>elm<span class=\"token punctuation\">.</span>offsetHeight\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h3>小结</h3>\n<p>在看了源码之后，其实最为复杂的地方就是<code class=\"language-text\">updateChildren</code>中更新子节点，这里为了避免重复创建 element，而做了很多的判断和比较，以达到最大化的复用之前已经创建好的 element。与 React 和 Vue 类似，它在比较中也添加了<code class=\"language-text\">key</code>来优化这一点。在更新 Vnode 对应的 element 时，它将不同数据分解到不同 module 中去更新，通过钩子函数来触发，这一点非常的优雅。</p>","frontmatter":{"title":"理解virtual dom的实现细节-snabbdom","date":"December 31, 2018"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/post/understand_the_details_of_vritual_dom_snabbdom/","previous":{"fields":{"slug":"/post/resolve_issue_of_using_audio/"},"frontmatter":{"title":"HTML5中Audio使用踩坑汇总"}},"next":{"fields":{"slug":"/post/understand_the_details_of_h5_and_native(ios)_communication/"},"frontmatter":{"title":"理解h5与native(ios)通信细节"}}}}