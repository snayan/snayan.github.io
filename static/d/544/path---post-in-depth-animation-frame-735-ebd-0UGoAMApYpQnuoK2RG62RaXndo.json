{"data":{"avatar":{"childImageSharp":{"fixed":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGAABAAMBAAAAAAAAAAAAAAAAAAIEBQP/xAAWAQEBAQAAAAAAAAAAAAAAAAACAQD/2gAMAwEAAhADEAAAAcSerUQpOzXUqiMAb//EABsQAAMAAgMAAAAAAAAAAAAAAAABAhESAxQh/9oACAEBAAEFAjzJ1VJcZepyU9x0z//EABURAQEAAAAAAAAAAAAAAAAAABEg/9oACAEDAQE/AWP/xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/AR//xAAbEAADAAIDAAAAAAAAAAAAAAAAASEQERIxMv/aAAgBAQAGPwImPUNtcTodiz//xAAcEAACAgMBAQAAAAAAAAAAAAAAAREhMUFRYXH/2gAIAQEAAT8hWbK7l6NWStvasZEW4S7fwfTTAkNzkQZ//9oADAMBAAIAAwAAABAs1wP/xAAXEQEBAQEAAAAAAAAAAAAAAAABABEQ/9oACAEDAQE/EMLbwL//xAAXEQEBAQEAAAAAAAAAAAAAAAABEQAQ/9oACAECAQE/EIzR4rv/xAAfEAEAAwACAQUAAAAAAAAAAAABABEhMUFRYXGBodH/2gAIAQEAAT8QAjVRsF68R3WyhBpEB4otans9oxQXOZRxVfkow9YivuDFJrEfPmaECm2kqIiV2XP/2Q==","width":40,"height":40,"src":"/static/9d156e8486b343189790da372acb0018/987ea/my.jpg","srcSet":"/static/9d156e8486b343189790da372acb0018/987ea/my.jpg 1x,\n/static/9d156e8486b343189790da372acb0018/9c097/my.jpg 1.5x,\n/static/9d156e8486b343189790da372acb0018/bd6c6/my.jpg 2x"}}},"site":{"siteMetadata":{"title":"三羊的小站","author":"三羊","menu":{"search":{"name":"搜索","link":"/search"}}}},"markdownRemark":{"id":"e16c8204-3dce-5b7d-b092-db1504ba5393","excerpt":"在前端性能优化策略中，耳熟能详的手段有，雅虎 35 条军规，使用 cache，减少请求数量，使用cookie-free domain，critical asset，使用 CDN，Lazy load，PreLoad…","html":"<p>在前端性能优化策略中，耳熟能详的手段有，<a href=\"https://developer.yahoo.com/performance/rules.html?guccounter=1\">雅虎 35 条军规</a>，使用 cache，减少请求数量，使用<a href=\"https://www.keycdn.com/support/how-to-use-cookie-free-domains\">cookie-free domain</a>，<a href=\"https://developers.google.com/web/fundamentals/performance/critical-rendering-path/optimizing-critical-rendering-path\">critical asset</a>，使用 CDN，Lazy load，PreLoad 等，这些手段其实主要都是围绕怎么样更快的拿到所需关键资源。当我们把这一步做到很好，没有可优化空间了，其实还可以从另外一个方向去做优化，那就是浏览器渲染方面。浏览器渲染优化是一个很大的主题，今天，我们只谈它一个小角度，动画帧。从动画帧，我们可以怎么样来做一些优化工作呢？本文篇幅较长，图较多，耐心看完，一定会有很多收获的。</p>\n<h4>基础概念</h4>\n<p>先还是来熟悉基础概念。帧，可以理解为浏览器每一次绘制的快照。1s 内绘制的次数，叫做帧率，也就是我们常说的 fps（frame per second）。帧率越大，浏览器在 1s 内绘制的次数就越多，动画就越流畅。人们视觉系统对帧率的最低要求一般是 24fps，当帧率低于 24 时，就会感觉到明显的卡顿了。不同的移动设备，有不同的帧率，一般默认是 60fps。</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4c0b0a52cee623505e851dc3635e2050/3b243/frame.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 28.80859375%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsSAAALEgHS3X78AAABAUlEQVQY02NYtHpj8PyV670WrNrgvWDlem8g7QPFILb3fJgYhEZWA+OD9PoDscmEmfMZGBat2XRl8drNL4H4KRA/A2Gg2DMYGyr+FFkeDYPEnwPxwyXrttgyOHn6C09fuJyve8osvp6ps/l6ps3h6wbSvUC6a/JMvtq2HoG69l4BEA3ig8RBanqgakB03/R5vG39U0WqW7r4GICAnQE/YAFiDiBmYyAMmBiATl22dP3WhUDnzgfSi6D0QiBeAKOBYguhbLAaIJ4HFFsEVrMOLLYEiGet2LRDgQEokQg0NAeIM6A4CyiWDqJhfBANFMsE0jAMEksHioH0pUH5ecCw1wAA4r/tnDSw2qsAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    ></span>\n    <picture>\n        <source\n          srcset=\"/static/4c0b0a52cee623505e851dc3635e2050/cc182/frame.webp 148w,\n/static/4c0b0a52cee623505e851dc3635e2050/f7e40/frame.webp 295w,\n/static/4c0b0a52cee623505e851dc3635e2050/1a2f4/frame.webp 590w,\n/static/4c0b0a52cee623505e851dc3635e2050/4837b/frame.webp 885w,\n/static/4c0b0a52cee623505e851dc3635e2050/86447/frame.webp 1024w\"\n          sizes=\"(max-width: 590px) 100vw, 590px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/4c0b0a52cee623505e851dc3635e2050/cf440/frame.png 148w,\n/static/4c0b0a52cee623505e851dc3635e2050/d2d38/frame.png 295w,\n/static/4c0b0a52cee623505e851dc3635e2050/b9e4f/frame.png 590w,\n/static/4c0b0a52cee623505e851dc3635e2050/f9b6a/frame.png 885w,\n/static/4c0b0a52cee623505e851dc3635e2050/3b243/frame.png 1024w\"\n          sizes=\"(max-width: 590px) 100vw, 590px\"\n          type=\"image/png\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n          src=\"/static/4c0b0a52cee623505e851dc3635e2050/b9e4f/frame.png\"\n          alt=\"frame\"\n          title=\"\"\n        />\n      </picture>\n  </span>\n  </a></p>\n<p>我们要追求的理想帧率是 60fps，那么一帧绘制的时间最多是 1 / 60 = 16.7ms，一旦超过这个数，就达不到 60fps 了。为了使得一帧花费的时间控制在 16.7ms 内，我们必须先搞清楚浏览器在一帧会做些什么事情呢？</p>\n<h4>帧任务</h4>\n<p>html，js，css 是浏览器处理最为常见的三种资源，也是我们前端工程师每天都会打交道的文件。可是我们真正知道浏览器是怎么绘制的吗？稍微思考一下，然后会说，html 解析为 dom tree，css 解析为 cssom tree，然后 dom tree 加上 cssom tree 就合并为 render tree，最后浏览器根据 render tree 绘制到屏幕上。这是我们最为熟知的步骤，但是它只是描述了一个整体大致的过程，并没有具体到一帧的绘制过程。下面看看一帧具体绘制的过程图。</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b47e67fb8c9559948b922b13ba8df45a/3b243/step.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 15.234375%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsSAAALEgHS3X78AAAA6ElEQVQI1x3OwUrCAACAYR+uXqKTlwq7FBThxUE9hIQdIogOLRV12HCsVbqQwUJH6bbaSlcZoejKufDyVx6/25eYhzaznkj8KhEHZX7eK3itAa36FOs2pGN80W6EtP9tfnDj19BcGd2/pO6paI8y1081FKeCP3RJzLxjRuoy4+Yqo0aSqb6EnC1ykBlyKLyQywTkhD5H+29k92y28ynSUorNQpKd0hq75XWE6hYb4goF65TEfPxA5J8Q9fJEz2fEfRHHCDCUb+6uJlh6iKlNMNU/NweLyUWnuFiqThW5W0KxJaT7c9zPLr+4L8ODojnt9AAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    ></span>\n    <picture>\n        <source\n          srcset=\"/static/b47e67fb8c9559948b922b13ba8df45a/cc182/step.webp 148w,\n/static/b47e67fb8c9559948b922b13ba8df45a/f7e40/step.webp 295w,\n/static/b47e67fb8c9559948b922b13ba8df45a/1a2f4/step.webp 590w,\n/static/b47e67fb8c9559948b922b13ba8df45a/4837b/step.webp 885w,\n/static/b47e67fb8c9559948b922b13ba8df45a/86447/step.webp 1024w\"\n          sizes=\"(max-width: 590px) 100vw, 590px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/b47e67fb8c9559948b922b13ba8df45a/cf440/step.png 148w,\n/static/b47e67fb8c9559948b922b13ba8df45a/d2d38/step.png 295w,\n/static/b47e67fb8c9559948b922b13ba8df45a/b9e4f/step.png 590w,\n/static/b47e67fb8c9559948b922b13ba8df45a/f9b6a/step.png 885w,\n/static/b47e67fb8c9559948b922b13ba8df45a/3b243/step.png 1024w\"\n          sizes=\"(max-width: 590px) 100vw, 590px\"\n          type=\"image/png\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n          src=\"/static/b47e67fb8c9559948b922b13ba8df45a/b9e4f/step.png\"\n          alt=\"step\"\n          title=\"\"\n        />\n      </picture>\n  </span>\n  </a></p>\n<p>上图就是浏览器在绘制一帧时，会经过的处理步骤。</p>\n<ul>\n<li>JavaScript，我们会通过 js 来改动一些视觉效果，比如基于 js 的动画，或者响应用户事件等。</li>\n<li>Style，如果通过 js 改变了某一个 dom 的样式，就会重新计算受影响的元素的样式。</li>\n<li>Layout，如果样式改变中涉及了布局属性，例如 top，left，width 等几何位置，还会重新计算它的布局位置，以及受影响的其他元素的布局。当然，如果不涉及布局样式，也不会执行这一步。</li>\n<li>Paint，计算出 Style 和 Layout 后，就可以把元素绘制到它所属的 paint layer 上。</li>\n<li>Composite，最后会将多个 composite layer 输出到屏幕上显示出来。</li>\n</ul>\n<p>要控制一帧的执行时间在 16.7ms 内，就只需要把上述 5 个步骤处理时间总和控制在 16.7ms 内。接下来，我们一个步骤一个步骤来看，有哪些优化建议。</p>\n<h4>JavaScript</h4>\n<h5>requestAnimationFrame</h5>\n<p>JavaScript 是前端工程师的利器，有了它，我们可以实现非常复杂的系统，或者非常流畅的游戏等。JavaScript 通常会处理用户输入或者点击等事件，然后做一系列的视觉效果的改变。<strong>当涉及 dom 元素改变时，总是把操作放在 <code class=\"language-text\">requestAnimationFrame</code>中</strong>。</p>\n<p><code class=\"language-text\">requestAnimationFrame</code>会有什么神奇之处呢？</p>\n<ul>\n<li>它总是会确保 fn 的执行在浏览器一帧的开头</li>\n<li>浏览器会自动调节帧率，间接调节了 fn 的执行频率</li>\n</ul>\n<p>在不支持 raf 的浏览器中，通常使用<code class=\"language-text\">setTimeout(fn, 16.7)</code>来实现。但是<code class=\"language-text\">setTimeout</code>有一些不好的地方，</p>\n<ul>\n<li>它并不是保证 fn 每隔 16.7ms 就执行一次，它只能每 16.7ms 将 fn 加入到<a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/EventLoop\">MacroTask Queue</a>中，具体什么时候执行，要根据当前执行队列决定</li>\n<li>它不能保证每次执行时机都是一帧的开头，可能某一次执行触发是在帧的中间或者结尾，导致延长当前帧在 16.7ms 内无法执行完成，就会出现丢失当前帧</li>\n<li>不同设备帧率不一样，并不是固定的 60fps，给低帧率（比如 30fps）的设备上执行<code class=\"language-text\">setTimeout(fn, 16.7)</code>将会导致执行很多无意义的 fn</li>\n</ul>\n<p>我们先使用<code class=\"language-text\">setTimeout</code>来实现，每 16.7ms 就更新一次小球的位置，这样尽量保证了 1s 内更新 60 次。</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">// 使用setTimeout来实现小球下落的动画</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">animtionWithSetTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">updateBoll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token function\">animtionWithSetTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">16.7</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>然后，我们通过 Chrome 的 Performance 来分析当前帧率情况如下，</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e41ad9a6a77d2b46ae8bb7d4281e149c/3b243/setTimeout.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 34.765625%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAABUUlEQVQoz1VQa0+DQBDk//8qo7EaE2ubqE2rPO4AueM4oHC8KeMC1eiHyczOzuwRLL5/hP1yD3f/AGdHvNv88sf2Dg7B297Ceb6lzOZ/5u9MffvpBhb3XPjMA/c8sEUzcDZrD19hCP/zhODwivB0II92rnvNEhbNVk1wHQeWVDF46COKBaRW8AKOUEaIErnqWNIsYHO2aq1h00OBUgiShHyOQAgE1HFcOmgHES0EmKKQFlBVjqQ+QzfForVJEflHCMmhqxRZcIQOT0iFg0w6UIVC2hnEuYRg7/SFWYe6A8p6gmmmRVctFq57ghlQKIa6qBfdSIUm1qj1GU2SLV49AEVaIfHeYKliXIplO6GiI4a4bC8rz3PZIk8zmPRMHvkjZelASR0zrL05a6hc0m+zojhB2w0YxumKC3rCz9z3I0ZTYmga8tf9MFwxZ688Z3OT4xscowtkbqt80gAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    ></span>\n    <picture>\n        <source\n          srcset=\"/static/e41ad9a6a77d2b46ae8bb7d4281e149c/cc182/setTimeout.webp 148w,\n/static/e41ad9a6a77d2b46ae8bb7d4281e149c/f7e40/setTimeout.webp 295w,\n/static/e41ad9a6a77d2b46ae8bb7d4281e149c/1a2f4/setTimeout.webp 590w,\n/static/e41ad9a6a77d2b46ae8bb7d4281e149c/4837b/setTimeout.webp 885w,\n/static/e41ad9a6a77d2b46ae8bb7d4281e149c/86447/setTimeout.webp 1024w\"\n          sizes=\"(max-width: 590px) 100vw, 590px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/e41ad9a6a77d2b46ae8bb7d4281e149c/cf440/setTimeout.png 148w,\n/static/e41ad9a6a77d2b46ae8bb7d4281e149c/d2d38/setTimeout.png 295w,\n/static/e41ad9a6a77d2b46ae8bb7d4281e149c/b9e4f/setTimeout.png 590w,\n/static/e41ad9a6a77d2b46ae8bb7d4281e149c/f9b6a/setTimeout.png 885w,\n/static/e41ad9a6a77d2b46ae8bb7d4281e149c/3b243/setTimeout.png 1024w\"\n          sizes=\"(max-width: 590px) 100vw, 590px\"\n          type=\"image/png\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n          src=\"/static/e41ad9a6a77d2b46ae8bb7d4281e149c/b9e4f/setTimeout.png\"\n          alt=\"setTimeout\"\n          title=\"\"\n        />\n      </picture>\n  </span>\n  </a></p>\n<p>帧率上会有一些锯齿，表示有部分情况是低于 60fps 的。并且在上图中，某一帧中执行了两次<code class=\"language-text\">updateBoll</code>，第二次的<code class=\"language-text\">updateBoll</code>是在帧快结束时触发的，所以拉长了当前帧执行的时间。</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/db3b1864ff7ef0d145e6d4e38ffb273b/3b243/setTimeout2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 75%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAABjklEQVQ4y62UTW7UQBCFfYNwAS4QcSbW2SKx4wLcAA6AhJBCUCR+FrCBFQixISIoi5DEVsbQGo/d/ulf2x9tR2RiYGAijaXnLrmqX9Xr13LEhp+o7/sxGNZV+JVfi3Cd4nXJJhMWyhFnmu/S8iNAlJZkoamNv96ES0I/kgyE57khbxxCGirtriu5nxQvmg7b9v+U/Pu5X/12MeGVxLzyKGPHuM0E/vSEboi7NqC7xCrTomXX8c1MQnmhEv/1jO7Fy9Vm/UVBVBQFzrnLdJEd0yR79OIVJn2KOD3g5MjwJvnMfvyR5/Ennp19YKZzVNWgtJrIj4QQE0KSh7Svb2DebdO/3eLLo3s8uL/g1pM73NzbYXv/LluPb7ObvKetNFVdT01J0xQp5UhqrUPVC3QZ45oZ8/SQ8/gbZRGcl3PiQpAMkILaaoa9WZbhvA97LT6sUR06VFWFDYTGmEBeoW0XikCGCYqyxLeWzrc4bdBBZnAFF5rneU4Z8gPZAKXU0pQ/j7tfbcL/LvYmEW36b/MTCLyNv9H6rOwAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    ></span>\n    <picture>\n        <source\n          srcset=\"/static/db3b1864ff7ef0d145e6d4e38ffb273b/cc182/setTimeout2.webp 148w,\n/static/db3b1864ff7ef0d145e6d4e38ffb273b/f7e40/setTimeout2.webp 295w,\n/static/db3b1864ff7ef0d145e6d4e38ffb273b/1a2f4/setTimeout2.webp 590w,\n/static/db3b1864ff7ef0d145e6d4e38ffb273b/4837b/setTimeout2.webp 885w,\n/static/db3b1864ff7ef0d145e6d4e38ffb273b/86447/setTimeout2.webp 1024w\"\n          sizes=\"(max-width: 590px) 100vw, 590px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/db3b1864ff7ef0d145e6d4e38ffb273b/cf440/setTimeout2.png 148w,\n/static/db3b1864ff7ef0d145e6d4e38ffb273b/d2d38/setTimeout2.png 295w,\n/static/db3b1864ff7ef0d145e6d4e38ffb273b/b9e4f/setTimeout2.png 590w,\n/static/db3b1864ff7ef0d145e6d4e38ffb273b/f9b6a/setTimeout2.png 885w,\n/static/db3b1864ff7ef0d145e6d4e38ffb273b/3b243/setTimeout2.png 1024w\"\n          sizes=\"(max-width: 590px) 100vw, 590px\"\n          type=\"image/png\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n          src=\"/static/db3b1864ff7ef0d145e6d4e38ffb273b/b9e4f/setTimeout2.png\"\n          alt=\"setTimeout2\"\n          title=\"\"\n        />\n      </picture>\n  </span>\n  </a></p>\n<p>然后，我们使用<code class=\"language-text\">requestAnimationFrame</code>来实现它。</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">// 使用requestAnimationFrame来实现小球下落</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">animationWithRaf</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">updateBoll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token function\">requestAnimationFrame</span><span class=\"token punctuation\">(</span>animationWithRaf<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>同样，使用 Chrome 的 Performance 来分析当前帧率情况如下，</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/bd95ab6ef5f71c0d46065e6aa941114f/3b243/raf.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 32.6171875%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAABO0lEQVQoz11P2ZaCMBTj/79sjs7iLqJCoYVSVBwFpYCauW2d5cxDTpKbtLf1VqMXbCYDBE82PvFHiJcj8NUY2+kQIpgg9sdgNAvGA4SLd/Iu/89evFkgIbD1HPHa6CVYMLeekY9tRjx7QzJ9BV98EA/BVjPbj0w3cGdDfwYv4RKcp1B5gVRk4ImAzHIImgnyhdrZXEYR8igEX28gwy2yVCJ5du050+eCLiw4gjTANqPygSMhqLqwzEvh9J4jVAzZuQAjnVUK8qzACmbzKGeIFC2sJLxjdcX+VEOVJ1T6hrrpkO8OqNsH4W5x6R4uIxhtIHcl9ufGatcznTs83QOXFrh2jqtrj89Ko2qoqA3whNNmfiEu6bJj3Vv9nZvM0+0NmrY03d2y7s2mFk376y2b/Ec/6AHmN62b/Zl/AQyvCsdJKoRWAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    ></span>\n    <picture>\n        <source\n          srcset=\"/static/bd95ab6ef5f71c0d46065e6aa941114f/cc182/raf.webp 148w,\n/static/bd95ab6ef5f71c0d46065e6aa941114f/f7e40/raf.webp 295w,\n/static/bd95ab6ef5f71c0d46065e6aa941114f/1a2f4/raf.webp 590w,\n/static/bd95ab6ef5f71c0d46065e6aa941114f/4837b/raf.webp 885w,\n/static/bd95ab6ef5f71c0d46065e6aa941114f/86447/raf.webp 1024w\"\n          sizes=\"(max-width: 590px) 100vw, 590px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/bd95ab6ef5f71c0d46065e6aa941114f/cf440/raf.png 148w,\n/static/bd95ab6ef5f71c0d46065e6aa941114f/d2d38/raf.png 295w,\n/static/bd95ab6ef5f71c0d46065e6aa941114f/b9e4f/raf.png 590w,\n/static/bd95ab6ef5f71c0d46065e6aa941114f/f9b6a/raf.png 885w,\n/static/bd95ab6ef5f71c0d46065e6aa941114f/3b243/raf.png 1024w\"\n          sizes=\"(max-width: 590px) 100vw, 590px\"\n          type=\"image/png\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n          src=\"/static/bd95ab6ef5f71c0d46065e6aa941114f/b9e4f/raf.png\"\n          alt=\"raf\"\n          title=\"\"\n        />\n      </picture>\n  </span>\n  </a></p>\n<p>帧率明显稳定在 60fps 左右，没有上面出现的锯齿了，确保了每一帧中都只会触发一次<code class=\"language-text\">updateBoll</code>。</p>\n<h5>分块执行</h5>\n<p>JavaScript 的执行是在一帧的开头，JavaScript 执行的时间越长，那么当前帧花费的时间就越长。当浏览器要开始更新屏幕了，如果当前帧还未完成，那么当前帧就会被丢弃，延迟到一下次更新，表现出来的就是丢帧。我们应该尽可能缩短 JavaScript 的执行时间，通常不要超过 10ms，因为后面的 Style，Layout，Paint，Composite 至少要花费 6ms 的时间。</p>\n<p>当有一个大任务，需要长时间的执行时，我们可以把它分散到每一帧中去完成其中一小部分。这样，可以缩短在每帧中执行的时间。我们来看一个例子，比如要在一帧里绘制 100 个小球，假设需要花费 3s 的时间。</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">function</span> <span class=\"token function\">createBoll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">sleep</span><span class=\"token punctuation\">(</span><span class=\"token number\">30</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// 模拟30ms操作</span>\n  <span class=\"token keyword\">const</span> boll <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"div\"</span><span class=\"token punctuation\">)</span>\n  boll<span class=\"token punctuation\">.</span>classList<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"boll\"</span><span class=\"token punctuation\">)</span>\n  boll<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>background <span class=\"token operator\">=</span> <span class=\"token function\">randomColor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  document<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span>boll<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token constant\">COUNT</span> <span class=\"token operator\">=</span> <span class=\"token number\">100</span>\n\n<span class=\"token comment\">/* 直接执行大任务 */</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">longTask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">requestAnimationFrame</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token constant\">COUNT</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">createBoll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2b121f5be71de543c8838cc5b3796715/86682/longTask.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 33.24764353041988%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABdUlEQVQozz2OTW/aQBRF/b+76DZp81e6aNplG6kSAicFIoXyEezY4xkbhzG1ISEYEzUnzwPq4ujed9/Vm/GM0ZhswWJ6y/rB5ykZUEU3Tjeqzzr+7dRlekgV9HgMJ5hFTmoMaZZhTEommiQJXqoVJs2w0Ygm/kqjvgmX7ONLp863KvM++U4TfJGDI1RiSJRCCe0hLQRBgJfJS0prlnbF/gAv9T/qBhrxu/rN0ea1271xGHRYyM/CWBGrRA5rIvFRFBGGIZ5eKhaVoawLqmZFvkn5u7NsXkvsNieXnS01K/HLeMgmH7OW3rLS0it4el1L75Hlc87LYYsXjm+IZ0PCSZ8sGrPK5lgzcxTpPVZPsVOfYtJlNfOx8Z3zxcMttt2fekU6o8pTvM6PD1x3zhj4Z0yG58zvWj4RnHD+z4VjPro45u08+iz+/DiLn/Y/yod+4f20mu6upFdX+HuhPtL7ryVd4ZiXbm5995S3vet6zVWZEW6feQfN2ve7MzsDqgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    ></span>\n    <picture>\n        <source\n          srcset=\"/static/2b121f5be71de543c8838cc5b3796715/cc182/longTask.webp 148w,\n/static/2b121f5be71de543c8838cc5b3796715/f7e40/longTask.webp 295w,\n/static/2b121f5be71de543c8838cc5b3796715/1a2f4/longTask.webp 590w,\n/static/2b121f5be71de543c8838cc5b3796715/4837b/longTask.webp 885w,\n/static/2b121f5be71de543c8838cc5b3796715/2f819/longTask.webp 1180w,\n/static/2b121f5be71de543c8838cc5b3796715/a083a/longTask.webp 2334w\"\n          sizes=\"(max-width: 590px) 100vw, 590px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/2b121f5be71de543c8838cc5b3796715/cf440/longTask.png 148w,\n/static/2b121f5be71de543c8838cc5b3796715/d2d38/longTask.png 295w,\n/static/2b121f5be71de543c8838cc5b3796715/b9e4f/longTask.png 590w,\n/static/2b121f5be71de543c8838cc5b3796715/f9b6a/longTask.png 885w,\n/static/2b121f5be71de543c8838cc5b3796715/2d849/longTask.png 1180w,\n/static/2b121f5be71de543c8838cc5b3796715/86682/longTask.png 2334w\"\n          sizes=\"(max-width: 590px) 100vw, 590px\"\n          type=\"image/png\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n          src=\"/static/2b121f5be71de543c8838cc5b3796715/b9e4f/longTask.png\"\n          alt=\"longTask\"\n          title=\"\"\n        />\n      </picture>\n  </span>\n  </a></p>\n<p>可以明显的看到，这一帧里花费了 3022.7ms，期间页面一直是上一帧的内容（空白）。只有等到任务完成了，才会全部显示小球出来。下面，我们把这个长任务分散到每一帧里执行，每一帧只创建一个小球。</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">/* 分块执行小任务 */</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">chunkTask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n  <span class=\"token function\">requestAnimationFrame</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token function\">doOne</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 每一帧，只创建一个小球</span>\n    <span class=\"token function\">createBoll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    i<span class=\"token operator\">++</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">&lt;</span> <span class=\"token constant\">COUNT</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">requestAnimationFrame</span><span class=\"token punctuation\">(</span>doOne<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2cbe755a17f683dbd90265448ef336ea/2ad13/chunkTask.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 35.24871355060035%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABpklEQVQozyWNyVIaYRSFef8HSFLGKrViKpskK8FEC1ERBGXquUF6+nti7IYMSFZfLsnqnHvuGSp5npMkMWmSkKap8DF5bjENHaJ4TBA5BKFNpFyCwJb/lDBwUGqMisZEwhN1QJdYhVTiOBaTFEmZUjGrzKAIbwieawSjKwKtjmfe4Zu3+NY9vt74jwfNbuI7bTy7ReA+MnEtKUwzPNfGG9u8OIaspKReQFT9RNio4rfqhHofv98mNAYy1JSRHqH2LMWa5Bz8iSNoYYteUaki9l3ymWKxiFkuE2bzmPWvgkUxZ77OKTeCy5R1kbMuZywOvMz/3QvxFkXGapWQpQEVe9Bg0v2K1/2M2/6CGlWZmZdEgwsSrUpmfsMTnhk1uWuEwyq58FgTz/CCXLzh8JJEr6G071SGLzc0nt7zYJ7woJ9z3XlLyzql0Tvluv2OzuiMZueY2/6ReD5Q7x5xNzqmZZ5z9fiGpnHC/fCM+pPk9I9UrHLHoNzQ/71D3+3oFyXa/pXhj5+Myi2+4HS1ZSSoiz4oSwa7V4z9nl6xEe8fNMk+b7ZYov8Foa3stVu7gw8AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    ></span>\n    <picture>\n        <source\n          srcset=\"/static/2cbe755a17f683dbd90265448ef336ea/cc182/chunkTask.webp 148w,\n/static/2cbe755a17f683dbd90265448ef336ea/f7e40/chunkTask.webp 295w,\n/static/2cbe755a17f683dbd90265448ef336ea/1a2f4/chunkTask.webp 590w,\n/static/2cbe755a17f683dbd90265448ef336ea/4837b/chunkTask.webp 885w,\n/static/2cbe755a17f683dbd90265448ef336ea/2f819/chunkTask.webp 1180w,\n/static/2cbe755a17f683dbd90265448ef336ea/8ac1c/chunkTask.webp 2332w\"\n          sizes=\"(max-width: 590px) 100vw, 590px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/2cbe755a17f683dbd90265448ef336ea/cf440/chunkTask.png 148w,\n/static/2cbe755a17f683dbd90265448ef336ea/d2d38/chunkTask.png 295w,\n/static/2cbe755a17f683dbd90265448ef336ea/b9e4f/chunkTask.png 590w,\n/static/2cbe755a17f683dbd90265448ef336ea/f9b6a/chunkTask.png 885w,\n/static/2cbe755a17f683dbd90265448ef336ea/2d849/chunkTask.png 1180w,\n/static/2cbe755a17f683dbd90265448ef336ea/2ad13/chunkTask.png 2332w\"\n          sizes=\"(max-width: 590px) 100vw, 590px\"\n          type=\"image/png\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n          src=\"/static/2cbe755a17f683dbd90265448ef336ea/b9e4f/chunkTask.png\"\n          alt=\"chunkTask\"\n          title=\"\"\n        />\n      </picture>\n  </span>\n  </a></p>\n<p>现在每一帧都只花费了 30ms 左右，并且页面不会空等 3s 才显示小球，而是小球逐个绘制出来了，体验明显好多了。</p>\n<h5>其他最佳实践</h5>\n<p>对于 JavaScript 步骤，还有其他一些很好的建议，下面简单列举出来，就不做 demo 了，</p>\n<ul>\n<li>将一些纯计算型，不涉及 dom 访问的任务，放到<a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers\">Web Workers</a>中</li>\n<li>对于可以使用 css3 来实现的动画，就不需要用 JavaScript 来实现了</li>\n<li>对于用户事件的响应，同步执行时间不要太长，逻辑尽量简单，复杂的逻辑可以延迟处理或分块处理</li>\n</ul>\n<h4>Style &#x26; Layout</h4>\n<h5>先读取，后设置</h5>\n<p>使用 JavaScript 来绘制动画时，我们往往需要根据当前 dom 状态（比如位置，大小）来更新它的状态。通常的最佳实践是，<strong>先读取，后设置</strong>。在 raf 中，页面 dom 元素样式都已经在上一帧中计算好了，在读取某一个 dom 样式时，不会触发浏览器重新计算样式和布局。但是，如果我们是先设置，然后在读取，那么这个 dom 样式已经被改变了，为了保证获取到正确的样式值，浏览器必须重新对当前 dom 进行样式计算，如果还涉及布局改变，也会进行重新布局，这种情况就是我们通常说的<strong>触发了 reflow</strong>。</p>\n<p>下面我们来验证一下，在 raf 中，每次都是先设置了小球的 top，然后再读取它的 offsetTop 和屏幕的 offsetHeight。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">reflow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">requestAnimationFrame</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    boll<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>top <span class=\"token operator\">=</span> boll<span class=\"token punctuation\">.</span>offsetTop <span class=\"token operator\">+</span> <span class=\"token number\">2</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"px\"</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>boll<span class=\"token punctuation\">.</span>offsetTop <span class=\"token operator\">&lt;</span> document<span class=\"token punctuation\">.</span>documentElement<span class=\"token punctuation\">.</span>offsetHeight<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">reflow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/178c230bdd62458e9423566256b1e95f/3b243/reflow2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 43.65234375%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAABcklEQVQoz42RW2/TQBCF/f+f4alvPPAPqMQlElJVUUApqtLSQGrXudpZX+L1rneT+PKxaUpFC1EZ7dGMzpmdnZn1krxkFEy4HnzBH7xlfN1jOuwR/ewhRu+JbvtcDSKuLqcMgktm0ZJwPufrsE9WVpgNKNtQOb9MMrxdoNaQJTPCi9ecfHjBu+OXfDp7xXn/iCg+YxJawnFBIGbkypJIxXDuU7jLdgtrB+MQLVNX0AV3ZA3uEEkY/bD433Nu4oZYG7JVQVlZ6vaP3HbvU60Z5zHSCYXUrqAqMVXlujRoa9hGPvXNBZuVYG011mlVZTDGYu0O6zuYXe6mZpKGfA5OEYWg3jZ4oX/LdLJgGgwRJ28Q305JljlJkpNlGUopyrI8AEnlJti4ebXSSCnxVosFzWwM5x9BSzoeW9c9Zf7W2659yPMKVyyLM7fUPdG1e/E5HCruiVSi3X7uGf7XDj3kxSIlThXGfVnbNjTN8/jd4b+6/QXNb7GTJbEQDwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    ></span>\n    <picture>\n        <source\n          srcset=\"/static/178c230bdd62458e9423566256b1e95f/cc182/reflow2.webp 148w,\n/static/178c230bdd62458e9423566256b1e95f/f7e40/reflow2.webp 295w,\n/static/178c230bdd62458e9423566256b1e95f/1a2f4/reflow2.webp 590w,\n/static/178c230bdd62458e9423566256b1e95f/4837b/reflow2.webp 885w,\n/static/178c230bdd62458e9423566256b1e95f/86447/reflow2.webp 1024w\"\n          sizes=\"(max-width: 590px) 100vw, 590px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/178c230bdd62458e9423566256b1e95f/cf440/reflow2.png 148w,\n/static/178c230bdd62458e9423566256b1e95f/d2d38/reflow2.png 295w,\n/static/178c230bdd62458e9423566256b1e95f/b9e4f/reflow2.png 590w,\n/static/178c230bdd62458e9423566256b1e95f/f9b6a/reflow2.png 885w,\n/static/178c230bdd62458e9423566256b1e95f/3b243/reflow2.png 1024w\"\n          sizes=\"(max-width: 590px) 100vw, 590px\"\n          type=\"image/png\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n          src=\"/static/178c230bdd62458e9423566256b1e95f/b9e4f/reflow2.png\"\n          alt=\"reflow2\"\n          title=\"\"\n        />\n      </picture>\n  </span>\n  </a></p>\n<p>通过分析，可以看到在 JavaScript 中就触发了 Recalculation Forced 和 Layout Forced。现在我们优化一下，先读取它的 offsetTop 和屏幕的 offsetHeight 值，然后在去设置它的 top</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">optimizeReflow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">requestAnimationFrame</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> top <span class=\"token operator\">=</span> boll<span class=\"token punctuation\">.</span>offsetTop\n    <span class=\"token keyword\">const</span> bodyHeight <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span>documentElement<span class=\"token punctuation\">.</span>offsetHeight\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>top <span class=\"token operator\">>=</span> bodyHeight<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span>\n    <span class=\"token punctuation\">}</span>\n\n    boll<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>top <span class=\"token operator\">=</span> top <span class=\"token operator\">+</span> <span class=\"token number\">2</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"px\"</span>\n    <span class=\"token function\">optimizeReflow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9029df8aba03de13db17654e20ed714e/3b243/reflow4.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 44.140625%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAABTElEQVQoz52S3W6cMBBGef936Dv0FXqXi+xvFTVRidhsGsBgsA0YL7vA6exmo+aiVaW1feSxx/N5xnKkak9lPUo7StORqYr44RvJ5iu7pwWb5RurTcpq+cp6mbB4WpEVFdv4ge/JD8IRusOEH6DtR6L2wGXxQdPPlL+2rBdfSPZb8nxknwaedxU/44zHXXxJIDU1b7Wml5ggHM7CYRbBMBFOXDhcER/dGbFlMEyyN18Z388O47vtxZm5GtVaau+Jkt0eqzXWWExjsFYwFZ1tcLLXdh19Hz7RE8KfufUN98kd65d7XsqE6DFOydKUUil5x4KiyFEqw9YOUxucc3Qi+i+8cJSUj/KYQS6MtJbMJGiapa4b2yyx8zxz7pFrHFoV2NJeSpimq/NGoq7zaOM5DsMNmf1FsKo0aZbzmjsa+TfTeOJ0+j/n4M+iH+03G8S2rK3UmdkAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    ></span>\n    <picture>\n        <source\n          srcset=\"/static/9029df8aba03de13db17654e20ed714e/cc182/reflow4.webp 148w,\n/static/9029df8aba03de13db17654e20ed714e/f7e40/reflow4.webp 295w,\n/static/9029df8aba03de13db17654e20ed714e/1a2f4/reflow4.webp 590w,\n/static/9029df8aba03de13db17654e20ed714e/4837b/reflow4.webp 885w,\n/static/9029df8aba03de13db17654e20ed714e/86447/reflow4.webp 1024w\"\n          sizes=\"(max-width: 590px) 100vw, 590px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/9029df8aba03de13db17654e20ed714e/cf440/reflow4.png 148w,\n/static/9029df8aba03de13db17654e20ed714e/d2d38/reflow4.png 295w,\n/static/9029df8aba03de13db17654e20ed714e/b9e4f/reflow4.png 590w,\n/static/9029df8aba03de13db17654e20ed714e/f9b6a/reflow4.png 885w,\n/static/9029df8aba03de13db17654e20ed714e/3b243/reflow4.png 1024w\"\n          sizes=\"(max-width: 590px) 100vw, 590px\"\n          type=\"image/png\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n          src=\"/static/9029df8aba03de13db17654e20ed714e/b9e4f/reflow4.png\"\n          alt=\"reflow4\"\n          title=\"\"\n        />\n      </picture>\n  </span>\n  </a></p>\n<p>通过分析可以看到，在 JavaScript 步骤没有出现上面的 Recalculation Forced 和 Layout Forced。</p>\n<h5>减少 layout</h5>\n<p>如果我们在没有更改 dom 的几何属性（width，height，top，left，bottom，right 等），就不会触发 layout 步骤。当一个 dom 的 layout 被改变时，通常都会影响到其他关联的 dom 的 layout 也被改变。在设置动画时，能避免直接改变 dom 的 layout，就应该尽力避免。比如我们可以使用 transform 来位移元素，而不必直接改变它的 layout。还是上面的例子，同样的动画，我们改动 transform 来实现。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">transform</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> distance <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span>documentElement<span class=\"token punctuation\">.</span>offsetHeight <span class=\"token operator\">-</span> boll<span class=\"token punctuation\">.</span>offsetTop\n  <span class=\"token keyword\">let</span> dropDistance <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n\n  <span class=\"token function\">requestAnimationFrame</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token function\">drop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>dropDistance <span class=\"token operator\">></span> distance<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span>\n    <span class=\"token punctuation\">}</span>\n\n    boll<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>transform <span class=\"token operator\">=</span> <span class=\"token string\">\"translateY(\"</span> <span class=\"token operator\">+</span> dropDistance <span class=\"token operator\">+</span> <span class=\"token string\">\"px)\"</span>\n    dropDistance <span class=\"token operator\">=</span> dropDistance <span class=\"token operator\">+</span> <span class=\"token number\">2</span>\n    <span class=\"token function\">requestAnimationFrame</span><span class=\"token punctuation\">(</span>drop<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a82ed4d4f147936dedbfb0bb19f71c37/6c54f/relow5.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 15.544554455445544%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAvklEQVQI1z2O606DQBhEeXx9KxONmtQWNlpLF0grdLuN0gvsglyE46JJf0xm5vtxvvF0XpKfK9ThyGqdIOMNaeKzXT+SyWc+4gXhe4aYZ8SRZvmmEP6OMFRk+oDSX4jolXnocyprPNtA3UHVgvn+4WJbVHSHfLhlcX/DfjsjljnB7JM0NayEJnhycHnkZGsK2yE2S16SgMKBvLIesM34pwk6yXGpeshdmbwdwf2kGZwbQ28K2n68DuncvR/+8y8OM99duzdCpgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    ></span>\n    <picture>\n        <source\n          srcset=\"/static/a82ed4d4f147936dedbfb0bb19f71c37/cc182/relow5.webp 148w,\n/static/a82ed4d4f147936dedbfb0bb19f71c37/f7e40/relow5.webp 295w,\n/static/a82ed4d4f147936dedbfb0bb19f71c37/1a2f4/relow5.webp 590w,\n/static/a82ed4d4f147936dedbfb0bb19f71c37/4837b/relow5.webp 885w,\n/static/a82ed4d4f147936dedbfb0bb19f71c37/2f819/relow5.webp 1180w,\n/static/a82ed4d4f147936dedbfb0bb19f71c37/826cc/relow5.webp 2020w\"\n          sizes=\"(max-width: 590px) 100vw, 590px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/a82ed4d4f147936dedbfb0bb19f71c37/cf440/relow5.png 148w,\n/static/a82ed4d4f147936dedbfb0bb19f71c37/d2d38/relow5.png 295w,\n/static/a82ed4d4f147936dedbfb0bb19f71c37/b9e4f/relow5.png 590w,\n/static/a82ed4d4f147936dedbfb0bb19f71c37/f9b6a/relow5.png 885w,\n/static/a82ed4d4f147936dedbfb0bb19f71c37/2d849/relow5.png 1180w,\n/static/a82ed4d4f147936dedbfb0bb19f71c37/6c54f/relow5.png 2020w\"\n          sizes=\"(max-width: 590px) 100vw, 590px\"\n          type=\"image/png\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n          src=\"/static/a82ed4d4f147936dedbfb0bb19f71c37/b9e4f/relow5.png\"\n          alt=\"relow5\"\n          title=\"\"\n        />\n      </picture>\n  </span>\n  </a></p>\n<h4>Paint</h4>\n<h5>减少绘制区域</h5>\n<p>通常，对某一个 dom 的改变，都会触发该 dom 所在层的整个重新绘制。为了避免对整个层的重新绘制，我们可以通过把该 dom 提升到一个新的 composite layer，减少对原始层的绘制。</p>\n<p>未提升前，每一帧里都会有对整个 document 的绘制，对整个 document 的绘制会消耗 48us 左右</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3788eda4b7edcd32283ffcfb54546266/c1dfa/paint1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 17.73547094188377%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA5ElEQVQY012Py07CQBiFeVjXPpYPYNyYkBgTo4mKF0A7tk1A6AUYaGtnOm2V8jltdcPi/Gfx59wGMlHEm5RwnRBZ6OpA8lXiuoL5zCNY+HjuDOGE+N6K6esHvnD59BzE+wi13WGSzOqaTjsw39Ci/Om5sA9Vw1IMmVyc8HZ1yuT+mdFthjNW3Fw+Mp4+8CLuOL8+Iw4jVLCkKPe9YXtU2bv/s676gNwYnuSCvIE9YHNotKaa+yi5pZIZWRCQbyTaPjvDoj50dY+5RddYG1RR/4WBSnNMHGHs1CJJKdcrzC61un7dL8iSLIBWSaVLAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    ></span>\n    <picture>\n        <source\n          srcset=\"/static/3788eda4b7edcd32283ffcfb54546266/cc182/paint1.webp 148w,\n/static/3788eda4b7edcd32283ffcfb54546266/f7e40/paint1.webp 295w,\n/static/3788eda4b7edcd32283ffcfb54546266/1a2f4/paint1.webp 590w,\n/static/3788eda4b7edcd32283ffcfb54546266/4837b/paint1.webp 885w,\n/static/3788eda4b7edcd32283ffcfb54546266/2f819/paint1.webp 1180w,\n/static/3788eda4b7edcd32283ffcfb54546266/1f1b1/paint1.webp 1996w\"\n          sizes=\"(max-width: 590px) 100vw, 590px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/3788eda4b7edcd32283ffcfb54546266/cf440/paint1.png 148w,\n/static/3788eda4b7edcd32283ffcfb54546266/d2d38/paint1.png 295w,\n/static/3788eda4b7edcd32283ffcfb54546266/b9e4f/paint1.png 590w,\n/static/3788eda4b7edcd32283ffcfb54546266/f9b6a/paint1.png 885w,\n/static/3788eda4b7edcd32283ffcfb54546266/2d849/paint1.png 1180w,\n/static/3788eda4b7edcd32283ffcfb54546266/c1dfa/paint1.png 1996w\"\n          sizes=\"(max-width: 590px) 100vw, 590px\"\n          type=\"image/png\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n          src=\"/static/3788eda4b7edcd32283ffcfb54546266/b9e4f/paint1.png\"\n          alt=\"paint1\"\n          title=\"\"\n        />\n      </picture>\n  </span>\n  </a></p>\n<p>优化之后，我们通过<code class=\"language-text\">will-change: top</code>把小球提升到一个新的 composite layer 上，没有了对整个 document 的绘制，节省了 48us。</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/47fa66642ff84f154c9db7bdea08d730/5b9b6/paint2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 20.572640509013787%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA8ElEQVQY0z2Oy06DYBBGeWN3Po6P4NZEY+LC2AVKiiXlVmhpASGklPulhR5/qHFxFl++mTMjhUlBcqpwdj5LdYW2fCfYaviuiucaaN8+lhnOmGYg+j2ebvDjOGxNDVV5Izh41GeouhGp6qERoWxH8uqM8/mA/HyH/HrPYbPga5GgaynWOkc3MuQXm1BRiLIM1Vzx9PGIv9/QXG4OqWhGYb7OTOLpgHtMMZKYXAwNQD8xCkQYihOdv6OIIqoopo+PNGU3700OqWiv/8Lp5YlOiNpe5HagFAdL0ZX1hdqxqW2DxlrThAF1XglpRJ1mf8KRX2F+KfVzKKZwAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    ></span>\n    <picture>\n        <source\n          srcset=\"/static/47fa66642ff84f154c9db7bdea08d730/cc182/paint2.webp 148w,\n/static/47fa66642ff84f154c9db7bdea08d730/f7e40/paint2.webp 295w,\n/static/47fa66642ff84f154c9db7bdea08d730/1a2f4/paint2.webp 590w,\n/static/47fa66642ff84f154c9db7bdea08d730/4837b/paint2.webp 885w,\n/static/47fa66642ff84f154c9db7bdea08d730/2f819/paint2.webp 1180w,\n/static/47fa66642ff84f154c9db7bdea08d730/5a8f5/paint2.webp 1886w\"\n          sizes=\"(max-width: 590px) 100vw, 590px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/47fa66642ff84f154c9db7bdea08d730/cf440/paint2.png 148w,\n/static/47fa66642ff84f154c9db7bdea08d730/d2d38/paint2.png 295w,\n/static/47fa66642ff84f154c9db7bdea08d730/b9e4f/paint2.png 590w,\n/static/47fa66642ff84f154c9db7bdea08d730/f9b6a/paint2.png 885w,\n/static/47fa66642ff84f154c9db7bdea08d730/2d849/paint2.png 1180w,\n/static/47fa66642ff84f154c9db7bdea08d730/5b9b6/paint2.png 1886w\"\n          sizes=\"(max-width: 590px) 100vw, 590px\"\n          type=\"image/png\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n          src=\"/static/47fa66642ff84f154c9db7bdea08d730/b9e4f/paint2.png\"\n          alt=\"paint2\"\n          title=\"\"\n        />\n      </picture>\n  </span>\n  </a></p>\n<h5>使用 transform 和 opacity</h5>\n<p>即使在同一层上，我们对某一个 dom 使用 transform 或者 opacity 来实现动画，也不会每帧都触发对整个 layer 的绘制，它只会对当前改变的 dom 的绘制和适当减少对整个 layer 的绘制次数。这个特性其实是浏览器的自身优化策略，transform 和 opacity 被视为合成器属性，它们在默认情况下都会生成新的 paint layer。相比上面的优化方式，使用合成器属性，实现了同样的优化效果，但是可以减少增加 composite layer，每创建一个 composite layer 也是会有性能开销的。</p>\n<p>我们不必直接改变 dom 的 top 或者 width 等几何属性，而是使用 transform 的 translate，scale 等来实现同样的效果，既可以减少绘制区域，也可以避免 layout。</p>\n<h5>减少绘制的复杂度</h5>\n<p>不同的绘制效果，消耗的时间也是不同的。通常越复杂的效果，消耗的资源和花费的时间越多，比如阴影，渐变，圆角等，就属于比较复杂的样式。这些样式效果，通常都是设计师设计出来的，我们没有理由直接否定。但是，我们可以根据不同设备来做一些不同的降级处理，比如较低设备上，就只用纯色来代替渐变，去掉阴影效果等。通过降级处理，保证了页面功能不受影响，也提高了页面的性能。</p>\n<h4>Composite</h4>\n<p>处理完了上面这些步骤，终于来到了 Composite 步骤。dom 通过适当条件触发，会提升为新的 composite layer，在 paint 阶段是发生在多个 layer 上的，最后浏览器通过合并多个 layer，根据它们的顺序来正确的显示在屏幕上。composite layer 提升触发条件非常多，这里我只列举几个常见的条件：</p>\n<ol>\n<li>3D 相关的 css 样式</li>\n<li>will-change 设置为 opacity，transform，top，left，bottom，right</li>\n<li>fixed（在高的 DPI 上会默认提升，在低 DPI 上不会）</li>\n<li>Hardware-accelerated video element</li>\n<li>Hardware-accelerated 2D canvas</li>\n<li>3D WebGL</li>\n<li>Overlay（比如 A 覆盖在 B 上，而 B 是提升的 composite layer，则 A 也会提升到新的 composite layer）</li>\n</ol>\n<p>composite layer 有自己的 graphic context，所以在渲染的时候，速度非常快，它是直接在 GPU 上完成的，不需要通过 CPU 处理。但是每新增一个 composite layer 都会消耗额外的内存，也不能盲目的将元素提升为新的 composite layer。</p>\n<p>除了有 Composite layer，还有一种 paint layer。paint layer 是在<a href=\"https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Positioning/Understanding_z_index/The_stacking_context\">stacking context</a>上的，例如我们在使用<code class=\"language-text\">z-index</code>时就会生成新的 paint layer，在帧处理步骤中，其实还有一步 Update Layer Tree 就是用来更新 paint player 的。</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/02c0d337b443e9708470b626b74bc1f6/3b243/paintlayer.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 18.5546875%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsSAAALEgHS3X78AAAA8klEQVQY0y2P606DQBBGeXOfxycw+qNeotWmplptDTZK2lDuXWBhCywIx6Xpj8mZ5JuZnLF+NjZ7d4fjuPieIEkkYZgjDhLhR0S7gNSLEemBUCRkskBKRZJmuFFALFJ0N9C0Pe0fWMvbC5z1Da8zj9mDy2oZMp8GOF8R9sLhcbLl43nF/HPK5O2ebeCbozXvv1sun+54+d5QaSjrnlIPWIv92jQduofGVNWdacImzdFJjIpDylRSygpVNhz1ec4YVS2oZjAFw2AMVaHoTNAYX931J/WReqQ60uYZrWFXFLQyP1GPAubNcWbcG/eLuuLavuIfwwcszUvVRekAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    ></span>\n    <picture>\n        <source\n          srcset=\"/static/02c0d337b443e9708470b626b74bc1f6/cc182/paintlayer.webp 148w,\n/static/02c0d337b443e9708470b626b74bc1f6/f7e40/paintlayer.webp 295w,\n/static/02c0d337b443e9708470b626b74bc1f6/1a2f4/paintlayer.webp 590w,\n/static/02c0d337b443e9708470b626b74bc1f6/4837b/paintlayer.webp 885w,\n/static/02c0d337b443e9708470b626b74bc1f6/86447/paintlayer.webp 1024w\"\n          sizes=\"(max-width: 590px) 100vw, 590px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/02c0d337b443e9708470b626b74bc1f6/cf440/paintlayer.png 148w,\n/static/02c0d337b443e9708470b626b74bc1f6/d2d38/paintlayer.png 295w,\n/static/02c0d337b443e9708470b626b74bc1f6/b9e4f/paintlayer.png 590w,\n/static/02c0d337b443e9708470b626b74bc1f6/f9b6a/paintlayer.png 885w,\n/static/02c0d337b443e9708470b626b74bc1f6/3b243/paintlayer.png 1024w\"\n          sizes=\"(max-width: 590px) 100vw, 590px\"\n          type=\"image/png\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n          src=\"/static/02c0d337b443e9708470b626b74bc1f6/b9e4f/paintlayer.png\"\n          alt=\"paintlayer\"\n          title=\"\"\n        />\n      </picture>\n  </span>\n  </a></p>\n<p>每个 dom node 都会有对应的 layout object。如果 layout object 在同一个坐标系空间中，就会在同一个 paint layer 上。在某些条件下，比如 z-index，absolute 等会生成新的 paint layer。默认情况下，paint layer 都共享同一个 composite layer，但是在某些条件下，比如 animation，will-change 等会把当前 paint layer 提升为新的 composite layer，从而加速渲染。</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/205a3f53b768b339fe67b9ad0da41bf5/34e8a/composite1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 39.166666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAPoAAAD6AG1e1JrAAABrElEQVQY041QPU/bUBT12qV/gLEzQ9U/wFCp6lCJsUu7VBVSp6qMZSsDEyosLK1SKQL1QypVkJECQsSAlAAuJMJpIkIgjoMCqe04fvb78PO7j2f4A9zp3HPu0T33avIelQJgniZC3LWU0iiKGGMaAKh+z9nUz35gFkuQQgjOkdN62ao9RmFZqe82Kg8Wf79Y3eUpJ5QZJeNbLmeapgYyM385+PxpaxrREASkqRAgzhsfa+XnODpWqtHpzZUO9eaFwgIgCAK7YyOEtCH1mlcWoURyyVmiZBBo5Ou+t5twoEzeMgIS5vhBte/6agZAJVe8ljtaeL36zBleXI66U2uTv+rfsb9f2dTqB48S2moeP22fTDDcjol4ki9qs/n321mWKMaZmSXMDzyFYoYqttHx2gqHIxtjl9H/Z9Zbp/FG0K56Vn3g79lXvTBWUcjd5p/W1w8br87d0yxedpHkyfV1b3E4yKusirRcOrNzMm820O1RhBDLsqrVahxj7XRQL7WKIQmUlSaYCxkOy3+Nh//McUJdNb1Sa44t/ZlYLrYHHsG427tc1/VCodDv928AzBOjCAbr88QAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    ></span>\n    <picture>\n        <source\n          srcset=\"/static/205a3f53b768b339fe67b9ad0da41bf5/cc182/composite1.webp 148w,\n/static/205a3f53b768b339fe67b9ad0da41bf5/f7e40/composite1.webp 295w,\n/static/205a3f53b768b339fe67b9ad0da41bf5/1a2f4/composite1.webp 590w,\n/static/205a3f53b768b339fe67b9ad0da41bf5/965c5/composite1.webp 600w\"\n          sizes=\"(max-width: 590px) 100vw, 590px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/205a3f53b768b339fe67b9ad0da41bf5/cf440/composite1.png 148w,\n/static/205a3f53b768b339fe67b9ad0da41bf5/d2d38/composite1.png 295w,\n/static/205a3f53b768b339fe67b9ad0da41bf5/b9e4f/composite1.png 590w,\n/static/205a3f53b768b339fe67b9ad0da41bf5/34e8a/composite1.png 600w\"\n          sizes=\"(max-width: 590px) 100vw, 590px\"\n          type=\"image/png\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n          src=\"/static/205a3f53b768b339fe67b9ad0da41bf5/b9e4f/composite1.png\"\n          alt=\"composite1\"\n          title=\"\"\n        />\n      </picture>\n  </span>\n  </a></p>\n<p>现在，一帧的任务都处理完了，是不是就结束了呢？</p>\n<h4>requestIdleCallback</h4>\n<p>如果一帧的处理时间少于 16.7ms，多余出来的时间，浏览器会执行<code class=\"language-text\">requestIdleCallback</code>的任务。这个 API 目前还处在不稳定阶段，某些浏览器还未实现它。我们在使用的时候，一定要加上兼容性检测。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"requestIdleCallback\"</span> <span class=\"token keyword\">in</span> window<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Use requestIdleCallback to schedule work.</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Do what you’d do today.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c96335aab7d518af1e83f097f947b918/c2b5a/ric2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 43.17718940936864%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAABL0lEQVQoz61STU/CQBTsn/dCDBdPGP+CVw96MU0gJQqoGGmBAuJHTW27LdCmtLs77rbUFmk4Ocnk7dvMm31vd5UkSZCDg3OOKopcxjpKpGmasdApruscLTow2bEwJMSD7/ulYS7c7+bvAftdH7JapzDGqnLUgdE1HKsL8t0H346ARBc0xLwj0NgUZuz3NGVqh2iPHQyWKww/Q2hTFw9vK3TEnjZxoBoE+nwCX23Avm6A3J5iozVFbMK7OUFkXGJohejPPCSUQVk4Ee5MD88fa+hfER6XAV6sDXpzD/emi64ZYPa+QNQ7B2m3EGgthIML+B2Rq2eIzCvodoSnV4JUGnJGy3Gz1otYvQkqdmOxkD9iK9bbLMqcsrjUy5GpcE0pBa1humOesyPMNdkr45/xAygTt1hVypM6AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    ></span>\n    <picture>\n        <source\n          srcset=\"/static/c96335aab7d518af1e83f097f947b918/cc182/ric2.webp 148w,\n/static/c96335aab7d518af1e83f097f947b918/f7e40/ric2.webp 295w,\n/static/c96335aab7d518af1e83f097f947b918/1a2f4/ric2.webp 590w,\n/static/c96335aab7d518af1e83f097f947b918/4837b/ric2.webp 885w,\n/static/c96335aab7d518af1e83f097f947b918/d17bc/ric2.webp 982w\"\n          sizes=\"(max-width: 590px) 100vw, 590px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/c96335aab7d518af1e83f097f947b918/cf440/ric2.png 148w,\n/static/c96335aab7d518af1e83f097f947b918/d2d38/ric2.png 295w,\n/static/c96335aab7d518af1e83f097f947b918/b9e4f/ric2.png 590w,\n/static/c96335aab7d518af1e83f097f947b918/f9b6a/ric2.png 885w,\n/static/c96335aab7d518af1e83f097f947b918/c2b5a/ric2.png 982w\"\n          sizes=\"(max-width: 590px) 100vw, 590px\"\n          type=\"image/png\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n          src=\"/static/c96335aab7d518af1e83f097f947b918/b9e4f/ric2.png\"\n          alt=\"ric2\"\n          title=\"\"\n        />\n      </picture>\n  </span>\n  </a></p>\n<h5>一定不能在 requestIdleCallback 里更改 dom 样式</h5>\n<p>rIC 阶段，frame 的样式布局等都己经 commit 了，所以不能在 rIC 里直接改变 dom 的布局或者样式。如果改变了，会导致样式布局计算失效，在下一帧就会触发 forced layout 等。例如下面这个例子，我们直接在 rIC 里改了小球的位置。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"requestIdleCallback\"</span> <span class=\"token keyword\">in</span> window<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">requestIdleCallback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> left <span class=\"token operator\">=</span> boll<span class=\"token punctuation\">.</span>offsetLeft\n    <span class=\"token comment\">// 这里，我们直接改了boll的位置</span>\n    boll<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>left <span class=\"token operator\">=</span> left <span class=\"token operator\">+</span> <span class=\"token number\">2</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"px\"</span>\n    <span class=\"token function\">moveLeftWithBadRic</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>然后，打开 chrome 调试一下，就会发现问题，在下一帧的开头就会触发了 layout，这是我们不希望的。</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/cedcc45a7d30dd246a9614480089b242/3b243/ric3.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 25.78125%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsSAAALEgHS3X78AAABLElEQVQY0y2Py07CUBRF+9U4MtFPMXFqdGCcGY3GqAhBhKAEKX1T2tv2tvSW8pDlLTpYOc+9c45huSazwCSQnsbHT90/Mg9H2HiJgyscpsE3bmLrvoun502/2fP+cXXdRMN05tiuixNoA88miBcEIiRZSqQqkcslWZESJylRmiOynFimpEVOJBNEnpHm8rAnC4mxkFuKcoM3Txh3L+lcHPF63mJ8fYxze4r1cELYO2P0PuXpWdB9CWh/9vEjwV3/ns5kgNm74u2mhTNpY0T5lmoDq23DhsXXgI/HIeZwhm9NGPttROixyhWl2qHKNUoLqvWeUqO0VulPrGhEXm8w4sawGa526EOps4KtUqxVjZIlRSxZhguqWFCJhCoMD7kqKtRam9U/h7hqjOs9v9+vcYV8c/vOAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    ></span>\n    <picture>\n        <source\n          srcset=\"/static/cedcc45a7d30dd246a9614480089b242/cc182/ric3.webp 148w,\n/static/cedcc45a7d30dd246a9614480089b242/f7e40/ric3.webp 295w,\n/static/cedcc45a7d30dd246a9614480089b242/1a2f4/ric3.webp 590w,\n/static/cedcc45a7d30dd246a9614480089b242/4837b/ric3.webp 885w,\n/static/cedcc45a7d30dd246a9614480089b242/86447/ric3.webp 1024w\"\n          sizes=\"(max-width: 590px) 100vw, 590px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/cedcc45a7d30dd246a9614480089b242/cf440/ric3.png 148w,\n/static/cedcc45a7d30dd246a9614480089b242/d2d38/ric3.png 295w,\n/static/cedcc45a7d30dd246a9614480089b242/b9e4f/ric3.png 590w,\n/static/cedcc45a7d30dd246a9614480089b242/f9b6a/ric3.png 885w,\n/static/cedcc45a7d30dd246a9614480089b242/3b243/ric3.png 1024w\"\n          sizes=\"(max-width: 590px) 100vw, 590px\"\n          type=\"image/png\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n          src=\"/static/cedcc45a7d30dd246a9614480089b242/b9e4f/ric3.png\"\n          alt=\"ric3\"\n          title=\"\"\n        />\n      </picture>\n  </span>\n  </a></p>\n<p>更好的方式就是，我们可以在 rIC 里计算好样式，然后在 rAF 里去更新样式。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"requestIdleCallback\"</span> <span class=\"token keyword\">in</span> window<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">requestIdleCallback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> left <span class=\"token operator\">=</span> boll<span class=\"token punctuation\">.</span>offsetLeft <span class=\"token operator\">+</span> <span class=\"token number\">2</span>\n    <span class=\"token keyword\">const</span> top <span class=\"token operator\">=</span> boll<span class=\"token punctuation\">.</span>offsetTop <span class=\"token operator\">+</span> <span class=\"token number\">2</span>\n    <span class=\"token comment\">// 在rAF里更新位置</span>\n    <span class=\"token function\">requestAnimationFrame</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      boll<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>left <span class=\"token operator\">=</span> left <span class=\"token operator\">+</span> <span class=\"token string\">\"px\"</span>\n      boll<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>top <span class=\"token operator\">=</span> top <span class=\"token operator\">+</span> <span class=\"token string\">\"px\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token function\">moveLeftWithGoodRic</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>优化之后，我们再调试一下，发现，帧开头没有了 layout，这是我们想要的结果。</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0037042c36d33f01701be4f48ae6d6e1/b938d/ric4.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 19.072708113804005%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsSAAALEgHS3X78AAAA5UlEQVQY003O3U6DQBCGYW7YeANegtfTg9bEWI1NNBJb2lIrIGwRgvw1FCig8LrQmnjwZHa/2ZmsEkQpW+MDbblEX2ts9JW0wLI8LNPHcb6kANPwsYWHKWz8IOLdsbBcwc51EcLh092RpHuUw7ElySqiJOHt/prV+BJ3M+Jl5vN4K9DUCO014GHsomoG0/WUMM25mU+402d4tspidMF8ckUS+yh51VE2UH5LZUGUeWRNR90yqH5O6u5cpf59fc4bOWeHW5785yEfFp60EhQy7O/9z3v5sRv8nYf6r1/UsD9UxHE45L9bSSleLjjw0wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    ></span>\n    <picture>\n        <source\n          srcset=\"/static/0037042c36d33f01701be4f48ae6d6e1/cc182/ric4.webp 148w,\n/static/0037042c36d33f01701be4f48ae6d6e1/f7e40/ric4.webp 295w,\n/static/0037042c36d33f01701be4f48ae6d6e1/1a2f4/ric4.webp 590w,\n/static/0037042c36d33f01701be4f48ae6d6e1/4837b/ric4.webp 885w,\n/static/0037042c36d33f01701be4f48ae6d6e1/dc5dc/ric4.webp 949w\"\n          sizes=\"(max-width: 590px) 100vw, 590px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/0037042c36d33f01701be4f48ae6d6e1/cf440/ric4.png 148w,\n/static/0037042c36d33f01701be4f48ae6d6e1/d2d38/ric4.png 295w,\n/static/0037042c36d33f01701be4f48ae6d6e1/b9e4f/ric4.png 590w,\n/static/0037042c36d33f01701be4f48ae6d6e1/f9b6a/ric4.png 885w,\n/static/0037042c36d33f01701be4f48ae6d6e1/b938d/ric4.png 949w\"\n          sizes=\"(max-width: 590px) 100vw, 590px\"\n          type=\"image/png\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n          src=\"/static/0037042c36d33f01701be4f48ae6d6e1/b9e4f/ric4.png\"\n          alt=\"ric4\"\n          title=\"\"\n        />\n      </picture>\n  </span>\n  </a></p>\n<h5>其他最佳实践</h5>\n<ul>\n<li>\n<p>rIC 里，可用时间是非常有限的，不能一次执行长时间任务。可根据参数 deadline.timeRemaing()来判断当前可用时间，如果时间到了，必须要结束，或者放在下一个 rIC 里执行</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">myNonEssentialWork</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">deadline</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token comment\">// Use any remaining time, or, if timed out, just run through the tasks.</span>\n<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>\n  <span class=\"token punctuation\">(</span>deadline<span class=\"token punctuation\">.</span><span class=\"token function\">timeRemaining</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> deadline<span class=\"token punctuation\">.</span>didTimeout<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span>\n  tasks<span class=\"token punctuation\">.</span>length <span class=\"token operator\">></span> <span class=\"token number\">0</span>\n<span class=\"token punctuation\">)</span>\n  <span class=\"token function\">doWorkIfNeeded</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>tasks<span class=\"token punctuation\">.</span>length <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token function\">requestIdleCallback</span><span class=\"token punctuation\">(</span>myNonEssentialWork<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n<li>\n<p>rIC 不能保证一定会执行。所以一般放在 rIC 里的任务是无关核心逻辑或用户体验的，一般比如数据上报或者预处理数据。可用传入 timeout 参数，保证任务一定会执行。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// Wait at most two seconds before processing events.</span>\n<span class=\"token function\">requestIdleCallback</span><span class=\"token punctuation\">(</span>processPendingAnalyticsEvents<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> timeout<span class=\"token punctuation\">:</span> <span class=\"token number\">2000</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n</li>\n</ul>\n<h4>小结</h4>\n<p>通过完整的学习一帧的绘制过程，然后针对每个过程，我们都采取一些优化手段，那么整个动画都将表现的非常流畅。最好，用一张图来作为结尾吧。</p>\n<p><a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d7823a0471f95a803a66fe7dd58a90ee/15f59/ric5.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 44.803229061553985%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAABjklEQVQoz52Sy2sUQRCH5/8/eclBDyIePAjBFySuUePFgOgSIQur2YgPwm428+jXvLtnvtR0FCUXxYaPorurqqt+1UkIAe89dd1QVzXjOP4TN9ev8yTLMrI0Q5kcV2mGYYgP+OkhIXjhD+uDj9Y1mqq1dH2Lq7XEhBibpFmK1RXvljOOFvu0dcBaR+mE8iYlzpXi0/P8/X0OP+5ydr7gxfwBqlA0TUOyXq+ZmBIX+YUkKiRQU9gKrV3E/LTaGJTN0YJSitX3Y+af9jA2w8hd17Ukm81GkuVYk3Hx5SGXp/c4Wz7m7oeCp7MVL58seLX/mdmjJXsHBzyb77D79hbHqyPMds7m9A5qfUih9HWFUZ+I6NZbfJPTmkupsMXkDpsaXCGtyn5q19Y5pspoukp0bRh60b13eKluHCcN0zSWf510JAxEK96MwyR0EMcQneMk5X5iEMcgtB5UFUhNJQOTKW+3W/JcWrY26vB3dERrQ1MaTn4odl5/4/abr5wX9e+W41f5D5rOY2TqVujl61wBJo6sy3YRHmwAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    ></span>\n    <picture>\n        <source\n          srcset=\"/static/d7823a0471f95a803a66fe7dd58a90ee/cc182/ric5.webp 148w,\n/static/d7823a0471f95a803a66fe7dd58a90ee/f7e40/ric5.webp 295w,\n/static/d7823a0471f95a803a66fe7dd58a90ee/1a2f4/ric5.webp 590w,\n/static/d7823a0471f95a803a66fe7dd58a90ee/4837b/ric5.webp 885w,\n/static/d7823a0471f95a803a66fe7dd58a90ee/2ada9/ric5.webp 991w\"\n          sizes=\"(max-width: 590px) 100vw, 590px\"\n          type=\"image/webp\"\n        />\n        <source\n          srcset=\"/static/d7823a0471f95a803a66fe7dd58a90ee/cf440/ric5.png 148w,\n/static/d7823a0471f95a803a66fe7dd58a90ee/d2d38/ric5.png 295w,\n/static/d7823a0471f95a803a66fe7dd58a90ee/b9e4f/ric5.png 590w,\n/static/d7823a0471f95a803a66fe7dd58a90ee/f9b6a/ric5.png 885w,\n/static/d7823a0471f95a803a66fe7dd58a90ee/15f59/ric5.png 991w\"\n          sizes=\"(max-width: 590px) 100vw, 590px\"\n          type=\"image/png\"\n        />\n        <img\n          class=\"gatsby-resp-image-image\"\n          style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n          src=\"/static/d7823a0471f95a803a66fe7dd58a90ee/b9e4f/ric5.png\"\n          alt=\"ric5\"\n          title=\"\"\n        />\n      </picture>\n  </span>\n  </a>\nÎ</p>\n<h4>参考</h4>\n<ul>\n<li><a href=\"https://developers.google.com/web/fundamentals/performance/rendering/\">渲染性能</a></li>\n<li><a href=\"https://www.alibabacloud.com/blog/front-end-performance-optimization-with-accelerated-compositing-part-1_594194\">Front-End Performance Optimization with Accelerated Compositing Part 1</a></li>\n<li><a href=\"https://aerotwist.com/blog/the-anatomy-of-a-frame/\">The Anatomy of a Frame</a></li>\n</ul>","frontmatter":{"title":"深入浅出动画帧","date":"May 27, 2019","tags":["animation","frame"]}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/post/in_depth_animation_frame/","previous":{"fields":{"slug":"/post/algorithm_basic_data_structure/"},"frontmatter":{"title":"数据结构和算法-基础数据结构"}},"next":null}}